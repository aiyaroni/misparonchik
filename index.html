<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¡×¤×¨×•× ×¦'×™×§ - ××©×—×§ ×—×©×‘×•×Ÿ ×œ×™××•×“×™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');
    body{font-family:'Assistant',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .ltr{direction:ltr;unicode-bidi:embed;display:inline-block}
    .tabular-nums{font-variant-numeric:tabular-nums}
    .owl-blink{animation:blink 2s infinite}
    @keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.1)}}

    .no-focus-outline:focus{outline:none !important; box-shadow:none !important}

    .link-cta{
      display:inline-flex; align-items:center; justify-content:center; gap:.35rem;
      margin:.5rem auto 1rem;
      font-weight:800;
      font-size: calc(1rem + 2px);
      color:#111827;
      text-decoration:underline;
      cursor:pointer;
      background:transparent; border:none; padding:.25rem .5rem; border-radius:.5rem;
    }
    .link-cta:focus{outline:2px solid #93c5fd; outline-offset:2px}

    .subhead{
      font-weight:800;
      font-size:clamp(1.375rem, 1.05rem + 1.2vw, 1.75rem);
      line-height:1.25;
      color:#1f2937;
      letter-spacing:-.01em;
    }

    .answer-item{position:relative;transition:transform .14s,box-shadow .14s,border-color .14s;cursor:pointer;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;background:rgba(255,255,255,.96);border-radius:1rem;border:2px solid transparent;outline:none}
    .answer-item::before{content:"";position:absolute;inset:0;border-radius:inherit;pointer-events:none;background:var(--tint,transparent);opacity:.08}
    .answer-item .accent{display:none;position:absolute;right:0;top:0;bottom:0;width:8px;border-radius:0 1rem 1rem 0;opacity:.55;background:var(--tint);pointer-events:none}
    .answer-item[data-idx="0"]{--tint:#f87171}
    .answer-item[data-idx="1"]{--tint:#60a5fa}
    .answer-item[data-idx="2"]{--tint:#4ade80}
    .answer-item[data-idx="3"]{--tint:#facc15}
    .answer-item:active{transform:scale(.98)}
    .answer-item.selected{border-color:#2563eb;box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .answer-item.selected .accent{display:block}

    .confirm-button{transition:all .25s}
    .confirm-button[disabled]{opacity:.5;cursor:not-allowed}

    .choice-card{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.25rem;
      background:rgba(255,255,255,.96); border:2px solid transparent; border-radius:1.25rem; padding:1.15rem;
      box-shadow:0 10px 26px rgba(0,0,0,.12); transition:.18s; cursor:pointer; outline:none; user-select:none}
    .choice-card .accent{display:none;position:absolute;right:0;top:0;bottom:0;width:8px;border-radius:0 1.25rem 1.25rem 0;opacity:.55;pointer-events:none}
    .choice-card[data-tint="green"]{--tint:#22c55e}
    .choice-card[data-tint="blue"]{--tint:#3b82f6}
    .choice-card[data-tint="purple"]{--tint:#a855f7}
    .choice-card[data-tint="orange"]{--tint:#f59e0b}
    .choice-card[data-tint="pink"]{--tint:#ec4899}
    .choice-card:hover{transform:translateY(-2px)}
    .choice-card:active{transform:scale(.98)}
    .choice-card.selected{border-color:#2563eb; box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .choice-card.selected .accent{display:block; background:var(--tint,#3b82f6)}
    .choice-card .emoji{font-size:2rem}
    .op-btn .emoji{font-size:1.8rem}
    .op-btn .text-xl{font-size:1.1rem}

    .chips{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center}
    .chip{min-width:68px; min-height:52px; display:inline-flex; align-items:center; justify-content:center;
      border:2px solid #e5e7eb; background:white; border-radius:1rem; padding:.3rem .8rem;
      font-weight:800; font-size:1.25rem; cursor:pointer; transition:.16s}
    .chip:hover{transform:translateY(-2px)}
    .chip.selected{border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.20)}

    #floatingControls{
      position:fixed; left:16px; top:16px; z-index:50;
      display:flex; flex-direction:column; gap:10px;
    }
    #audioToggle,#profileBtn{padding:.5rem .7rem;border-radius:9999px;background:rgba(255,255,255,.95);border:1px solid #e5e7eb;box-shadow:0 6px 20px rgba(0,0,0,.12)}
    #audioToggle[aria-pressed="true"] .muted{display:inline}
    #audioToggle[aria-pressed="true"] .unmuted{display:none}
    #audioToggle[aria-pressed="false"] .muted{display:none}
    #audioToggle[aria-pressed="false"] .unmuted{display:inline}

    .btn-disabled{opacity:.5; cursor:not-allowed}

    .site-signature{ text-align:center;color:#6b7280;font-size:.875rem;line-height:1.6; margin-top:1.25rem;margin-bottom:1.25rem }
    @media (min-width:640px){ .site-signature{font-size:1rem;margin-top:2rem;margin-bottom:2rem} }
    .site-signature a{color:#4b5563;text-decoration:underline}
    .site-signature a:hover{color:#111827}

    #curriculumWrapper{position:relative}
    .curriculum-collapsed{max-height:min(45vh, 360px); overflow:hidden;}
    #curriculumFade{
      position:absolute; inset-inline:0; bottom:0; height:64px;
      background:linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,0));
      pointer-events:none;
    }

    @media (prefers-reduced-motion: reduce){ .owl-blink{ animation:none } }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-50 to-green-100 min-h-screen">

  <!-- Floating controls -->
  <div id="floatingControls" aria-label="×‘×§×¨×•×ª ××”×™×¨×•×ª">
    <button id="audioToggle" type="button" aria-label="×”×—×œ×¤×ª ××¦×‘ ×¦×œ×™×œ" aria-pressed="false" title="×”×¦×œ×™×œ ×¤×¢×™×œ">
      <span class="unmuted" aria-hidden="true">ğŸ”Š</span>
      <span class="muted" aria-hidden="true">ğŸ”‡</span>
    </button>
    <button id="profileBtn" type="button" aria-label="××–×•×¨ ××™×©×™" title="××–×•×¨ ××™×©×™">ğŸ‘¤</button>
  </div>

  <!-- Welcome Screen -->
  <div id="welcomeScreen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-6xl mb-4 owl-blink">ğŸ¦‰</div>
      <h1 id="welcomeTitle" tabindex="-1" class="no-focus-outline text-4xl font-bold text-purple-600 mb-4">××¡×¤×¨×•× ×¦'×™×§</h1>
      <p class="text-2xl text-gray-700 mb-8">×‘×•××• ×œ×œ××•×“ ×—×©×‘×•×Ÿ ×¢× ×©×•×¤×™ ×”×™× ×©×•×£</p>
      <button type="button" id="startBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××©×—×§</button>
    </div>
    <footer class="site-signature px-4">
      <div>Â© 2025 yaroni studio - ×ª×•×›×Ÿ ×—×–×§, ×¢×•×‘×“ ×—×›× ×•××‘×•×¡×¡ ×¢×œ ×‘×™× ×”</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Name Screen -->
  <div id="nameScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <form id="nameForm" class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-5xl mb-4">ğŸ‘‹</div>
      <h2 id="nameTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-blue-600 mb-2">××™×š ×§×•×¨××™× ×œ×š?</h2>
      <p id="nameSubtitle" class="text-gray-600 mb-4 hidden"></p>
      <input type="text" id="playerName" name="playerName" required placeholder="×”×›× ×¡ ××ª ×©××š ×›××Ÿ" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-3 text-center focus:border-blue-500 focus:outline-none">
      <div class="text-center mb-6">
        <button type="button" id="profileOrSwitchBtn" class="link-cta">×”×—×œ×£ ××©×ª××© / ××–×•×¨ ××™×©×™</button>
      </div>
      <button type="submit" class="bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-blue-600 hover:to-green-600 transform hover:scale-105 transition-all duration-200 shadow-lg">×”××©×š</button>
    </form>
  </div>

  <!-- User Picker Modal -->
  <div id="userPickerModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
    <div role="dialog" aria-modal="true" class="bg-white rounded-2xl max-w-md w-full p-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-3">×‘×—×¨×• ××©×ª××©</h3>
      <div id="userList" class="space-y-2 max-h-[50vh] overflow-auto mb-4"></div>
      <div class="flex gap-2 justify-between">
        <button id="userPickerCancel" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold">×¡×’×•×¨</button>
        <button id="newUserBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">××©×ª××© ×—×“×©</button>
      </div>
    </div>
  </div>

  <!-- Curriculum Selection -->
  <div id="curriculumScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-3xl w-full">
      <div class="text-5xl mb-4">ğŸ“š</div>
      <h2 id="curriculumTitle" tabindex="-1" class="no-focus-outline text-3xl md:text-4xl font-extrabold text-green-600 mb-2 leading-tight">×™×© ×œ×‘×—×•×¨ ×ª×›× ×™×ª ×œ×™××•×“</h2>
      <p class="subhead mb-6">×‘×—×¨×• ××ª ×”×ª×›× ×™×ª ×”××ª××™××”, ×•××– ×œ×—×¦×• ×¢×œ "×”××©×š"</p>

      <div id="curriculumWrapper" class="relative mb-6">
        <div id="curriculumGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 curriculum-collapsed">
          <button type="button" class="choice-card" data-tint="blue" data-value="none" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">ğŸ¯</div>
            <div class="text-xl font-bold text-gray-800">×œ×œ× ×ª×•×›× ×™×ª</div>
            <div class="text-base text-gray-500">×‘×—×™×¨×” ×—×•×¤×©×™×ª</div>
          </button>

          <button type="button" class="choice-card" data-tint="green" data-value="il_g1_s1" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">ğŸŒ±</div>
            <div class="text-xl font-bold text-gray-800">×›×™×ª×” ××³, ××—×¦×™×ª ××³</div>
            <div class="text-base text-gray-500">×¢×“ 10</div>
          </button>

          <button type="button" class="choice-card" data-tint="green" data-value="il_g1_s2" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">ğŸŒ¿</div>
            <div class="text-xl font-bold text-gray-800">×›×™×ª×” ××³, ××—×¦×™×ª ×‘×³</div>
            <div class="text-base text-gray-500">×¢×“ 20</div>
          </button>

          <button type="button" class="choice-card" data-tint="green" data-value="il_g1_adv" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">âœ¨</div>
            <div class="text-xl font-bold text-gray-800">×›×™×ª×” ××³, ××ª×’×¨</div>
            <div class="text-base text-gray-500">×¢×“ 30</div>
          </button>

          <button type="button" class="choice-card" data-tint="blue" data-value="il_g2" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">ğŸ§©</div>
            <div class="text-xl font-bold text-gray-800">×›×™×ª×” ×‘×³</div>
            <div class="text-base text-gray-500">×¢×“ 100</div>
          </button>

          <button type="button" class="choice-card" data-tint="purple" data-value="il_g3" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">âœ–ï¸</div>
            <div class="text-xl font-bold text-gray-800">×›×™×ª×” ×’×³</div>
            <div class="text-base text-gray-500">×¢×“ 100; ×›×¤×œ/×—×™×œ×•×§ 10Ã—10</div>
          </button>

          <button type="button" class="choice-card" data-tint="orange" data-value="il_g4" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">ğŸš€</div>
            <div class="text-xl font-bold text-gray-800">×›×™×ª×” ×“×³</div>
            <div class="text-base text-gray-500">×¢×“ 1000; ×›×¤×œ/×—×™×œ×•×§ 12Ã—12</div>
          </button>
        </div>
        <div id="curriculumFade" class="hidden"></div>
      </div>

      <div class="flex items-center justify-center gap-3 flex-wrap">
        <button id="curriculumMore" type="button" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold hidden" aria-expanded="false">×”×¦×’ ×¢×•×“</button>
        <button id="curriculumNext" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50" disabled aria-disabled="true">×”××©×š</button>
      </div>
    </div>
  </div>

  <!-- Operation + Count -->
  <div id="operationScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-3xl w-full">
      <div class="text-5xl mb-4">ğŸ¯</div>
      <h2 id="operationTitle" tabindex="-1" class="no-focus-outline text-3xl md:text-4xl font-extrabold text-green-600 mb-2 leading-tight">×¢×›×©×™×• ×™×© ×œ×‘×—×•×¨ ××ª ×¡×•×’ ×”×ª×¨×’×™×œ×™×</h2>
      <h3 class="subhead mb-6">×‘×—×¨×• ×¡×•×’ ×ª×¨×’×™×œ ×•××¡×¤×¨ ×©××œ×•×ª</h3>

      <div id="opsGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8">
        <button type="button" data-op="addition" class="choice-card op-btn" data-tint="green" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">â•</div>
          <div class="text-xl font-bold">×—×™×‘×•×¨</div>
        </button>
        <button type="button" data-op="subtraction" class="choice-card op-btn" data-tint="pink" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">â–</div>
          <div class="text-xl font-bold">×—×™×¡×•×¨</div>
        </button>
        <button type="button" data-op="multiplication" class="choice-card op-btn" data-tint="purple" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">âœ–ï¸</div>
          <div class="text-xl font-bold">×›×¤×œ</div>
        </button>
        <button type="button" data-op="division" class="choice-card op-btn" data-tint="orange" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">â—</div>
          <div class="text-xl font-bold">×—×™×œ×•×§</div>
        </button>
        <button type="button" data-op="mixed" class="choice-card op-btn col-span-2 sm:col-span-1" data-tint="blue" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">ğŸ²</div>
          <div class="text-xl font-bold">×”×›×œ</div>
        </button>
      </div>

      <div class="mb-2">
        <div class="subhead mb-3 text-center">××¡×¤×¨ ×©××œ×•×ª ×‘×¡×˜</div>
        <div id="questionChips" class="chips">
          <button type="button" class="chip" data-count="6" aria-pressed="false">6</button>
          <button type="button" class="chip" data-count="8" aria-pressed="false">8</button>
          <button type="button" class="chip" data-count="10" aria-pressed="false">10</button>
        </div>
      </div>

      <div class="mt-6">
        <button id="operationNext" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50" disabled aria-disabled="true">×”××©×š</button>
      </div>
    </div>
  </div>

  <!-- Difficulty -->
  <div id="difficultyScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
      <div class="text-5xl mb-4">âš¡</div>
      <h2 id="difficultyTitle" tabindex="-1" class="no-focus-outline text-3xl sm:text-4xl font-bold text-blue-600 mb-6">××™×–×• ×¨××ª ×§×•×©×™ ××ª××™××” ×œ×š ×”×™×•×?</h2>
      <div class="flex flex-col gap-4 mb-2">
        <button type="button" data-diff="easy" class="choice-card diff-btn" data-tint="green" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">ğŸŒ±</div>
          <div class="text-xl font-bold">×§×œ</div>
        </button>
        <button type="button" data-diff="medium" class="choice-card diff-btn" data-tint="orange" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">ğŸ”¥</div>
          <div class="text-xl font-bold">×‘×™× ×•× ×™</div>
        </button>
        <button type="button" data-diff="hard" class="choice-card diff-btn" data-tint="purple" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">âš¡</div>
          <div class="text-xl font-bold">××ª×§×“×</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Game -->
  <div id="gameScreen" class="hidden min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6 mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-4">
        <div class="text-2xl font-bold text-purple-600">×©××œ×” <span id="currentQuestion" class="ltr">1</span> ××ª×•×š <span id="totalQuestions" class="ltr">6</span></div>
        <div class="text-xl text-gray-600">×©×œ×•× <span id="gamePlayerName"></span>! ğŸ‘‹</div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4" aria-hidden="true">
        <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width: 0%"></div>
      </div>
      <div id="statusMsg" class="sr-only" aria-live="polite"></div>
    </div>

    <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 mx-auto max-w-lg text-center">
      <div class="text-5xl mb-4 owl-blink">ğŸ¦‰</div>
      <div id="questionText" tabindex="-1" class="no-focus-outline text-3xl font-bold text-gray-800 mb-6 ltr">5 + 3 = ?</div>
      <div class="subhead text-gray-700 mb-4">×™×© ×œ×‘×—×•×¨ ××ª ×”×ª×©×•×‘×” ×”× ×›×•× ×”</div>
    </div>

    <div id="answersGrid" class="grid grid-cols-2 gap-4 max-w-lg mx-auto px-4 mb-6">
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="6" data-idx="0" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">6</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="8" data-idx="1" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">8</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="7" data-idx="2" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">7</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="5" data-idx="3" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">5</div>
      </div>
    </div>

    <div class="text-center space-y-4 pb-6">
      <button id="confirmButton" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold transition-all duration-200 shadow-lg" disabled aria-disabled="true">××©×¨ ×ª×©×•×‘×”</button>
      <button type="button" id="restartBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div role="dialog" aria-modal="true" aria-labelledby="feedbackText" class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
        <div id="feedbackIcon" class="text-8xl mb-4">ğŸ‰</div>
        <div id="feedbackText" aria-live="polite" class="text-2xl font-bold mb-6">×›×œ ×”×›×‘×•×“!</div>
        <button id="nextButton" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×œ×¡×™×›×•× ×”×ª×•×¦××•×ª</button>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div id="resultsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full relative overflow-hidden">
      <div class="text-8xl mb-4">ğŸ†</div>
      <h2 id="resultsTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-green-600 mb-4">×›×œ ×”×›×‘×•×“!</h2>
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">×”×‘×™×¦×•×¢×™× ×©×œ×š:</span>
          <span id="performancePercentage" class="text-sm font-bold text-blue-600 ltr">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div id="performanceBar" class="h-6 rounded-full transition-all duration-1000 flex" aria-label="Progress indicator">
            <div id="correctBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
            <div id="incorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <span class="text-green-600 font-medium">âœ“ × ×›×•× ×•×ª: <span id="correctCount" class="ltr">0</span></span>
          <span class="text-orange-600 font-medium">âœ— ×©×’×•×™×•×ª: <span id="incorrectCount" class="ltr">0</span></span>
        </div>
      </div>
      <div class="text-xl text-gray-700 mb-6">
        <div id="performanceMessage" class="mb-4 font-medium text-lg">×¡×™×™××ª ××ª ×”×¡×˜! ğŸ¯</div>
        <div class="mb-2">×ª×©×•×‘×•×ª × ×›×•× ×•×ª: <span id="correctAnswers" class="font-bold text-green-600 ltr">0</span>/<span id="resultsTotal" class="ltr">6</span></div>
        <div class="mb-4">×–××Ÿ ×××•×¦×¢: <span id="averageTime" class="font-bold text-blue-600 ltr">0</span> ×©× ×™×•×ª</div>
      </div>
      <div class="flex flex-col gap-4">
        <button id="retryBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×× ×™ ×¨×•×¦×” ×œ×ª×¨×’×œ ××—×“×©</button>
        <button id="mistakesButton" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×œ×œ××•×“ ××”×˜×¢×•×™×•×ª</button>
        <button id="altBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×‘× ×œ×™ ×ª×¨×’×•×œ ××—×¨</button>
        <button id="profileFromResultsBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">××–×•×¨ ××™×©×™</button>
      </div>
    </div>
    <footer class="site-signature px-4">
      <div>Â© 2025 yaroni studio - ×ª×•×›×Ÿ ×—×–×§, ×¢×•×‘×“ ×—×›× ×•××‘×•×¡×¡ ×¢×œ ×‘×™× ×”</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Mistakes Review -->
  <div id="mistakesScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">ğŸ“š</div>
        <h2 id="mistakesTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-orange-600 mb-4">×œ××“ ××”×˜×¢×•×™×•×ª</h2>
        <div class="mb-6 max-w-md mx-auto">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mb-3">
            <div id="mistakesPerformanceBar" class="h-4 rounded-full transition-all duration-1000 flex" aria-label="Performance summary">
              <div id="mistakesCorrectBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
              <div id="mistakesIncorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>
          <div id="mistakesMessage" class="subhead text-gray-700 mb-4">×”× ×” ×”×ª×¨×’×™×œ×™× ×©×‘×”× ×˜×¢×™×ª</div>
        </div>
        <p class="text-lg text-gray-600">×œ×—×¥ ×¢×œ ×›×œ ×ª×¨×’×™×œ ×›×“×™ ×œ×œ××•×“ ××™×š ×œ×¤×ª×•×¨ ××•×ª×•:</p>
      </div>
      <div id="mistakesList" class="space-y-6 mb-8"></div>
      <div class="text-center space-y-4">
        <button id="backToResults" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×—×–×•×¨ ×œ×ª×•×¦××•×ª</button>
        <button type="button" id="restartFromMistakes" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
      </div>
    </div>
  </div>

  <!-- Tutorial (per mistake) -->
  <div id="tutorialScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">ğŸ“</div>
        <h2 id="tutorialTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-blue-600 mb-4 ltr">7 Ã· 5 = ?</h2>
        <p class="text-lg text-gray-600">×‘×•××• × ×œ××“ ×™×—×“ ××™×š ×œ×¤×ª×•×¨ ××ª ×”×©××œ×” ×”×–×•!</p>
      </div>
      <div id="tutorialSteps" class="space-y-8 mb-8"></div>

      <div id="interactiveArea" class="bg-blue-50 rounded-2xl p-6 mb-8 text-center">
        <h3 class="subhead text-blue-600 mb-4">× ×¡×” ×‘×¢×¦××š!</h3>
        <div id="interactiveContent" class="flex flex-col items-center justify-center gap-3 mb-4"></div>
        <div id="interactiveInstructions" role="status" aria-live="polite" class="text-gray-600">×”×©×ª××©/×™ ×‘×›×¤×ª×•×¨×™× ×›×“×™ ×œ×”×’×™×¢ ×œ×ª×•×¦××”</div>
      </div>

      <div class="flex justify-center gap-4 flex-wrap">
        <button id="backToMistakes" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×—×–×•×¨ ×œ×¨×©×™××ª ×”×˜×¢×•×™×•×ª</button>
        <button type="button" id="restartFromTutorial" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
      </div>
    </div>
  </div>

  <!-- Profile -->
  <div id="profileScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
        <h2 class="text-3xl font-bold text-indigo-600">×”××–×•×¨ ×”××™×©×™</h2>
        <div class="flex gap-2">
          <button id="profileStartBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700">×”×ª×—×œ ××©×—×§</button>
          <button id="profileSwitchBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">×”×—×œ×£ ××©×ª××©</button>
          <button id="profileNewBtn" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold">××©×ª××© ×—×“×©</button>
        </div>
      </div>

      <div id="profileHeader" class="mb-6 text-lg text-gray-700"></div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="p-4 rounded-2xl border-2 border-green-200 bg-green-50">
          <div class="text-sm text-green-700">×¡×˜×™× ×©×‘×•×¦×¢×•</div>
          <div id="kpiSets" class="text-3xl font-extrabold text-gray-900 ltr">0</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-blue-200 bg-blue-50">
          <div class="text-sm text-blue-700">×“×™×•×§ ××¦×˜×‘×¨</div>
          <div id="kpiAccuracy" class="text-3xl font-extrabold text-gray-900 ltr">0%</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-purple-200 bg-purple-50">
          <div class="text-sm text-purple-700">×–××Ÿ ×××•×¦×¢ ×œ×©××œ×”</div>
          <div id="kpiAvg" class="text-3xl font-extrabold text-gray-900 ltr">0s</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="byOpGrid"></div>

      <div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">×”×™×¡×˜×•×¨×™×™×ª ×¡×˜×™×</h3>
        <div id="historyList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
    /* ========= State ========= */
    let currentOperation=null, currentDifficulty='easy', currentQuestionIndex=0;
    let correctCount=0, totalQuestions=6, questions=[], mistakes=[];
    let startTime=0, totalTime=0, playerName='', selectedAnswer=null;
    let questionCount=null, currentCurriculum=null;
    let activeMistake=null;

    /* ========= Store (local profiles) ========= */
    const STORE_KEY='mspr_profiles_v1';
    let store=null; let memOnly=false;

    function uuid(){
      return 'xxxxxxxyxxxx'.replace(/[xy]/g, c=>{
        const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8);
        return v.toString(16);
      });
    }

    function storeInit(){
      try{
        store = JSON.parse(localStorage.getItem(STORE_KEY)||'null');
      }catch{ store=null; memOnly=true; }
      if(!store){
        store = { version:1, installedAt:Date.now(), activeId:null, profiles:{} };
        try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }
        catch{ memOnly=true; }
      }
    }
    function saveStore(){ if(memOnly) return; try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; } }
    function profilesArr(){ return Object.entries(store.profiles).map(([id,p])=>({id,...p})); }
    function getActiveProfile(){ return store.activeId ? store.profiles[store.activeId]||null : null; }
    function setActiveProfile(id){ if(!store.profiles[id]) return; store.activeId=id; store.profiles[id].lastSeen=Date.now(); saveStore(); }
    function ensureProfileByName(name){
      const norm=(name||'').trim(); if(!norm) return null;
      const existing=profilesArr().find(p=>p.name.trim()===norm);
      if(existing){ setActiveProfile(existing.id); return existing; }
      const id=uuid();
      store.profiles[id]={ name:norm, createdAt:Date.now(), lastSeen:Date.now(),
        totals:{sets:0,questions:0,correct:0,timeSec:0}, byOp:{}, history:[] };
      setActiveProfile(id);
      return {id, ...store.profiles[id]};
    }

    function logSessionToProfile(){
      const prof=getActiveProfile(); if(!prof) return;
      const entry={ id:uuid(), ts:Date.now(), curriculum:currentCurriculum, op:currentOperation, diff:currentDifficulty,
        count:totalQuestions, correct:correctCount, avgSec:Math.max(1,Math.round(totalTime/Math.max(1,totalQuestions))),
        mistakesCount:mistakes.length };
      prof.history.unshift(entry); if(prof.history.length>100) prof.history.pop();

      prof.totals.sets+=1; prof.totals.questions+=totalQuestions; prof.totals.correct+=correctCount; prof.totals.timeSec+=Math.round(totalTime);

      const bucket=currentOperation||'mixed';
      if(!prof.byOp[bucket]) prof.byOp[bucket]={sets:0,questions:0,correct:0,timeSec:0};
      prof.byOp[bucket].sets+=1; prof.byOp[bucket].questions+=totalQuestions; prof.byOp[bucket].correct+=correctCount; prof.byOp[bucket].timeSec+=Math.round(totalTime);
      saveStore();
    }

    /* ========= Difficulty / Curriculum rules ========= */
    const rulesByDifficulty={
      easy:{addSubMax:20,mulMax:5,divMaxDivisor:5,divMaxQuotient:5},
      medium:{addSubMax:100,mulMax:10,divMaxDivisor:10,divMaxQuotient:10},
      hard:{addSubMax:1000,mulMax:12,divMaxDivisor:12,divMaxQuotient:12}
    };

    const curricula={
      none:{name:'×œ×œ× ×ª×•×›× ×™×ª'},
      il_g1_s1:{name:'×›×™×ª×” ××³, ××—×¦×™×ª ×¨××©×•× ×”',operations:['addition','subtraction'],addSubMax:10},
      il_g1_s2:{name:'×›×™×ª×” ××³, ××—×¦×™×ª ×©× ×™×™×”',operations:['addition','subtraction'],addSubMax:20},
      il_g1_adv:{name:'×›×™×ª×” ××³, ××ª×’×¨',operations:['addition','subtraction'],addSubMax:30},
      il_g2:{name:'×›×™×ª×” ×‘×³',operations:['addition','subtraction'],addSubMax:100},
      il_g3:{name:'×›×™×ª×” ×’×³',operations:['addition','subtraction','multiplication','division'],addSubMax:100,mulMax:10,divMaxDivisor:10,divMaxQuotient:10},
      il_g4:{name:'×›×™×ª×” ×“×³',operations:['addition','subtraction','multiplication','division'],addSubMax:1000,mulMax:12,divMaxDivisor:12,divMaxQuotient:12}
    };

    /* ========= Helpers ========= */
    const $=sel=>document.querySelector(sel);
    const $$=sel=>document.querySelectorAll(sel);
    const randInt=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    function shuffle(a){const c=a.slice();for(let i=c.length-1;i>0;i++){const j=Math.floor(Math.random()*(i+1));[c[i],c[j]]=[c[j],c[i]]}return c}
    function focusTop(selector){
      const el=typeof selector==='string'?document.querySelector(selector):selector;
      const target=el||document.body;
      if(target && !target.hasAttribute('tabindex')) target.setAttribute('tabindex','-1');
      requestAnimationFrame(()=>{
        window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
        try{ target && target.focus({preventScroll:true}); }catch{}
      });
    }
    function updateStatus(msg){ const el=$('#statusMsg'); if(el) el.textContent=msg||''; }
    function showCoach(msg){ updateStatus(msg); }
    function hideCoach(){}
    function placeCoach(){}

    /* ========= Audio (Safari-safe) ========= */
    let isMuted=false, audioCtx=null, audioUnlocked=false;

    function getAudioCtx(){
      if(isMuted) return null;
      const AC=window.AudioContext||window.webkitAudioContext;
      if(!AC) return null;
      if(!audioCtx) audioCtx=new AC();
      if(audioCtx.state!=='running' && audioCtx.resume){ try{ audioCtx.resume(); }catch{} }
      return audioCtx;
    }
    function unlockAudioOnce(){
      if(audioUnlocked||isMuted) return;
      const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return;
      if(!audioCtx) audioCtx=new AC();
      try{ const p=audioCtx.resume&&audioCtx.resume(); if(p&&p.catch) p.catch(()=>{}); }catch{}
      try{
        const buffer=audioCtx.createBuffer(1,1,audioCtx.sampleRate);
        const src=audioCtx.createBufferSource(); const gain=audioCtx.createGain(); gain.gain.value=0.0001;
        src.buffer=buffer; src.connect(gain); gain.connect(audioCtx.destination); src.start(0);
        setTimeout(()=>{ try{ src.disconnect(); gain.disconnect(); }catch{} audioUnlocked=true; },0);
      }catch{
        try{ const t=audioCtx.currentTime, o=audioCtx.createOscillator(), g=audioCtx.createGain();
          g.gain.setValueAtTime(0.0001,t); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.02); audioUnlocked=true; }catch{}
      }
    }
    function ensureUnlocked(){ const ctx=getAudioCtx(); if(!ctx) return; if(!audioUnlocked) unlockAudioOnce(); }
    function tone(freq,dur,t,type='sine',gain=0.24){
      if(isMuted) return; ensureUnlocked(); const ctx=getAudioCtx(); if(!ctx) return;
      const start=typeof t==='number'?t:ctx.currentTime; const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type=type; o.frequency.setValueAtTime(freq,start);
      g.gain.setValueAtTime(gain,start); g.gain.exponentialRampToValueAtTime(0.001,start+dur);
      o.connect(g); g.connect(ctx.destination); try{ o.start(start); o.stop(start+dur); }catch{}
    }
    function playSelectTick(){ const ctx=getAudioCtx(); if(!ctx){ ensureUnlocked(); return; } const t=ctx.currentTime; tone(520,0.10,t,'triangle',0.24); }
    function playSuccessSound(){ const ctx=getAudioCtx(); if(!ctx){ ensureUnlocked(); return; } const t=ctx.currentTime; tone(523.25,0.12,t,'sine',0.22); tone(659.25,0.12,t+0.1,'sine',0.20); tone(783.99,0.14,t+0.2,'sine',0.18); }
    function playErrorSound(){ const ctx=getAudioCtx(); if(!ctx){ ensureUnlocked(); return; } const t=ctx.currentTime; tone(220,0.12,t,'square',0.20); tone(180,0.12,t+0.1,'square',0.18); }
    function initAudioToggle(){
      const btn=$('#audioToggle'); if(!btn) return;
      try{ isMuted=localStorage.getItem('soundMuted')==='true'; }catch{ isMuted=false; }
      btn.setAttribute('aria-pressed', isMuted?'true':'false');
      btn.addEventListener('click',()=>{ isMuted=!isMuted; btn.setAttribute('aria-pressed', isMuted?'true':'false'); try{ localStorage.setItem('soundMuted', String(isMuted)); }catch{} if(!isMuted) unlockAudioOnce(); });
    }
    document.addEventListener('click',e=>{
      const el=e.target.closest('button,.op-btn,.choice-card,.chip,.link-cta');
      if(!el||el.id==='audioToggle') return;
      const wasLocked=!audioUnlocked; unlockAudioOnce();
      if(el.disabled||el.getAttribute('aria-disabled')==='true') return;
      if(wasLocked) setTimeout(playSelectTick,0); else playSelectTick();
    });
    document.addEventListener('keydown',e=>{
      if((e.key==='Enter'||e.key===' ') && document.activeElement?.closest('button,.op-btn,.choice-card,.chip,.link-cta')) playSelectTick();
    });

    /* ========= Screen switcher ========= */
    const SCREENS=['welcomeScreen','nameScreen','curriculumScreen','operationScreen','difficultyScreen','gameScreen','resultsScreen','mistakesScreen','tutorialScreen','profileScreen'];
    function showScreen(id){
      SCREENS.forEach(s=>$('#'+s)?.classList.add('hidden'));
      $('#'+id)?.classList.remove('hidden');
      window.scrollTo({top:0,left:0,behavior:'auto'});
    }

    /* ========= Curriculum gating ========= */
    function applyCurriculumToOperationButtons(){
      const cur=curricula[currentCurriculum]; const allowed=cur&&cur.operations?cur.operations:null;
      $$('#opsGrid .op-btn').forEach(btn=>{
        const op=btn.getAttribute('data-op');
        const enabled=!allowed || op==='mixed' || allowed.includes(op);
        btn.classList.toggle('opacity-50',!enabled);
        btn.classList.toggle('pointer-events-none',!enabled);
        btn.classList.toggle('cursor-not-allowed',!enabled);
        btn.setAttribute('aria-disabled', enabled?'false':'true');
        if(!enabled && btn.classList.contains('selected')){
          btn.classList.remove('selected'); btn.setAttribute('aria-pressed','false');
          if(currentOperation===op) currentOperation=null;
        }
      });
      updateOperationNextState();
    }

    /* ========= Curriculum overflow ========= */
    let isCurriculumExpanded=false;
    function refreshCurriculumOverflow(){
      const grid=$('#curriculumGrid'), more=$('#curriculumMore'), fade=$('#curriculumFade');
      if(!grid||!more||!fade) return;
      const overflow=grid.scrollHeight>grid.clientHeight+2;
      more.classList.toggle('hidden', !overflow && !isCurriculumExpanded);
      fade.classList.toggle('hidden', isCurriculumExpanded || !overflow);
    }
    function setCurriculumExpanded(expanded){
      isCurriculumExpanded=!!expanded;
      const grid=$('#curriculumGrid'), more=$('#curriculumMore'); if(!grid||!more) return;
      grid.classList.toggle('curriculum-collapsed', !isCurriculumExpanded);
      more.textContent=isCurriculumExpanded?'×”×¦×’ ×¤×—×•×ª':'×”×¦×’ ×¢×•×“';
      more.setAttribute('aria-expanded', isCurriculumExpanded?'true':'false');
      refreshCurriculumOverflow();
    }

    /* ========= Question generation ========= */
    function getEffectiveRules(diff){
      const base=Object.assign({},rulesByDifficulty[diff]);
      const cur=curricula[currentCurriculum]||{};
      ['addSubMax','mulMax','divMaxDivisor','divMaxQuotient'].forEach(k=>{ if(typeof cur[k]!=='undefined') base[k]=cur[k]; });
      return base;
    }
    function getOpsList(selectedOp,cur){ if(selectedOp!=='mixed') return [selectedOp]; const allowed=cur&&cur.operations?cur.operations:null; return (allowed&&allowed.length)?allowed:['addition','subtraction','multiplication','division']; }
    function buildOpPool(op,rules,targetSize,diff){
      const pool=[]; let tries=0, max=6000;
      const mk=(text,ans,op,a,b,sym)=>({ id:`${op}:${a}${sym}${b}`, questionText:text, answer:ans, operation:op, num1:a, num2:b, symbol:sym });
      if(op==='addition'){ while(pool.length<targetSize&&tries++<max){ const flu=(diff==='easy')&&Math.random()<.5; const cap= flu? Math.min(10,rules.addSubMax) : rules.addSubMax; const a=randInt(0,cap), b=randInt(0,cap), ans=a+b; if(ans<=cap) pool.push(mk(`${a} + ${b} = ?`,ans,op,a,b,'+')); } }
      if(op==='subtraction'){ while(pool.length<targetSize&&tries++<max){ const flu=(diff==='easy')&&Math.random()<.5; const cap= flu? Math.min(10,rules.addSubMax) : rules.addSubMax; const a=randInt(0,cap), b=randInt(0,a), ans=a-b; if(ans>=0) pool.push(mk(`${a} - ${b} = ?`,ans,op,a,b,'-')); } }
      if(op==='multiplication'){ while(pool.length<targetSize&&tries++<max){ const a=randInt(1,rules.mulMax), b=randInt(1,rules.mulMax); pool.push(mk(`${a} Ã— ${b} = ?`,a*b,op,a,b,'Ã—')); } }
      if(op==='division'){ while(pool.length<targetSize&&tries++<max){ const d=randInt(1,rules.divMaxDivisor), q=randInt(1,rules.divMaxQuotient); const n=d*q; pool.push(mk(`${n} Ã· ${d} = ?`,q,op,q,d,'Ã·')); } }
      return pool;
    }
    function generatePracticeSet(operation,diff,count){
      const rules=getEffectiveRules(diff); const cur=curricula[currentCurriculum]; const ops=getOpsList(operation,cur);
      let pool=[]; ops.forEach(o=>pool=pool.concat(buildOpPool(o,rules,count*4,diff)));
      const map={}; pool.forEach(q=>{ if(!map[q.id]) map[q.id]=q; });
      return shuffle(Object.values(map)).slice(0,count);
    }
    function generateAnswerOptions(correct){
      const opts=new Set([correct]);
      const span=Math.max(5, Math.ceil(correct*0.25));
      while(opts.size<4){
        const delta=randInt(-span, span);
        const wrong=correct+delta;
        if(wrong>0 && wrong!==correct) opts.add(wrong);
      }
      return shuffle([...opts]);
    }

    /* ========= Flow ========= */
    function showNameInput(){
      const prof=getActiveProfile();
      showScreen('nameScreen');
      const subtitle=$('#nameSubtitle');
      if(prof){ $('#playerName').value=prof.name; subtitle.textContent=`× ×¢×™× ×œ×¨××•×ª×š ×©×•×‘, ${prof.name}!`; subtitle.classList.remove('hidden'); }
      else{ $('#playerName').value=''; subtitle.classList.add('hidden'); }
      focusTop('#nameTitle'); updateStatus('');
    }

    function trapDialog(modalSel){
      const modal=$(modalSel); if(!modal) return;
      const getF=()=>modal.querySelectorAll('button,[href],[tabindex]:not([tabindex="-1"])');
      function onKey(e){
        if(e.key==='Escape'){ modal.classList.add('hidden'); modal.removeEventListener('keydown',onKey); return; }
        if(e.key!=='Tab') return;
        const f=[...getF()]; if(!f.length) return;
        const first=f[0], last=f[f.length-1];
        if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
      }
      modal.addEventListener('keydown',onKey);
      requestAnimationFrame(()=>{ const f=getF()[0]; f && f.focus(); });
    }

    function showUserPicker(){
      const list=$('#userList'); list.innerHTML='';
      const arr=profilesArr();
      if(arr.length<=1){ $('#userPickerModal').classList.add('hidden'); showProfile(); return; }
      arr.forEach(p=>{
        const btn=document.createElement('button');
        btn.className='w-full text-right p-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 flex items-center justify-between';
        btn.innerHTML=`<span class="font-bold text-gray-800">${p.name}</span><span class="text-sm text-gray-500 ltr">${new Date(p.lastSeen||Date.now()).toLocaleDateString('he-IL')}</span>`;
        btn.onclick=()=>{ setActiveProfile(p.id); $('#playerName').value=p.name; $('#userPickerModal').classList.add('hidden'); if(!$('#profileScreen').classList.contains('hidden')) renderProfile(); };
        list.appendChild(btn);
      });
      $('#userPickerModal').classList.remove('hidden');
      trapDialog('#userPickerModal');
    }

    function showCurriculumSelect(){
      const inp=$('#playerName'); const name=(inp?.value||'').trim(); if(!name){ alert('×× × ×”×›× ×¡ ××ª ×©××š'); inp?.focus(); return; }
      playerName=name; ensureProfileByName(name);
      showScreen('curriculumScreen');
      currentCurriculum=null;
      $$('#curriculumGrid .choice-card').forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
      const btn=$('#curriculumNext'); btn.disabled=true; btn.setAttribute('aria-disabled','true');
      setCurriculumExpanded(false); requestAnimationFrame(refreshCurriculumOverflow);
      focusTop('#curriculumTitle'); updateStatus('');
    }

    function showOperationSelect(){
      if(!currentCurriculum){ alert('×™×© ×œ×‘×—×•×¨ ×ª×›× ×™×ª ×œ×™××•×“'); return; }
      showScreen('operationScreen');
      currentOperation=null; questionCount=null;
      $$('#opsGrid .op-btn').forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
      $$('#questionChips .chip').forEach(c=>{ c.classList.remove('selected'); c.setAttribute('aria-pressed','false'); });
      applyCurriculumToOperationButtons(); updateOperationNextState();
      focusTop('#operationTitle'); updateStatus('');
    }

    function showDifficultySelect(){
      if(!currentOperation || !questionCount){ alert('×‘×—×¨/×™ ×¡×•×’ ×ª×¨×’×™×œ ×•××¡×¤×¨ ×©××œ×•×ª'); return; }
      showScreen('difficultyScreen');
      $$('#difficultyScreen .diff-btn').forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
      focusTop('#difficultyTitle'); updateStatus('');
    }

    function startGame(diff){
      $('#feedback')?.classList.add('hidden');
      const nb=$('#nextButton'); if(nb) nb.onclick=null;
      currentDifficulty=diff; currentQuestionIndex=0; correctCount=0; totalTime=0; mistakes=[]; selectedAnswer=null;

      questions=generatePracticeSet(currentOperation,diff,questionCount||6);
      if(!questions.length){ alert('×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ ×ª×¨×’×™×œ×™× ×¢×‘×•×¨ ×”×”×’×“×¨×•×ª ×©× ×‘×—×¨×•'); return; }

      totalQuestions=questions.length; $('#totalQuestions').textContent=totalQuestions; $('#resultsTotal').textContent=totalQuestions;
      showScreen('gameScreen');

      const prof=getActiveProfile(); playerName = prof ? prof.name : playerName;
      $('#gamePlayerName').textContent=playerName;

      const pb=$('#progressBar'); pb.style.width='0%'; pb.setAttribute('aria-valuenow','0');

      showQuestion();
      focusTop('#questionText');
      showCoach('×™×¦×× ×• ×œ×“×¨×š! ×‘×—×¨/×™ ×ª×©×•×‘×” ×•××– ××©×¨/×™.');
    }

    /* ========= Game ========= */
    function showQuestion(){
      if(currentQuestionIndex>=questions.length){ showResults(); return; }
      selectedAnswer=null;
      const q=questions[currentQuestionIndex];
      $('#questionText').textContent=q.questionText;
      $('#currentQuestion').textContent=currentQuestionIndex+1;

      const prog=(currentQuestionIndex/totalQuestions)*100; const pb=$('#progressBar'); const p=Math.max(2,Math.round(prog)); pb.style.width=p+'%'; pb.setAttribute('aria-valuenow',String(p));

      const options=generateAnswerOptions(q.answer);
      const items=$$('#answersGrid .answer-item');
      options.forEach((opt,i)=>{ const el=items[i]; if(!el) return; el.setAttribute('data-value',String(opt)); el.setAttribute('data-idx',String(i)); el.querySelector('.tabular-nums').textContent=String(opt); el.classList.remove('selected'); el.setAttribute('aria-selected','false'); });

      disableConfirm();
      startTime=Date.now();
      placeCoach('game');
    }

    function enableConfirm(){ const btn=$('#confirmButton'); btn.disabled=false; btn.removeAttribute('disabled'); btn.setAttribute('aria-disabled','false'); }
    function disableConfirm(){ const btn=$('#confirmButton'); btn.disabled=true; btn.setAttribute('disabled',''); btn.setAttribute('aria-disabled','true'); }

    function confirmAnswer(){
      unlockAudioOnce();
      const btn=$('#confirmButton');
      if(!btn || btn.hasAttribute('disabled')) return;
      if(selectedAnswer===null) return;

      disableConfirm();

      const correct=questions[currentQuestionIndex].answer;
      const end=Date.now();
      totalTime+=(end-startTime)/1000;

      const isLast=currentQuestionIndex===totalQuestions-1;

      if(selectedAnswer===correct){
        correctCount++; playSuccessSound();
        showCoach(isLast ? '××¢×•×œ×”! ×¡×™×™×× ×• ××ª ×”×¡×˜ â€” ×¢×•×‘×¨×™× ×œ×¡×™×›×•×.' : '×›×œ ×”×›×‘×•×“! ×œ×©××œ×” ×”×‘××”â€¦');
      }else{
        mistakes.push({ question:questions[currentQuestionIndex], userAnswer:selectedAnswer, correctAnswer:correct, reviewed:false });
        playErrorSound();
        showCoach(isLast ? '×¡×™×™×× ×• ××ª ×”×¡×˜ â€” ×¢×•×‘×¨×™× ×œ×¡×™×›×•×.' : '×›××¢×˜! ×××©×™×›×™× ×œ×©××œ×” ×”×‘××”â€¦');
      }

      if(isLast){ showFinalFeedback(); }
      else{ setTimeout(nextQuestion, 900); }
    }

    function showFinalFeedback(){
      const fb=$('#feedback'), icon=$('#feedbackIcon'), text=$('#feedbackText'), nextBtn=$('#nextButton');
      const pct=Math.round((correctCount/totalQuestions)*100);

      if(pct===100){ icon.textContent='ğŸ‘'; text.className='text-2xl font-bold mb-6 text-green-600'; text.textContent='×•××•×• ××œ×™×¤×•×ª, ×¡×™×™×× ×• ××ª ×”×¡×˜'; }
      else if(pct>=60){ icon.textContent='ğŸ‘'; text.className='text-2xl font-bold mb-6 text-blue-600'; text.textContent='×¢×‘×•×“×” ×˜×•×‘×”, ×¡×™×™×× ×• ××ª ×”×¡×˜'; }
      else{ icon.textContent='ğŸ’ª'; text.className='text-2xl font-bold mb-6 text-orange-600'; text.textContent='×¡×™×™×× ×• ××ª ×”×¡×˜'; }

      nextBtn.textContent='×œ×¡×™×›×•× ×”×ª×•×¦××•×ª';
      nextBtn.onclick=()=>{ $('#feedback').classList.add('hidden'); showResults(); };
      fb.classList.remove('hidden');
      trapDialog('#feedback');
    }

    function nextQuestion(){
      currentQuestionIndex++;
      if(currentQuestionIndex<totalQuestions){ showQuestion(); $('#confirmButton').focus(); }
      else{ const pb=$('#progressBar'); pb.style.width='100%'; pb.setAttribute('aria-valuenow','100'); showResults(); }
    }

    function getResultsTitleCopy(name,pct){
      if(pct===0) return `×œ× × ×•×¨× ${name}, ×©×•×¤×™ ×‘×˜×•×— ×©×‘×¤×¢× ×”×‘××” ×ª×”×™×” ×ª×•×¦××” ×˜×•×‘×” ×™×•×ª×¨`;
      else if(pct<=59) return `${name} ×¨×•××™× ×©×™×¤×•×¨, ×©×•×¤×™ ××—×›×” ×œ×ª×¨×’×•×œ × ×•×¡×£`;
      else if(pct<=79) return `${name} ×¢×‘×•×“×” ×˜×•×‘×”, ×©×•×¤×™ ××—×›×” ×œ×ª×¨×’×•×œ × ×•×¡×£`;
      else if(pct<=89) return `×•××•×• ${name}, ××™×–×• ×©×œ×™×˜×” × ××©×™×š ×œ×ª×¨×’×œ ×¢× ×©×•×¤×™`;
      return `×›×œ ×”×›×‘×•×“ ${name} ×©×•×¤×™ ×’××” ×‘×š!`;
    }

    function showResults(){
      showScreen('resultsScreen');

      const incorrect=totalQuestions-correctCount;
      const pct=Math.round((correctCount/totalQuestions)*100);
      const prof=getActiveProfile(); const displayName=prof?prof.name:playerName;
      $('#resultsTitle').textContent=getResultsTitleCopy(displayName,pct);

      const msg=$('#performanceMessage'), icon=$('#resultsScreen .text-8xl');
      if(correctCount===totalQuestions){ msg.textContent='××•×©×œ×! ×¢× ×™×ª × ×›×•×Ÿ ×¢×œ ×›×œ ×”×©××œ×•×ª! ğŸŒŸ'; msg.className='mb-4 font-medium text-lg text-green-600'; icon.textContent='ğŸ†'; confettiBurst($('#resultsScreen .bg-white')||$('#resultsScreen')); }
      else if(pct<50){ msg.textContent='× ×—×–×§ ××ª ×”×—×•×œ×©×•×ª ×•××—×¨ ×›×š × ×ª×¨×’×œ ×©×•×‘.'; msg.className='mb-4 font-medium text-lg text-orange-600'; icon.textContent='ğŸ’ª'; }
      else{ msg.textContent='×¢× ×™×ª × ×›×•×Ÿ ×¢×œ '+correctCount+' ××ª×•×š '+totalQuestions+' ×©××œ×•×ª - ×›×œ ×”×›×‘×•×“! ğŸ¯'; msg.className='mb-4 font-medium text-lg text-blue-600'; icon.textContent='ğŸ†'; }

      updatePerformanceBar(correctCount,incorrect,pct);
      $('#correctAnswers').textContent=String(correctCount);
      $('#averageTime').textContent=String(Math.max(1,Math.round(totalTime/totalQuestions)));
      $('#mistakesButton').classList.toggle('hidden', mistakes.length===0);

      logSessionToProfile();

      let coachText='×¡×™×›×•× ×”×¡×˜ ×”×•×©×œ×.'; if(mistakes.length===0) coachText+=' ××¤×©×¨ ×œ×ª×¨×’×œ ××—×“×©.'; else if(mistakes.length===1) coachText+=' ××¤×©×¨ ×œ×ª×¨×’×œ ××—×“×© ××• ×œ×œ××•×“ ××”×˜×¢×•×ª.'; else coachText+=' ××¤×©×¨ ×œ×ª×¨×’×œ ××—×“×© ××• ×œ×œ××•×“ ××”×˜×¢×•×™×•×ª.';
      updateStatus(coachText);

      focusTop('#resultsTitle');
    }

    function updatePerformanceBar(correct,incorrect,pct){
      $('#correctBar').style.width=(correct/totalQuestions*100)+'%';
      $('#incorrectBar').style.width=(incorrect/totalQuestions*100)+'%';
      $('#performancePercentage').textContent=pct+'%';
      $('#correctCount').textContent=String(correct);
      $('#incorrectCount').textContent=String(incorrect);
    }

    /* ========= Mistakes & Tutorial ========= */
    function showMistakes(){
      showScreen('mistakesScreen');
      const incorrect=totalQuestions-correctCount;
      $('#mistakesCorrectBar').style.width=((correctCount/totalQuestions)*100)+'%';
      $('#mistakesIncorrectBar').style.width=((incorrect/totalQuestions)*100)+'%';
      const mm=$('#mistakesMessage');
      if(mistakes.length===0){
        mm.textContent='××•×©×œ×! ×¢× ×™×ª × ×›×•×Ÿ ×¢×œ ×›×œ '+totalQuestions+' ×”×©××œ×•×ª! ğŸŒŸ';
        mm.className='subhead text-green-600 mb-4';
        $('#mistakesList').innerHTML='<div class="text-center p-8"><div class="text-6xl mb-4">ğŸ‰</div><h3 class="text-2xl font-bold text-green-600">××¢×•×œ×”!</h3><p class="text-lg text-gray-600">×œ× ×”×™×• ×œ×š ×˜×¢×•×™×•×ª ×‘××©×—×§ ×”×–×”!</p></div>';
        focusTop('#mistakesTitle'); return;
      } else if(correctCount>0){
        mm.textContent='×¢× ×™×ª × ×›×•×Ÿ ×¢×œ '+correctCount+' ××ª×•×š '+totalQuestions+' - ×‘×•××• × ×œ××“ ××”-'+mistakes.length+' ×©× ×©××¨×•';
        mm.className='subhead text-blue-600 mb-4';
      } else {
        mm.textContent='×‘×•××• × ×œ××“ ×™×—×“ ××™×š ×œ×¤×ª×•×¨ ××ª ×”×©××œ×•×ª ×”××œ×”';
        mm.className='subhead text-orange-600 mb-4';
      }

      const list=$('#mistakesList'); list.innerHTML='';
      questions.forEach((q,i)=>{
        const m=mistakes.find(x=>x.question.id===q.id); if(!m) return;
        const why=getWhyTip(m);
        const d=document.createElement('div');
        d.className='bg-orange-50 border-2 border-orange-200 rounded-2xl p-6 cursor-pointer hover:bg-orange-100 transition-colors';
        d.onclick=()=>showTutorial(m);
        d.innerHTML=`
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-4 h-4 bg-orange-500 rounded-full"></div>
              <h3 class="text-xl font-bold text-orange-600">×©××œ×” ${(i+1)}</h3>
            </div>
            <div class="text-2xl">ğŸ¤”</div>
          </div>
          <div class="text-2xl font-bold text-gray-800 mb-4 ltr">${m.question.questionText}</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
            <div class="bg-red-100 border-2 border-red-300 rounded-xl p-4">
              <div class="text-sm text-red-600 font-bold mb-1">×”×ª×©×•×‘×” ×©×œ×š:</div>
              <div class="text-xl font-bold text-red-700 ltr">${m.userAnswer}</div>
            </div>
            <div class="bg-green-100 border-2 border-green-300 rounded-xl p-4">
              <div class="text-sm text-green-600 font-bold mb-1">×”×ª×©×•×‘×” ×”× ×›×•× ×”:</div>
              <div class="text-xl font-bold text-green-700 ltr">${m.correctAnswer}</div>
            </div>
          </div>
          <div class="text-sm text-gray-600 mb-2">${why?('×œ××” ×–×” ×§×¨×”? ' + why):''}</div>
          <div class="text-center text-blue-600 font-bold">ğŸ‘† ×œ×—×¥ ×›××Ÿ ×›×“×™ ×œ×œ××•×“ ××™×š ×œ×¤×ª×•×¨</div>
        `;
        list.appendChild(d);
      });
      focusTop('#mistakesTitle');
      updateStatus('×œ×—×¥ ×¢×œ ×©××œ×” ×›×“×™ ×œ×¨××•×ª ×”×¡×‘×¨ ××™× ×˜×¨××§×˜×™×‘×™.');
    }

    function showTutorial(m){
      activeMistake=m;
      showScreen('tutorialScreen');
      const q=m.question; const title=$('#tutorialTitle'); title.textContent=q.questionText;
      createTutorialSteps(q); createInteractiveDemoNumeric(q);
      requestAnimationFrame(()=>{ title.focus({preventScroll:true}); window.scrollTo({top:0,behavior:'auto'}); });
      updateStatus('×”× ×” ×”×¡×‘×¨ ×¦×¢×“Ö¾××—×¨Ö¾×¦×¢×“. ×”×©×ª××©/×™ ×‘×›×¤×ª×•×¨×™ ×”××¡×¤×¨×™× ×›×“×™ ×œ×”×’×™×¢ ×œ×ª×•×¦××”.');
    }

    function createTutorialSteps(q){
      const c=$('#tutorialSteps'); c.innerHTML='';
      getTutorialSteps(q).forEach((s,i)=>{
        const d=document.createElement('div');
        d.className='bg-blue-50 border-2 border-blue-200 rounded-2xl p-6';
        d.innerHTML='<div class="flex items-center mb-4"><div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">'+(i+1)+'</div><h3 class="text-xl font-bold text-blue-600">'+s.title+'</h3></div><p class="text-gray-700 text-lg">'+s.description+'</p>';
        c.appendChild(d);
      });
    }

    function getTutorialSteps(q){
      const {operation,num1,num2,answer}=q;
      if(operation==='addition') return[
        {title:'×”×‘× ×ª ×”×©××œ×”',description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” '+num1+' + '+num2+'.'},
        {title:'×œ×‘× ×•×ª ××ª ×”××¡×¤×¨',description:'× ×©×ª××© ×‘×›×¤×ª×•×¨×™ ××¡×¤×¨×™× ×›×“×™ ×œ×”×’×™×¢ ×œ×ª×•×¦××” â€” ×¢×“×™×£ ×œ×”×ª×—×™×œ ×‘×¦×¢×“×™× ×’×“×•×œ×™× ×•××– ×œ×“×™×™×§.'},
        {title:'×“×™×•×§',description:'×›×©×§×¨×•×‘×™× ×œ×ª×•×¦××”, ×¢×•×‘×¨×™× ×œ×¦×¢×“×™× ×§×˜× ×™× ×™×•×ª×¨ (×œ××©×œ +1).'},
        {title:'×”×ª×•×¦××”',description:'×¢×•×¦×¨×™× ×‘×“×™×•×§ ×‘Ö¾'+answer+'.'}
      ];
      if(operation==='subtraction') return[
        {title:'×”×‘× ×ª ×”×©××œ×”',description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” '+num1+' - '+num2+'.'},
        {title:'×œ×”×’×™×¢ ×œ××¡×¤×¨ ×”×™×¢×“',description:'× ×ª×—×™×œ ×Ö¾'+num1+' ×•× ×—×¡×¨ ×‘×¦×¢×“×™× ×’×“×•×œ×™×, ×•××– × ×¢×‘×•×¨ ×œ×§×˜× ×™×.'},
        {title:'×“×™×•×§',description:'××¤×©×¨ ×’× ×œ×”×—×–×™×¨ ××¢×˜ ×¢× +1 ×× ×™×¨×“× ×• ×™×•×ª×¨ ××“×™.'},
        {title:'×”×ª×•×¦××”',description:'×¢×•×¦×¨×™× ×‘×“×™×•×§ ×‘Ö¾'+answer+'.'}
      ];
      if(operation==='multiplication') return[
        {title:'×”×‘× ×ª ×”×©××œ×”',description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” '+num1+' Ã— '+num2+'.'},
        {title:'×§×‘×•×¦×•×ª ×©×•×•×ª',description:'× ×•×¡×™×£ ×§×‘×•×¦×•×ª ×‘××¡×¤×¨×™× (×œ× ×¤×¨×™×˜×™×), ×›×œ ×§×‘×•×¦×” ×‘×’×•×“×œ '+num2+'.'},
        {title:'×¡×›×™××”',description:'×¡×•×¤×¨×™× ××ª ××¡×¤×¨ ×”×§×‘×•×¦×•×ª ×©×”×•×¡×¤× ×• ×•××¦×™×’×™× ××ª ×”×¡×š ×”×›×œ ×›×§×‘×•×¦×•×ªÃ—×’×•×“×œ.'},
        {title:'×”×ª×•×¦××”',description:'×›××©×¨ × ×•×¡×™×£ '+num1+' ×§×‘×•×¦×•×ª × ×§×‘×œ '+answer+'.'}
      ];
      if(operation==='division'){
        const dividend = num1 * num2; const divisor=num2;
        return[
          {title:'×”×‘× ×ª ×”×©××œ×”',description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” '+dividend+' Ã· '+divisor+'.'},
          {title:'×™×¦×™×¨×ª ×§×‘×•×¦×•×ª',description:'× ×•×¡×™×£ ×§×‘×•×¦×•×ª ××—×ª ××—×ª (××• ×‘×§×¤×™×¦×•×ª), ×›×œ ×§×‘×•×¦×” ×‘×’×•×“×œ '+divisor+'.'},
          {title:'×¢×¦×™×¨×” ×‘×–××Ÿ',description:'×¢×•×¦×¨×™× ×›×©×¡×™×™×× ×• ×œ×—×œ×§ ××ª ×›×œ ×”Ö¾'+dividend+' ×œ×œ× ×©××¨×™×ª.'},
          {title:'×”×ª×•×¦××”',description:'××¡×¤×¨ ×”×§×‘×•×¦×•×ª ×”×•× '+answer+'.'}
        ];
      }
      return [];
    }

    function markActiveMistakeReviewed(){ if(!activeMistake) return; activeMistake.reviewed=true; }

    /* === Numeric-only interactive demos (no balls/boxes) === */
    function stepSetByMagnitude(maxVal){
      if(maxVal<=20) return [5,1];        // ×›×•×œ×œ +1 ×•+5
      if(maxVal<=100) return [10,5,1];    // ×¢×“ 100
      return [100,50,20,10,5,1];          // ××¢×œ 100
    }

    function makeStepButton(label,onClick){
      const b=document.createElement('button');
      b.className='chip';
      b.textContent=label;
      b.onclick=()=>{ unlockAudioOnce(); onClick(); };
      return b;
    }

    // Addition/Subtraction: general numeric stepper toward target
    function numericStepper({start,target,allowNegative=false}){
      const area=$('#interactiveContent'), info=$('#interactiveInstructions');
      area.innerHTML='';
      let cur=start;

      const bigBox=document.createElement('div');
      bigBox.className='inline-flex items-center justify-center text-4xl font-extrabold text-gray-900 rounded-2xl border-2 border-blue-300 bg-white px-8 py-5 mb-2 ltr tabular-nums';
      bigBox.textContent=cur; area.appendChild(bigBox);

      const hint=document.createElement('div');
      hint.className='text-sm text-gray-600 mb-2'; hint.textContent=`××˜×¨×”: ${target}`; area.appendChild(hint);

      const steps=stepSetByMagnitude(Math.max(Math.abs(start),Math.abs(target)));
      const row=document.createElement('div'); row.className='flex flex-wrap gap-3 justify-center';
      steps.forEach(s=>{
        row.appendChild(makeStepButton('+'+s,()=>{ cur+=s; update(); }));
      });
      if(allowNegative){
        steps.forEach(s=>{
          row.appendChild(makeStepButton('âˆ’'+s,()=>{ cur-=s; update(); }));
        });
      }
      area.appendChild(row);

      const reset=document.createElement('button');
      reset.className='chip mt-2'; reset.textContent='××™×¤×•×¡';
      reset.onclick=()=>{ cur=start; update(); };
      area.appendChild(reset);

      function update(){
        bigBox.textContent=cur;
        if(cur===target){
          info.textContent='×‘×•×œ! ×”×’×¢×ª ×œ×ª×•×¦××” ×”××‘×•×§×©×ª ğŸ‰';
          info.className='text-green-600 font-bold text-lg';
          markActiveMistakeReviewed();
        }else{
          const dir = cur<target ? '×”×¢×œ×”' : '×”×•×¨×“';
          info.textContent=`${dir} ××ª ×”××¡×¤×¨ ×¢×“ ${target}`;
          info.className='text-gray-600';
        }
      }
      update();
    }

    // Multiplication: add groups numerically (no items rendering)
    function groupsNumericDemo(groupsNeeded, groupSize){
      const area=$('#interactiveContent'), info=$('#interactiveInstructions');
      area.innerHTML='';
      let groups=0;

      const totalBox=document.createElement('div');
      totalBox.className='text-2xl font-extrabold text-gray-900 ltr tabular-nums';
      const groupsBox=document.createElement('div');
      groupsBox.className='text-xl font-bold text-blue-700';

      const top=document.createElement('div');
      top.className='flex flex-col items-center gap-1';
      top.appendChild(groupsBox); top.appendChild(totalBox);
      area.appendChild(top);

      const steps=stepSetByMagnitude(groupsNeeded);
      const row=document.createElement('div'); row.className='flex flex-wrap gap-3 justify-center my-3';
      steps.forEach(s=> row.appendChild(makeStepButton('+'+s+' ×§×‘×•×¦×•×ª',()=>{ groups=Math.min(groupsNeeded, groups+s); update(); })));
      row.appendChild(makeStepButton('××™×¤×•×¡',()=>{ groups=0; update(); }));
      area.appendChild(row);

      function update(){
        groupsBox.textContent=`×§×‘×•×¦×•×ª: ${groups}/${groupsNeeded} (×›×œ ×§×‘×•×¦×” ${groupSize})`;
        totalBox.textContent=`×¡×”×´×› ×¤×¨×™×˜×™×: ${groups*groupSize}`;
        if(groups>=groupsNeeded){
          info.textContent=`××¢×•×œ×”! ${groupsNeeded}Ã—${groupSize} = ${groupsNeeded*groupSize} ğŸ‰`;
          info.className='text-green-600 font-bold text-lg';
          markActiveMistakeReviewed();
        }else{
          info.textContent=`×”×•×¡×™×¤×• ×§×‘×•×¦×•×ª ×¢×“ ${groupsNeeded}`;
          info.className='text-gray-600';
        }
      }
      update();
    }

    // Division: add groups numerically until dividend is exhausted
    function divisionNumericDemo(dividend, groupSize, groupsNeeded){
      const area=$('#interactiveContent'), info=$('#interactiveInstructions');
      area.innerHTML='';
      let groups=0, remaining=dividend;

      const remBox=document.createElement('div');
      remBox.className='text-xl font-bold text-purple-700';
      const groupsBox=document.createElement('div');
      groupsBox.className='text-xl font-bold text-purple-700';
      const bigRes=document.createElement('div');
      bigRes.className='text-2xl font-extrabold text-gray-900 ltr tabular-nums mt-1 text-center';

      const top=document.createElement('div');
      top.className='grid grid-cols-1 sm:grid-cols-2 gap-3 items-start justify-center mb-2';
      top.appendChild(remBox); top.appendChild(groupsBox); area.appendChild(top); area.appendChild(bigRes);

      const steps=stepSetByMagnitude(groupsNeeded);
      const row=document.createElement('div'); row.className='flex flex-wrap gap-3 justify-center my-3';
      steps.forEach(s=> row.appendChild(makeStepButton('+'+s+' ×§×‘×•×¦×•×ª',()=>{
        const canAdd=Math.min(s, Math.floor(remaining/groupSize));
        groups=Math.min(groupsNeeded, groups+canAdd);
        remaining=Math.max(0, remaining - canAdd*groupSize);
        update();
      })));
      row.appendChild(makeStepButton('××™×¤×•×¡',()=>{ groups=0; remaining=dividend; update(); }));
      area.appendChild(row);

      function update(){
        remBox.textContent=`× ×©××¨ ×œ×—×œ×§: ${remaining}`;
        groupsBox.textContent=`×§×‘×•×¦×•×ª: ${groups}/${groupsNeeded} (×›×œ ×§×‘×•×¦×” ${groupSize})`;
        bigRes.textContent=`×—×•×œ×§×•: ${groups*groupSize} ××ª×•×š ${dividend}`;
        if(groups>=groupsNeeded || remaining<=0){
          groups=groupsNeeded; remaining=0;
          info.textContent=`××¢×•×œ×”! ${dividend} Ã· ${groupSize} = ${groupsNeeded} ğŸ‰`;
          info.className='text-green-600 font-bold text-lg';
          markActiveMistakeReviewed();
        }else{
          info.textContent=`×¦×¨×• ×§×‘×•×¦×•×ª ×¢×“ ×©×ª×—×œ×§×• ××ª ×›×œ ×”Ö¾${dividend}`;
          info.className='text-gray-600';
        }
      }
      update();
    }

    // Create numeric interactive demo according to operation
    function createInteractiveDemoNumeric(q){
      const area=$('#interactiveContent'), info=$('#interactiveInstructions');
      area.innerHTML=''; info.className='text-gray-600';

      const {operation,num1,num2,answer}=q;

      if(operation==='addition'){
        // ×œ×‘× ×•×ª ××ª ×”××¡×¤×¨ ×‘×¢×–×¨×ª ×¦×¢×“×™× â€” ××ª×—×™×œ×™× ×-0 ×•×¢×“ ×œ×ª×©×•×‘×”
        numericStepper({start:0, target:answer, allowNegative:true});
        info.textContent=`×‘× ×• ××ª ${answer} ×‘×¢×–×¨×ª ×›×¤×ª×•×¨×™ ××¡×¤×¨×™× (××¤×©×¨ ×’× ×œ×—×–×•×¨ ××—×•×¨×” ×× ×¢×‘×¨×ª×).`;
        return;
      }

      if(operation==='subtraction'){
        // ××ª×—×™×œ×™× ××”××¡×¤×¨ ×”×¨××©×•×Ÿ ×•××’×™×¢×™× ×œ×ª×•×¦××” ×‘×¢×–×¨×ª ×—×™×¡×•×¨/×”×•×¡×¤×”
        numericStepper({start:num1, target:answer, allowNegative:true});
        info.textContent=`×”×ª×—×™×œ×• ×Ö¾${num1} ×•×”×©×ª××©×• ×‘×—×™×¡×•×¨ (×•×× ×¦×¨×™×š ×‘×”×•×¡×¤×”) ×›×“×™ ×œ×”×’×™×¢ ×œÖ¾${answer}.`;
        return;
      }

      if(operation==='multiplication'){
        groupsNumericDemo(num1, num2);
        info.textContent=`×”×•×¡×™×¤×• ×§×‘×•×¦×•×ª ×‘×’×•×“×œ ${num2} ×¢×“ ×©×ª×’×™×¢×• ×œÖ¾${num1} ×§×‘×•×¦×•×ª.`;
        return;
      }

      if(operation==='division'){
        const dividend=num1*num2, size=num2, groupsNeeded=answer;
        divisionNumericDemo(dividend, size, groupsNeeded);
        info.textContent=`×¦×¨×• ×§×‘×•×¦×•×ª ×©×œ ${size} ×¢×“ ×©×ª×—×œ×§×• ××ª ×›×œ ×”Ö¾${dividend}.`;
        return;
      }
    }

    /* ========= Why-tip ========= */
    function getWhyTip(m){
      const {operation,num1,num2,answer}=m.question; const ua=m.userAnswer;
      if(operation==='addition'){
        if(ua===num1-num2) return '× ×¨××” ×©×—×™×¡×¨×ª ×‘××§×•× ×œ×—×‘×¨.';
        return '×”×©×ª××©/×™ ×‘×¦×¢×“×™× ×’×“×•×œ×™× (+10/â€+5) ×•××– ×œ×“×™×™×§ ×¢× +1.';
      }
      if(operation==='subtraction'){
        if(ua===num1+num2) return '× ×¨××” ×©×—×™×‘×¨×ª ×‘××§×•× ×œ×—×¡×¨.';
        return '×”×ª×—×œ/×™ ×Ö¾'+num1+' ×•×—×¡×¨/×™ ×‘×¦×¢×“×™× ×’×“×•×œ×™× (âˆ’10/â€âˆ’5) ×•××– ×“×™×™×§/×™ ×¢× âˆ’1.';
      }
      if(operation==='multiplication'){
        if(ua===num1+num2) return '×›×¤×œ ×”×•× ×§×‘×•×¦×•×ª ×©×•×•×ª, ×œ× ×—×™×‘×•×¨ ×—×“Ö¾×¤×¢××™.';
        return '×”×•×¡×™×¤×• ×§×‘×•×¦×•×ª (×œ× ×¤×¨×™×˜×™×) ×¢×“ ×©××¡×¤×¨ ×”×§×‘×•×¦×•×ª ×©×•×•×” ×œÖ¾'+num1+'.';
      }
      if(operation==='division'){
        return '×¦×¨×• ×§×‘×•×¦×•×ª ×©×•×•×ª ×•×”×¤×¡×™×§×• ×›×©××™×Ÿ ××” ×œ×—×œ×§ â€” ××¡×¤×¨ ×”×§×‘×•×¦×•×ª ×”×•× ×”×ª×©×•×‘×”.';
      }
      return '';
    }

    /* ========= Answers grid ========= */
    function bindAnswerGrid(){
      const grid=$('#answersGrid'); if(!grid) return;
      grid.addEventListener('click',e=>{
        const item=e.target.closest('.answer-item'); if(!item||!grid.contains(item)) return;
        unlockAudioOnce(); chooseItem(item);
      });
      grid.addEventListener('keydown',e=>{
        const item=e.target.closest('.answer-item'); if(!item||!grid.contains(item)) return;
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); unlockAudioOnce(); chooseItem(item); }
      });
      function chooseItem(item){
        $$('#answersGrid .answer-item').forEach(it=>{ it.classList.remove('selected'); it.setAttribute('aria-selected','false'); });
        item.classList.add('selected'); item.setAttribute('aria-selected','true');
        selectedAnswer=parseInt(item.getAttribute('data-value'),10);
        enableConfirm(); playSelectTick();
      }
    }

    /* ========= Confetti ========= */
    function confettiBurst(container){
      try{ if(window.matchMedia&&window.matchMedia('(prefers-reduced-motion: reduce)').matches) return; }catch{}
      const n=28; for(let i=0;i<n;i++){
        const dot=document.createElement('span');
        dot.style.position='absolute'; dot.style.width='8px'; dot.style.height='8px'; dot.style.borderRadius='50%';
        dot.style.left='50%'; dot.style.top='10%';
        const colors=['#22c55e','#3b82f6','#f59e0b','#ef4444','#a855f7']; dot.style.background=colors[i%colors.length];
        const angle=(i/n)*Math.PI*2, dist=80+Math.random()*50, tx=Math.cos(angle)*dist, ty=Math.sin(angle)*dist;
        const anim=dot.animate([{transform:'translate(-50%,-50%) scale(1)',opacity:1},{transform:'translate('+(tx-50)+'%,'+(ty-50)+'%) scale(.9)',opacity:0}],{duration:900,easing:'cubic-bezier(.2,.8,.2,1)'});
        anim.onfinish=()=>dot.remove();
        (container||document.body).appendChild(dot);
      }
    }

    /* ========= Selection helpers ========= */
    function selectChoice(containerSel,itemSel,onChange){
      const cont=$(containerSel); if(!cont) return;
      cont.addEventListener('click',e=>{
        const btn=e.target.closest(itemSel); if(!btn||!cont.contains(btn)) return;
        $$(containerSel+' '+itemSel).forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
        btn.classList.add('selected'); btn.setAttribute('aria-pressed','true');
        onChange && onChange(btn);
      });
      cont.addEventListener('keydown',e=>{
        const btn=e.target.closest(itemSel); if(!btn||!cont.contains(btn)) return;
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); btn.click(); }
      });
    }
    function updateOperationNextState(){
      const nextBtn=$('#operationNext'); const enabled=!!currentOperation && !!questionCount;
      nextBtn.disabled=!enabled; nextBtn.setAttribute('aria-disabled', enabled?'false':'true');
    }

    /* ========= Profile ========= */
    function showProfile(){ showScreen('profileScreen'); renderProfile(); focusTop('#profileScreen .text-indigo-600'); updateStatus(''); }
    function setSwitchBtnDisabled(disabled){ const btn=$('#profileSwitchBtn'); if(!btn) return; btn.disabled=disabled; btn.classList.toggle('btn-disabled', disabled); }
    function renderProfile(){
      const prof=getActiveProfile(); const header=$('#profileHeader'); const totalUsers=profilesArr().length;
      setSwitchBtnDisabled(totalUsers<=1);
      if(!prof){
        header.textContent='××™×Ÿ ××©×ª××© ×¤×¢×™×œ. × ×™×ª×Ÿ ×œ×™×¦×•×¨ ××©×ª××© ×—×“×© ××• ×œ×”×—×œ×™×£ ×œ××©×ª××© ×§×™×™×.';
        $('#kpiSets').textContent='0'; $('#kpiAccuracy').textContent='0%'; $('#kpiAvg').textContent='0s';
        $('#byOpGrid').innerHTML=''; $('#historyList').innerHTML='<div class="p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×¡×˜×™× ×¢×“×™×™×Ÿ.</div>';
        return;
      }
      header.innerHTML=`××©×ª××© ×¤×¢×™×œ: <span class="font-bold text-gray-900">${prof.name}</span>`;
      const tot=prof.totals||{sets:0,questions:0,correct:0,timeSec:0};
      const acc=tot.questions>0?Math.round((tot.correct/tot.questions)*100):0;
      const avg=tot.questions>0?Math.round(tot.timeSec/tot.questions):0;
      $('#kpiSets').textContent=String(tot.sets||0);
      $('#kpiAccuracy').textContent=acc+'%';
      $('#kpiAvg').textContent=(avg||0)+'s';

      const ops=['addition','subtraction','multiplication','division','mixed'];
      const labels={addition:'â• ×—×™×‘×•×¨', subtraction:'â– ×—×™×¡×•×¨', multiplication:'âœ–ï¸ ×›×¤×œ', division:'â— ×—×™×œ×•×§', mixed:'ğŸ² ×”×›×œ'};
      const grid=$('#byOpGrid'); grid.innerHTML='';
      ops.forEach(op=>{
        const b=prof.byOp?.[op]; const s=b?.sets||0, q=b?.questions||0, c=b?.correct||0, a=q?Math.round(c/q*100):0;
        const card=document.createElement('div');
        card.className='p-4 rounded-2xl border-2 border-gray-200 bg-gray-50';
        card.innerHTML=`<div class="font-bold mb-2">${labels[op]}</div>
          <div class="text-sm text-gray-600 mb-1">×¡×˜×™×: <span class="ltr">${s}</span></div>
          <div class="text-sm text-gray-600 mb-1">×“×™×•×§: <span class="ltr">${a}%</span></div>
          <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div style="width:${a}%" class="h-2 bg-blue-500"></div></div>`;
        grid.appendChild(card);
      });

      const h=prof.history||[]; const list=$('#historyList'); list.innerHTML='';
      if(h.length===0){
        list.innerHTML='<div class="p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×¡×˜×™× ×¢×“×™×™×Ÿ.</div>';
      }else{
        h.slice(0,12).forEach(item=>{
          const pct=Math.round((item.correct/item.count)*100);
          const row=document.createElement('div');
          row.className='p-3 border-2 border-gray-200 rounded-xl bg-white flex items-center justify-between gap-3';
          const date=new Date(item.ts).toLocaleString('he-IL',{dateStyle:'short', timeStyle:'short'});
          row.innerHTML=`<div>
              <div class="text-sm text-gray-500">${date}</div>
              <div class="text-gray-800">${(curricula[item.curriculum]?.name)||'×œ×œ× ×ª×•×›× ×™×ª'} Â· ${item.op==='mixed'?'×”×›×œ':labels[item.op]?.replace(/^[^ ]+ /,'')}</div>
              <div class="text-sm text-gray-500">×¨××”: ${item.diff} Â· ×©××œ×•×ª: ${item.count}</div>
            </div>
            <div class="text-right">
              <div class="text-xl font-extrabold ${pct===100?'text-green-600': pct>=60?'text-blue-600':'text-orange-600'} ltr">${pct}%</div>
              <div class="text-sm text-gray-500">×˜×¢×•×™×•×ª: ${item.mistakesCount}</div>
            </div>`;
          list.appendChild(row);
        });
      }
    }

    /* ========= Wiring ========= */
    function selectChoice(containerSel,itemSel,onChange){ /* already defined above; kept for clarity */ }

    function bindNavigationAndActions(){
      // First user gesture unlocks audio
      window.addEventListener('touchstart', unlockAudioOnce, { once:true, passive:true });
      window.addEventListener('touchend',   unlockAudioOnce, { once:true, passive:true });
      window.addEventListener('pointerdown',unlockAudioOnce, { once:true, capture:true });
      window.addEventListener('click',      unlockAudioOnce, { once:true, capture:true });

      // Welcome â†’ Name
      $('#startBtn')?.addEventListener('click', e=>{ e.preventDefault(); unlockAudioOnce(); showNameInput(); });

      // Name form
      $('#nameForm')?.addEventListener('submit', e=>{ e.preventDefault(); unlockAudioOnce(); showCurriculumSelect(); });

      // Switch / Profile from name
      $('#profileOrSwitchBtn')?.addEventListener('click',()=>{ const arr=profilesArr(); if(arr.length>1) showUserPicker(); else showProfile(); });

      // Modal
      $('#userPickerCancel')?.addEventListener('click',()=> $('#userPickerModal').classList.add('hidden'));
      $('#newUserBtn')?.addEventListener('click',()=>{ $('#userPickerModal').classList.add('hidden'); $('#playerName').value=''; $('#playerName').focus(); });

      // Global profile buttons
      $('#profileBtn')?.addEventListener('click',()=> showProfile());
      $('#profileFromResultsBtn')?.addEventListener('click',()=> showProfile());
      $('#profileSwitchBtn')?.addEventListener('click',()=>{ if(profilesArr().length>1) showUserPicker(); });
      $('#profileNewBtn')?.addEventListener('click',()=>{ store.activeId=null; saveStore(); showNameInput(); });
      $('#profileStartBtn')?.addEventListener('click',()=>{
        const prof=getActiveProfile(); if(!prof){ showNameInput(); return; }
        playerName=prof.name; showCurriculumSelect();
      });

      // Curriculum selection
      selectChoice('#curriculumGrid','.choice-card',(btn)=>{ currentCurriculum=btn.getAttribute('data-value'); const next=$('#curriculumNext'); next.disabled=false; next.setAttribute('aria-disabled','false'); });
      $('#curriculumNext')?.addEventListener('click',()=> showOperationSelect());
      $('#curriculumMore')?.addEventListener('click',()=> setCurriculumExpanded(!isCurriculumExpanded));
      window.addEventListener('resize', refreshCurriculumOverflow);

      // Operation selection
      selectChoice('#opsGrid','.op-btn',(btn)=>{ currentOperation=btn.getAttribute('data-op'); updateOperationNextState(); });
      selectChoice('#questionChips','.chip',(chip)=>{ questionCount=parseInt(chip.getAttribute('data-count'),10); updateOperationNextState(); });
      $('#operationNext')?.addEventListener('click',()=> showDifficultySelect());

      // Difficulty â†’ start
      selectChoice('#difficultyScreen','.diff-btn',(btn)=>{ startGame(btn.getAttribute('data-diff')); });

      // Game
      bindAnswerGrid();
      $('#confirmButton')?.addEventListener('click',confirmAnswer);
      $('#restartBtn')?.addEventListener('click',()=> showNameInput());

      // Results
      $('#retryBtn')?.addEventListener('click',()=>{
        if(!currentOperation || !questionCount || !currentDifficulty){ showOperationSelect(); }
        else{ startGame(currentDifficulty); }
      });
      $('#mistakesButton')?.addEventListener('click',()=> showMistakes());
      $('#altBtn')?.addEventListener('click',()=> showOperationSelect());

      // Mistakes & Tutorial
      $('#backToResults')?.addEventListener('click',()=> showResults());
      $('#restartFromMistakes')?.addEventListener('click',()=> showNameInput());
      $('#backToMistakes')?.addEventListener('click',()=> showMistakes());
      $('#restartFromTutorial')?.addEventListener('click',()=> showNameInput());
    }

    function init(){
      storeInit();
      initAudioToggle();
      bindNavigationAndActions();
      showScreen('welcomeScreen');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
