<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>מספרונצ'יק - משחק חשבון לימודי</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');
    body{font-family:'Assistant',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .ltr{direction:ltr;unicode-bidi:embed;display:inline-block}
    .tabular-nums{font-variant-numeric:tabular-nums}
    .owl-blink{animation:blink 2s infinite}
    @keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.1)}}

    .no-focus-outline:focus{outline:none !important; box-shadow:none !important}

    .link-cta{
      display:inline-flex; align-items:center; justify-content:center; gap:.35rem;
      margin:.5rem auto 1rem;
      font-weight:800;
      font-size: calc(1rem + 2px);
      color:#111827;
      text-decoration:underline;
      cursor:pointer;
      background:transparent; border:none; padding:.25rem .5rem; border-radius:.5rem;
    }
    .link-cta:focus{outline:2px solid #93c5fd; outline-offset:2px}

    .subhead{
      font-weight:800;
      font-size:clamp(1.375rem, 1.05rem + 1.2vw, 1.75rem);
      line-height:1.25;
      color:#1f2937;
      letter-spacing:-.01em;
    }

    .answer-item{position:relative;transition:transform .14s,box-shadow .14s,border-color .14s;cursor:pointer;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;background:rgba(255,255,255,.96);border-radius:1rem;border:2px solid transparent;outline:none}
    .answer-item::before{content:"";position:absolute;inset:0;border-radius:inherit;pointer-events:none;background:var(--tint,transparent);opacity:.08}
    .answer-item .accent{display:none;position:absolute;right:0;top:0;bottom:0;width:8px;border-radius:0 1rem 1rem 0;opacity:.55;background:var(--tint);pointer-events:none}
    .answer-item[data-idx="0"]{--tint:#f87171}
    .answer-item[data-idx="1"]{--tint:#60a5fa}
    .answer-item[data-idx="2"]{--tint:#4ade80}
    .answer-item[data-idx="3"]{--tint:#facc15}
    .answer-item:active{transform:scale(.98)}
    .answer-item.selected{border-color:#2563eb;box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .answer-item.selected .accent{display:block}

    .confirm-button{transition:all .25s}
    .confirm-button[disabled]{opacity:.5;cursor:not-allowed}

    .choice-card{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.25rem;
      background:rgba(255,255,255,.96); border:2px solid transparent; border-radius:1.25rem; padding:1.15rem;
      box-shadow:0 10px 26px rgba(0,0,0,.12); transition:.18s; cursor:pointer; outline:none; user-select:none}
    .choice-card .accent{display:none;position:absolute;right:0;top:0;bottom:0;width:8px;border-radius:0 1.25rem 1.25rem 0;opacity:.55;pointer-events:none}
    .choice-card[data-tint="green"]{--tint:#22c55e}
    .choice-card[data-tint="blue"]{--tint:#3b82f6}
    .choice-card[data-tint="purple"]{--tint:#a855f7}
    .choice-card[data-tint="orange"]{--tint:#f59e0b}
    .choice-card[data-tint="pink"]{--tint:#ec4899}
    .choice-card:hover{transform:translateY(-2px)}
    .choice-card:active{transform:scale(.98)}
    .choice-card.selected{border-color:#2563eb; box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .choice-card.selected .accent{display:block; background:var(--tint,#3b82f6)}
    .choice-card .emoji{font-size:2rem}
    .op-btn .emoji{font-size:1.8rem}
    .op-btn .text-xl{font-size:1.1rem}

    .chips{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center}
    .chip{min-width:68px; min-height:52px; display:inline-flex; align-items:center; justify-content:center;
      border:2px solid #e5e7eb; background:white; border-radius:1rem; padding:.3rem .8rem;
      font-weight:800; font-size:1.25rem; cursor:pointer; transition:.16s}
    .chip:hover{transform:translateY(-2px)}
    .chip.selected{border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.20)}

    #floatingControls{
      position:fixed; left:16px; top:16px; z-index:50;
      display:flex; flex-direction:column; gap:10px;
    }
    #audioToggle,#profileBtn{padding:.5rem .7rem;border-radius:9999px;background:rgba(255,255,255,.95);border:1px solid #e5e7eb;box-shadow:0 6px 20px rgba(0,0,0,.12)}
    #audioToggle[aria-pressed="true"] .muted{display:inline}
    #audioToggle[aria-pressed="true"] .unmuted{display:none}
    #audioToggle[aria-pressed="false"] .muted{display:none}
    #audioToggle[aria-pressed="false"] .unmuted{display:inline}

    .btn-disabled{opacity:.5; cursor:not-allowed}

    .site-signature{ text-align:center;color:#6b7280;font-size:.875rem;line-height:1.6; margin-top:1.25rem;margin-bottom:1.25rem }
    @media (min-width:640px){ .site-signature{font-size:1rem;margin-top:2rem;margin-bottom:2rem} }
    .site-signature a{color:#4b5563;text-decoration:underline}
    .site-signature a:hover{color:#111827}

    #curriculumWrapper{position:relative}
    .curriculum-collapsed{max-height:min(45vh, 360px); overflow:hidden;}
    #curriculumFade{
      position:absolute; inset-inline:0; bottom:0; height:64px;
      background:linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,0));
      pointer-events:none;
    }

    @media (prefers-reduced-motion: reduce){ .owl-blink{ animation:none } }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-50 to-green-100 min-h-screen">

  <!-- Floating controls -->
  <div id="floatingControls" aria-label="בקרות מהירות">
    <button id="audioToggle" type="button" aria-label="החלפת מצב צליל" aria-pressed="false" title="הצליל פעיל">
      <span class="unmuted" aria-hidden="true">🔊</span>
      <span class="muted" aria-hidden="true">🔇</span>
    </button>
    <button id="profileBtn" type="button" aria-label="אזור אישי" title="אזור אישי">👤</button>
  </div>

  <!-- Welcome -->
  <div id="welcomeScreen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-6xl mb-4 owl-blink">🦉</div>
      <h1 id="welcomeTitle" tabindex="-1" class="no-focus-outline text-4xl font-bold text-purple-600 mb-4">מספרונצ'יק</h1>
      <p class="text-2xl text-gray-700 mb-8">בואו ללמוד חשבון עם שופי הינשוף</p>
      <button type="button" id="startBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">התחל משחק</button>
    </div>
    <footer class="site-signature px-4">
      <div>© 2025 yaroni studio - תוכן חזק, עובד חכם ומבוסס על בינה</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Name -->
  <div id="nameScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <form id="nameForm" class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-5xl mb-4">👋</div>
      <h2 id="nameTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-blue-600 mb-2">איך קוראים לך?</h2>
      <p id="nameSubtitle" class="text-gray-600 mb-4 hidden"></p>
      <input type="text" id="playerName" name="playerName" required placeholder="הכנס את שמך כאן" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-3 text-center focus:border-blue-500 focus:outline-none">
      <div class="text-center mb-6">
        <button type="button" id="profileOrSwitchBtn" class="link-cta">החלף משתמש / אזור אישי</button>
      </div>
      <button type="submit" class="bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-blue-600 hover:to-green-600 transform hover:scale-105 transition-all duration-200 shadow-lg">המשך</button>
    </form>
  </div>

  <!-- User Picker -->
  <div id="userPickerModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
    <div role="dialog" aria-modal="true" class="bg-white rounded-2xl max-w-md w-full p-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-3">בחרו משתמש</h3>
      <div id="userList" class="space-y-2 max-h-[50vh] overflow-auto mb-4"></div>
      <div class="flex gap-2 justify-between">
        <button id="userPickerCancel" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold">סגור</button>
        <button id="newUserBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">משתמש חדש</button>
      </div>
    </div>
  </div>

  <!-- Curriculum -->
  <div id="curriculumScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-3xl w-full">
      <div class="text-5xl mb-4">📚</div>
      <h2 id="curriculumTitle" tabindex="-1" class="no-focus-outline text-3xl md:text-4xl font-extrabold text-green-600 mb-2 leading-tight">יש לבחור תכנית לימוד</h2>
      <p class="subhead mb-6">בחרו את התכנית המתאימה, ואז לחצו על "המשך"</p>

      <div id="curriculumWrapper" class="relative mb-6">
        <div id="curriculumGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 curriculum-collapsed">
          <button type="button" class="choice-card" data-tint="blue" data-value="none" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">🎯</div>
            <div class="text-xl font-bold text-gray-800">ללא תוכנית</div>
            <div class="text-base text-gray-500">בחירה חופשית</div>
          </button>

          <button type="button" class="choice-card" data-tint="green" data-value="il_g1_s1" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">🌱</div>
            <div class="text-xl font-bold text-gray-800">כיתה א׳, מחצית א׳</div>
            <div class="text-base text-gray-500">עד 10</div>
          </button>

          <button type="button" class="choice-card" data-tint="green" data-value="il_g1_s2" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">🌿</div>
            <div class="text-xl font-bold text-gray-800">כיתה א׳, מחצית ב׳</div>
            <div class="text-base text-gray-500">עד 20</div>
          </button>

          <button type="button" class="choice-card" data-tint="green" data-value="il_g1_adv" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">✨</div>
            <div class="text-xl font-bold text-gray-800">כיתה א׳, אתגר</div>
            <div class="text-base text-gray-500">עד 30</div>
          </button>

          <button type="button" class="choice-card" data-tint="blue" data-value="il_g2" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">🧩</div>
            <div class="text-xl font-bold text-gray-800">כיתה ב׳</div>
            <div class="text-base text-gray-500">עד 100</div>
          </button>

          <button type="button" class="choice-card" data-tint="purple" data-value="il_g3" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">✖️</div>
            <div class="text-xl font-bold text-gray-800">כיתה ג׳</div>
            <div class="text-base text-gray-500">עד 100; כפל/חילוק 10×10</div>
          </button>

          <button type="button" class="choice-card" data-tint="orange" data-value="il_g4" aria-pressed="false">
            <span class="accent" aria-hidden="true"></span>
            <div class="emoji">🚀</div>
            <div class="text-xl font-bold text-gray-800">כיתה ד׳</div>
            <div class="text-base text-gray-500">עד 1000; כפל/חילוק 12×12</div>
          </button>
        </div>
        <div id="curriculumFade" class="hidden"></div>
      </div>

      <div class="flex items-center justify-center gap-3 flex-wrap">
        <button id="curriculumMore" type="button" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold hidden" aria-expanded="false">הצג עוד</button>
        <button id="curriculumNext" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50" disabled aria-disabled="true">המשך</button>
      </div>
    </div>
  </div>

  <!-- Operation + Count -->
  <div id="operationScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-3xl w-full">
      <div class="text-5xl mb-4">🎯</div>
      <h2 id="operationTitle" tabindex="-1" class="no-focus-outline text-3xl md:text-4xl font-extrabold text-green-600 mb-2 leading-tight">עכשיו יש לבחור את סוג התרגילים</h2>
      <h3 class="subhead mb-6">בחרו סוג תרגיל ומספר שאלות</h3>

      <div id="opsGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8">
        <button type="button" data-op="addition" class="choice-card op-btn" data-tint="green" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">➕</div>
          <div class="text-xl font-bold">חיבור</div>
        </button>
        <button type="button" data-op="subtraction" class="choice-card op-btn" data-tint="pink" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">➖</div>
          <div class="text-xl font-bold">חיסור</div>
        </button>
        <button type="button" data-op="multiplication" class="choice-card op-btn" data-tint="purple" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">✖️</div>
          <div class="text-xl font-bold">כפל</div>
        </button>
        <button type="button" data-op="division" class="choice-card op-btn" data-tint="orange" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">➗</div>
          <div class="text-xl font-bold">חילוק</div>
        </button>
        <button type="button" data-op="mixed" class="choice-card op-btn col-span-2 sm:col-span-1" data-tint="blue" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">🎲</div>
          <div class="text-xl font-bold">הכל</div>
        </button>
      </div>

      <div class="mb-2">
        <div class="subhead mb-3 text-center">מספר שאלות בסט</div>
        <div id="questionChips" class="chips">
          <button type="button" class="chip" data-count="6" aria-pressed="false">6</button>
          <button type="button" class="chip" data-count="8" aria-pressed="false">8</button>
          <button type="button" class="chip" data-count="10" aria-pressed="false">10</button>
        </div>
      </div>

      <div class="mt-6">
        <button id="operationNext" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50" disabled aria-disabled="true">המשך</button>
      </div>
    </div>
  </div>

  <!-- Difficulty -->
  <div id="difficultyScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
      <div class="text-5xl mb-4">⚡</div>
      <h2 id="difficultyTitle" tabindex="-1" class="no-focus-outline text-3כ sm:text-4xl font-bold text-blue-600 mb-6">איזו רמת קושי מתאימה לך היום?</h2>

      <div class="flex flex-col gap-4 mb-2">
        <button type="button" data-diff="easy" class="choice-card diff-btn" data-tint="green" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">🌱</div>
          <div class="text-xl font-bold">קל</div>
        </button>
        <button type="button" data-diff="medium" class="choice-card diff-btn" data-tint="orange" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">🔥</div>
          <div class="text-xl font-bold">בינוני</div>
        </button>
        <button type="button" data-diff="hard" class="choice-card diff-btn" data-tint="purple" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">⚡</div>
          <div class="text-xl font-bold">מתקדם</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Game -->
  <div id="gameScreen" class="hidden min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6 mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-4">
        <div class="text-2xl font-bold text-purple-600">שאלה <span id="currentQuestion" class="ltr">1</span> מתוך <span id="totalQuestions" class="ltr">6</span></div>
        <div class="text-xl text-gray-600">שלום <span id="gamePlayerName"></span>! 👋</div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4" aria-hidden="true">
        <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width: 0%"></div>
      </div>
      <div id="statusMsg" class="sr-only" aria-live="polite"></div>
    </div>

    <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 mx-auto max-w-lg text-center">
      <div class="text-5xl mb-4 owl-blink">🦉</div>
      <div id="questionText" tabindex="-1" class="no-focus-outline text-3xl font-bold text-gray-800 mb-6 ltr">5 + 3 = ?</div>
      <div class="subhead text-gray-700 mb-4">יש לבחור את התשובה הנכונה</div>
    </div>

    <div id="answersGrid" class="grid grid-cols-2 gap-4 max-w-lg mx-auto px-4 mb-6">
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="6" data-idx="0" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">6</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="8" data-idx="1" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">8</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="7" data-idx="2" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">7</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="5" data-idx="3" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">5</div>
      </div>
    </div>

    <div class="text-center space-y-4 pb-6">
      <button id="confirmButton" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold transition-all duration-200 shadow-lg" disabled aria-disabled="true">אשר תשובה</button>
      <button type="button" id="restartBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
    </div>

    <!-- Feedback -->
    <div id="feedback" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div role="dialog" aria-modal="true" aria-labelledby="feedbackText" class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
        <div id="feedbackIcon" class="text-8xl mb-4">🎉</div>
        <div id="feedbackText" aria-live="polite" class="text-2xl font-bold mb-6">כל הכבוד!</div>
        <button id="nextButton" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">לסיכום התוצאות</button>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div id="resultsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full relative overflow-hidden">
      <div class="text-8xl mb-4">🏆</div>
      <h2 id="resultsTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-green-600 mb-4">כל הכבוד!</h2>
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">הביצועים שלך:</span>
          <span id="performancePercentage" class="text-sm font-bold text-blue-600 ltr">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div id="performanceBar" class="h-6 rounded-full transition-all duration-1000 flex" aria-label="Progress indicator">
            <div id="correctBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
            <div id="incorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <span class="text-green-600 font-medium">✓ נכונות: <span id="correctCount" class="ltr">0</span></span>
          <span class="text-orange-600 font-medium">✗ שגויות: <span id="incorrectCount" class="ltr">0</span></span>
        </div>
      </div>
      <div class="text-xl text-gray-700 mb-6">
        <div id="performanceMessage" class="mb-4 font-medium text-lg">סיימת את הסט! 🎯</div>
        <div class="mb-2">תשובות נכונות: <span id="correctAnswers" class="font-bold text-green-600 ltr">0</span>/<span id="resultsTotal" class="ltr">6</span></div>
        <div class="mb-4">זמן ממוצע: <span id="averageTime" class="font-bold text-blue-600 ltr">0</span> שניות</div>
      </div>
      <div class="flex flex-col gap-4">
        <button id="retryBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">אני רוצה לתרגל מחדש</button>
        <button id="mistakesButton" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">ללמוד מהטעויות</button>
        <button id="altBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">בא לי תרגול אחר</button>
        <button id="profileFromResultsBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">אזור אישי</button>
      </div>
    </div>
    <footer class="site-signature px-4">
      <div>© 2025 yaroni studio - תוכן חזק, עובד חכם ומבוסס על בינה</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Mistakes -->
  <div id="mistakesScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">📚</div>
        <h2 id="mistakesTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-orange-600 mb-4">למד מהטעויות</h2>
        <div class="mb-6 max-w-md mx-auto">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mb-3">
            <div id="mistakesPerformanceBar" class="h-4 rounded-full transition-all duration-1000 flex" aria-label="Performance summary">
              <div id="mistakesCorrectBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
              <div id="mistakesIncorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>
          <div id="mistakesMessage" class="subhead text-gray-700 mb-4">הנה התרגילים שבהם טעית</div>
        </div>
        <p class="text-lg text-gray-600">לחץ על כל תרגיל כדי ללמוד איך לפתור אותו:</p>
      </div>
      <div id="mistakesList" class="space-y-6 mb-8"></div>
      <div class="text-center space-y-4">
        <button id="backToResults" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">חזור לתוצאות</button>
        <button type="button" id="restartFromMistakes" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
      </div>
    </div>
  </div>

  <!-- Tutorial -->
  <div id="tutorialScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">🎓</div>
        <h2 id="tutorialTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-blue-600 mb-4 ltr">7 ÷ 5 = ?</h2>
        <p class="text-lg text-gray-600">בואו נלמד יחד איך לפתור את השאלה הזו!</p>
      </div>
      <div id="tutorialSteps" class="space-y-8 mb-8"></div>

      <div id="interactiveArea" class="bg-blue-50 rounded-2xl p-6 mb-8 text-center">
        <h3 class="subhead text-blue-600 mb-4">נסה בעצמך!</h3>
        <div id="interactiveContent" class="flex flex-col items-center justify-center gap-3 mb-4"></div>
        <div id="interactiveInstructions" role="status" aria-live="polite" class="text-gray-600">השתמש/י בכפתורים כדי להגיע לתוצאה</div>
      </div>

      <div class="flex justify-center gap-4 flex-wrap">
        <button id="backToMistakes" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">חזור לרשימת הטעויות</button>
        <button type="button" id="restartFromTutorial" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
      </div>
    </div>
  </div>

  <!-- Profile -->
  <div id="profileScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
        <h2 class="text-3xl font-bold text-indigo-600">האזור האישי</h2>
        <div class="flex gap-2">
          <button id="profileStartBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700">התחל משחק</button>
          <button id="profileSwitchBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">החלף משתמש</button>
          <button id="profileNewBtn" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold">משתמש חדש</button>
        </div>
      </div>

      <div id="profileHeader" class="mb-6 text-lg text-gray-700"></div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="p-4 rounded-2xl border-2 border-green-200 bg-green-50">
          <div class="text-sm text-green-700">סטים שבוצעו</div>
          <div id="kpiSets" class="text-3xl font-extrabold text-gray-900 ltr">0</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-blue-200 bg-blue-50">
          <div class="text-sm text-blue-700">דיוק מצטבר</div>
          <div id="kpiAccuracy" class="text-3xl font-extrabold text-gray-900 ltr">0%</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-purple-200 bg-purple-50">
          <div class="text-sm text-purple-700">זמן ממוצע לשאלה</div>
          <div id="kpiAvg" class="text-3xl font-extrabold text-gray-900 ltr">0s</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="byOpGrid"></div>

      <div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">היסטוריית סטים</h3>
        <div id="historyList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
    /* ========= State ========= */
    let currentOperation=null, currentDifficulty='easy', currentQuestionIndex=0;
    let correctCount=0, totalQuestions=6, questions=[], mistakes=[];
    let startTime=0, totalTime=0, playerName='', selectedAnswer=null;
    let questionCount=null, currentCurriculum=null;
    let activeMistake=null;

    // לשחזור פוקוס אחרי מודלים/דיאלוגים
    let lastFocusEl = null;

    /* ========= Store ========= */
    const STORE_KEY='mspr_profiles_v1';
    let store=null; let memOnly=false;

    function uuid(){
      return 'xxxxxxxyxxxx'.replace(/[xy]/g, c=>{
        const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8);
        return v.toString(16);
      });
    }

    function storeInit(){
      try{ store = JSON.parse(localStorage.getItem(STORE_KEY)||'null'); }
      catch{ store=null; memOnly=true; }
      if(!store){
        store = { version:1, installedAt:Date.now(), activeId:null, profiles:{} };
        try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; }
      }
    }
    function saveStore(){ if(memOnly) return; try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; } }
    function profilesArr(){ return Object.entries(store.profiles).map(([id,p])=>({id,...p})); }
    function getActiveProfile(){ return store.activeId ? store.profiles[store.activeId]||null : null; }
    function setActiveProfile(id){ if(!store.profiles[id]) return; store.activeId=id; store.profiles[id].lastSeen=Date.now(); saveStore(); }
    function ensureProfileByName(name){
      const norm=(name||'').trim(); if(!norm) return null;
      const existing=profilesArr().find(p=>p.name.trim()===norm);
      if(existing){ setActiveProfile(existing.id); return existing; }
      const id=uuid();
      store.profiles[id]={ name:norm, createdAt:Date.now(), lastSeen:Date.now(),
        totals:{sets:0,questions:0,correct:0,timeSec:0}, byOp:{}, history:[] };
      setActiveProfile(id);
      return {id, ...store.profiles[id]};
    }

    function logSessionToProfile(){
      const prof=getActiveProfile(); if(!prof) return;
      const entry={ id:uuid(), ts:Date.now(), curriculum:currentCurriculum, op:currentOperation, diff:currentDifficulty,
        count:totalQuestions, correct:correctCount, avgSec:Math.max(1,Math.round(totalTime/Math.max(1,totalQuestions))),
        mistakesCount:mistakes.length };
      prof.history.unshift(entry); if(prof.history.length>100) prof.history.pop();

      prof.totals.sets+=1; prof.totals.questions+=totalQuestions; prof.totals.correct+=correctCount; prof.totals.timeSec+=Math.round(totalTime);

      const bucket=currentOperation||'mixed';
      if(!prof.byOp[bucket]) prof.byOp[bucket]={sets:0,questions:0,correct:0,timeSec:0};
      prof.byOp[bucket].sets+=1; prof.byOp[bucket].questions+=totalQuestions; prof.byOp[bucket].correct+=correctCount; prof.byOp[bucket].timeSec+=Math.round(totalTime);
      saveStore();
    }

    /* ========= Rules ========= */
    const rulesByDifficulty={
      easy:{addSubMax:20,mulMax:5,divMaxDivisor:5,divMaxQuotient:5},
      medium:{addSubMax:100,mulMax:10,divMaxDivisor:10,divMaxQuotient:10},
      hard:{addSubMax:1000,mulMax:12,divMaxDivisor:12,divMaxQuotient:12}
    };
    const curricula={
      none:{name:'ללא תוכנית'},
      il_g1_s1:{name:'כיתה א׳, מחצית ראשונה',operations:['addition','subtraction'],addSubMax:10},
      il_g1_s2:{name:'כיתה א׳, מחצית שנייה',operations:['addition','subtraction'],addSubMax:20},
      il_g1_adv:{name:'כיתה א׳, אתגר',operations:['addition','subtraction'],addSubMax:30},
      il_g2:{name:'כיתה ב׳',operations:['addition','subtraction'],addSubMax:100},
      il_g3:{name:'כיתה ג׳',operations:['addition','subtraction','multiplication','division'],addSubMax:100,mulMax:10,divMaxDivisor:10,divMaxQuotient:10},
      il_g4:{name:'כיתה ד׳',operations:['addition','subtraction','multiplication','division'],addSubMax:1000,mulMax:12,divMaxDivisor:12,divMaxQuotient:12}
    };

    /* ========= Helpers ========= */
    const $=sel=>document.querySelector(sel);
    const $$=sel=>document.querySelectorAll(sel);
    const randInt=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    function shuffle(a){const c=a.slice();for(let i=c.length-1;i>0;i++){const j=Math.floor(Math.random()*(i+1));[c[i],c[j]]=[c[j],c[i]]}return c}
    function focusTop(selector){
      const el=typeof selector==='string'?document.querySelector(selector):selector;
      const target=el||document.body;
      if(target && !target.hasAttribute('tabindex')) target.setAttribute('tabindex','-1');
      requestAnimationFrame(()=>{
        window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
        try{ target && target.focus({preventScroll:true}); }catch{}
      });
    }
    function updateStatus(msg){ const el=$('#statusMsg'); if(el) el.textContent=msg||''; }
    function showCoach(msg){ updateStatus(msg); }
    function hideCoach(){}
    function placeCoach(){}

    /* ========= Audio ========= */
    let isMuted=false, audioCtx=null, audioUnlocked=false;
    function getAudioCtx(){ if(isMuted) return null; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null; if(!audioCtx) audioCtx=new AC(); if(audioCtx.state!=='running'&&audioCtx.resume){ try{ audioCtx.resume(); }catch{} } return audioCtx; }
    function unlockAudioOnce(){ if(audioUnlocked||isMuted) return; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return; if(!audioCtx) audioCtx=new AC(); try{ const p=audioCtx.resume&&audioCtx.resume(); if(p&&p.catch) p.catch(()=>{}); }catch{} try{ const buffer=audioCtx.createBuffer(1,1,audioCtx.sampleRate); const src=audioCtx.createBufferSource(); const gain=audioCtx.createGain(); gain.gain.value=0.0001; src.buffer=buffer; src.connect(gain); gain.connect(audioCtx.destination); src.start(0); setTimeout(()=>{ try{ src.disconnect(); gain.disconnect(); }catch{} audioUnlocked=true; },0); }catch{ try{ const t=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain(); g.gain.setValueAtTime(0.0001,t); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.02); audioUnlocked=true; }catch{} } }
    function ensureUnlocked(){ const ctx=getAudioCtx(); if(!ctx) return; if(!audioUnlocked) unlockAudioOnce(); }
    function tone(freq,dur,t,type='sine',gain=0.24){ if(isMuted) return; ensureUnlocked(); const ctx=getAudioCtx(); if(!ctx) return; const start=typeof t==='number'?t:ctx.currentTime; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,start); g.gain.setValueAtTime(gain,start); g.gain.exponentialRampToValueAtTime(0.001,start+dur); o.connect(g); g.connect(ctx.destination); try{ o.start(start); o.stop(start+dur); }catch{} }
    function playSelectTick(){ const ctx=getAudioCtx(); if(!ctx){ ensureUnlocked(); return; } const t=ctx.currentTime; tone(520,0.10,t,'triangle',0.24); }
    function playSuccessSound(){ const ctx=getAudioCtx(); if(!ctx){ ensureUnlocked(); return; } const t=ctx.currentTime; tone(523.25,0.12,t,'sine',0.22); tone(659.25,0.12,t+0.1,'sine',0.20); tone(783.99,0.14,t+0.2,'sine',0.18); }
    function playErrorSound(){ const ctx=getAudioCtx(); if(!ctx){ ensureUnlocked(); return; } const t=ctx.currentTime; tone(220,0.12,t,'square',0.20); tone(180,0.12,t+0.1,'square',0.18); }
    function initAudioToggle(){
      const btn=$('#audioToggle'); if(!btn) return;
      try{ isMuted=localStorage.getItem('soundMuted')==='true'; }catch{ isMuted=false; }
      btn.setAttribute('aria-pressed', isMuted?'true':'false');
      btn.addEventListener('click',()=>{ isMuted=!isMuted; btn.setAttribute('aria-pressed', isMuted?'true':'false'); try{ localStorage.setItem('soundMuted', String(isMuted)); }catch{} if(!isMuted) unlockAudioOnce(); });
    }
    document.addEventListener('click',e=>{
      const el=e.target.closest('button,.op-btn,.choice-card,.chip,.link-cta');
      if(!el||el.id==='audioToggle') return;
      const wasLocked=!audioUnlocked; unlockAudioOnce();
      if(el.disabled||el.getAttribute('aria-disabled')==='true') return;
      if(wasLocked) setTimeout(playSelectTick,0); else playSelectTick();
    });
    document.addEventListener('keydown',e=>{
      if((e.key==='Enter'||e.key===' ') && document.activeElement?.closest('button,.op-btn,.choice-card,.chip,.link-cta')) playSelectTick();
    });

    /* ========= Screens ========= */
    const SCREENS=['welcomeScreen','nameScreen','curriculumScreen','operationScreen','difficultyScreen','gameScreen','resultsScreen','mistakesScreen','tutorialScreen','profileScreen'];
    function showScreen(id){
      SCREENS.forEach(s=>$('#'+s)?.classList.add('hidden'));
      $('#'+id)?.classList.remove('hidden');
      window.scrollTo({top:0,left:0,behavior:'auto'});
    }

    /* ========= Curriculum gating ========= */
    function applyCurriculumToOperationButtons(){
      const cur=curricula[currentCurriculum]; const allowed=cur&&cur.operations?cur.operations:null;
      $$('#opsGrid .op-btn').forEach(btn=>{
        const op=btn.getAttribute('data-op');
        const enabled=!allowed || op==='mixed' || allowed.includes(op);
        btn.classList.toggle('opacity-50',!enabled);
        btn.classList.toggle('pointer-events-none',!enabled);
        btn.classList.toggle('cursor-not-allowed',!enabled);
        btn.setAttribute('aria-disabled', enabled?'false':'true');
        if(!enabled && btn.classList.contains('selected')){
          btn.classList.remove('selected'); btn.setAttribute('aria-pressed','false');
          if(currentOperation===op) currentOperation=null;
        }
      });
      updateOperationNextState();
    }

    /* ========= Curriculum overflow ========= */
    let isCurriculumExpanded=false;
    function refreshCurriculumOverflow(){
      const grid=$('#curriculumGrid'), more=$('#curriculumMore'), fade=$('#curriculumFade');
      if(!grid||!more||!fade) return;
      const overflow=grid.scrollHeight>grid.clientHeight+2;
      more.classList.toggle('hidden', !overflow && !isCurriculumExpanded);
      fade.classList.toggle('hidden', isCurriculumExpanded || !overflow);
    }
    function setCurriculumExpanded(expanded){
      isCurriculumExpanded=!!expanded;
      const grid=$('#curriculumGrid'), more=$('#curriculumMore'); if(!grid||!more) return;
      grid.classList.toggle('curriculum-collapsed', !isCurriculumExpanded);
      more.textContent=isCurriculumExpanded?'הצג פחות':'הצג עוד';
      more.setAttribute('aria-expanded', isCurriculumExpanded?'true':'false');
      refreshCurriculumOverflow();
    }

    /* ========= Selection helper ========= */
    function selectChoice(containerSel,itemSel,onChange){
      const cont=$(containerSel); if(!cont) return;
      cont.addEventListener('click', e=>{
        const btn=e.target.closest(itemSel); if(!btn||!cont.contains(btn)) return;
        $$(containerSel+' '+itemSel).forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
        btn.classList.add('selected'); btn.setAttribute('aria-pressed','true');
        onChange && onChange(btn);
      });
      cont.addEventListener('keydown', e=>{
        const btn=e.target.closest(itemSel); if(!btn||!cont.contains(btn)) return;
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); btn.click(); }
      });
    }

    /* ========= Questions ========= */
    function getEffectiveRules(diff){
      const base=Object.assign({},rulesByDifficulty[diff]);
      const cur=curricula[currentCurriculum]||{};
      ['addSubMax','mulMax','divMaxDivisor','divMaxQuotient'].forEach(k=>{ if(typeof cur[k]!=='undefined') base[k]=cur[k]; });
      return base;
    }
    function getOpsList(selectedOp,cur){ if(selectedOp!=='mixed') return [selectedOp]; const allowed=cur&&cur.operations?cur.operations:null; return (allowed&&allowed.length)?allowed:['addition','subtraction','multiplication','division']; }
    function buildOpPool(op,rules,targetSize,diff){
      const pool=[]; let tries=0, max=6000;
      const mk=(text,ans,op,a,b,sym)=>({ id:`${op}:${a}${sym}${b}`, questionText:text, answer:ans, operation:op, num1:a, num
