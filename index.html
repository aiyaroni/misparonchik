<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>מספרונצ'יק - משחק חשבון לימודי</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');
    :root { color-scheme: light; }
    body { font-family: 'Assistant', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .ltr { direction: ltr; unicode-bidi: embed; display: inline-block; }

    /* ===== Answer cards ===== */
    .answer-item {
      position: relative;
      transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease;
      cursor: pointer;
      user-select: none; -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .answer-item:active, .answer-item.pressed { transform: scale(0.98); }
    /* selected state – single clear cue, no green/red during game */
    .answer-item.selected {
      border: 3px solid #2563eb; /* blue-600 */
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    }
    /* focus ring for keyboard */
    .answer-item:focus-visible {
      outline: none;
      box-shadow: 0 0 0 4px rgba(59,130,246,0.45);
    }
    /* thin decorative accent (not critical for meaning) */
    .answer-item .accent {
      position: absolute; left: 0; top: 0; bottom: 0; width: 8px; border-radius: 1rem 0 0 1rem; opacity: .55;
    }
    .answer-item[data-idx="0"] .accent { background: linear-gradient(#fca5a5,#f87171); }
    .answer-item[data-idx="1"] .accent { background: linear-gradient(#93c5fd,#60a5fa); }
    .answer-item[data-idx="2"] .accent { background: linear-gradient(#86efac,#4ade80); }
    .answer-item[data-idx="3"] .accent { background: linear-gradient(#fde68a,#facc15); }

    /* prefers-reduced-motion: no decorative motion */
    @media (prefers-reduced-motion: reduce) {
      .answer-item { transition: none !important; }
    }

    .owl-blink { animation: blink 2s infinite; }
    @keyframes blink { 0%, 90%, 100% { transform: scaleY(1) } 95% { transform: scaleY(0.1) } }

    .confirm-button { transition: all 0.25s ease; }
    .confirm-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-50 to-green-100 min-h-screen">
  <!-- Welcome Screen -->
  <div id="welcomeScreen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-6xl mb-4 owl-blink">🦉</div>
      <h1 class="text-4xl font-bold text-purple-600 mb-4">מספרונצ'יק</h1>
      <p class="text-lg text-gray-600 mb-8">בואו ללמוד חשבון עם שופי הינשוף</p>
      <button onclick="showNameInput()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">
        התחל משחק
      </button>
    </div>
  </div>

  <!-- Name Input Screen -->
  <div id="nameScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-5xl mb-4">👋</div>
      <h2 class="text-3xl font-bold text-blue-600 mb-6">איך קוראים לך?</h2>
      <input type="text" id="playerName" placeholder="הכנס את שמך כאן" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-6 text-center focus:border-blue-500 focus:outline-none">
      <button onclick="showOperationSelect()" class="bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-blue-600 hover:to-green-600 transform hover:scale-105 transition-all duration-200 shadow-lg">המשך</button>
    </div>
  </div>

  <!-- Operation Selection Screen -->
  <div id="operationScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
      <div class="text-5xl mb-4">🎯</div>
      <h2 class="text-3xl font-bold text-green-600 mb-2">שלום <span id="playerNameDisplay"></span>!</h2>
      <p class="text-lg text-gray-600 mb-4">בחר את סוג התרגול</p>
      <p class="text-sm text-gray-500 mb-6">בכל סט תרגילים תוצג לך סדרת שאלות מגוונות</p>

      <div id="opsGrid" class="grid grid-cols-2 gap-4 mb-6">
        <button data-op="addition" onclick="selectOperation('addition')" class="op-btn bg-gradient-to-r from-green-400 to-blue-500 text-white p-6 rounded-2xl text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">➕</div>חיבור</button>
        <button data-op="subtraction" onclick="selectOperation('subtraction')" class="op-btn bg-gradient-to-r from-red-400 to-pink-500 text-white p-6 rounded-2xl text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">➖</div>חיסור</button>
        <button data-op="multiplication" onclick="selectOperation('multiplication')" class="op-btn bg-gradient-to-r from-purple-400 to-indigo-500 text-white p-6 rounded-2xl text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">✖️</div>כפל</button>
        <button data-op="division" onclick="selectOperation('division')" class="op-btn bg-gradient-to-r from-orange-400 to-red-500 text-white p-6 rounded-2xl text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">➗</div>חילוק</button>
        <button data-op="mixed" onclick="selectOperation('mixed')" class="op-btn bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-2xl text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg col-span-2"><div class="text-3xl mb-2">🎲</div>הכל</button>
      </div>

      <div class="mt-2 text-right">
        <label for="curriculumSelect" class="block text-sm font-medium text-gray-700 mb-1">בחר תוכנית (לא חובה)</label>
        <select id="curriculumSelect" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none bg-white">
          <option value="none" selected>ללא תוכנית</option>
          <option value="il_g1_s1">ישראל: כיתה א׳ – סמסטר א׳ (עד 10)</option>
          <option value="il_g1_s2">ישראל: כיתה א׳ – סמסטר ב׳ (עד 20)</option>
          <option value="il_g1_adv">ישראל: כיתה א׳ – אתגר (עד 30)</option>
          <option value="il_g2">ישראל: כיתה ב׳ (עד 100)</option>
          <option value="il_g3">ישראל: כיתה ג׳ (עד 100; כפל/חילוק עד 10×10)</option>
          <option value="il_g4">ישראל: כיתה ד׳ (עד 1000; כפל/חילוק עד 12×12)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Difficulty Selection Screen -->
  <div id="difficultyScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
      <div class="text-5xl mb-4">⚡</div>
      <h2 class="text-3xl font-bold text-blue-600 mb-8">איזו רמת קושי מתאימה לך היום?</h2>
      <div class="flex flex-col gap-4 mb-6">
        <button onclick="startGame('easy')" class="bg-gradient-to-r from-green-400 to-green-500 text-white p-6 rounded-2xl text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">🌱</div><div class="font-bold">קל</div></button>
        <button onclick="startGame('medium')" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-2xl text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">🔥</div><div class="font-bold">בינוני</div></button>
        <button onclick="startGame('hard')" class="bg-gradient-to-r from-red-400 to-purple-500 text-white p-6 rounded-2xl text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">⚡</div><div class="font-bold">מתקדם</div></button>
      </div>
      <div class="mt-2 text-right">
        <label for="questionCountSelect" class="block text-sm font-medium text-gray-700 mb-1">מספר שאלות בסט</label>
        <select id="questionCountSelect" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none bg-white">
          <option value="6" selected>6</option>
          <option value="8">8</option>
          <option value="10">10</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="hidden min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6 mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-4">
        <div class="text-2xl font-bold text-purple-600">שאלה <span id="currentQuestion" class="ltr">1</span> מתוך <span id="totalQuestions" class="ltr">6</span></div>
        <div class="text-xl text-gray-600">שלום <span id="gamePlayerName"></span>! 👋</div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 mx-auto max-w-lg text-center">
      <div class="text-5xl mb-4 owl-blink">🦉</div>
      <div id="questionText" class="text-3xl font-bold text-gray-800 mb-6 ltr">5 + 3 = ?</div>
      <div class="text-lg text-gray-600 mb-4">בחר את התשובה הנכונה:</div>
    </div>

    <!-- Answer Options -->
    <div class="grid grid-cols-1 gap-3 max-w-2xl mx-auto px-4 mb-6">
      <div class="answer-item bg-white/70 backdrop-blur rounded-2xl p-4 shadow-lg flex items-center justify-center min-h-[80px]" data-value="6" data-idx="0" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">6</div>
      </div>
      <div class="answer-item bg-white/70 backdrop-blur rounded-2xl p-4 shadow-lg flex items-center justify-center min-h-[80px]" data-value="8" data-idx="1" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">8</div>
      </div>
      <div class="answer-item bg-white/70 backdrop-blur rounded-2xl p-4 shadow-lg flex items-center justify-center min-h-[80px]" data-value="7" data-idx="2" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">7</div>
      </div>
      <div class="answer-item bg-white/70 backdrop-blur rounded-2xl p-4 shadow-lg flex items-center justify-center min-h-[80px]" data-value="5" data-idx="3" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">5</div>
      </div>
    </div>

    <div class="text-center space-y-4">
      <button id="confirmButton" onclick="confirmAnswer()" disabled class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">אשר תשובה</button>
      <button onclick="startOver()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div role="dialog" aria-modal="true" aria-labelledby="feedbackText" class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
        <div id="feedbackIcon" class="text-8xl mb-4">🎉</div>
        <div id="feedbackText" aria-live="polite" class="text-2xl font-bold mb-6">כל הכבוד!</div>
        <button id="nextButton" onclick="nextQuestion()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">השאלה הבאה</button>
      </div>
    </div>
  </div>

  <!-- Results Screen -->
  <div id="resultsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
      <div class="text-8xl mb-4">🏆</div>
      <h2 class="text-3xl font-bold text-green-600 mb-4">כל הכבוד <span id="finalPlayerName"></span>!</h2>
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">הביצועים שלך:</span>
          <span id="performancePercentage" class="text-sm font-bold text-blue-600 ltr">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div id="performanceBar" class="h-6 rounded-full transition-all duration-1000 flex" aria-label="Progress indicator">
            <div id="correctBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
            <div id="incorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <span class="text-green-600 font-medium">✓ נכונות: <span id="correctCount" class="ltr">0</span></span>
          <span class="text-orange-600 font-medium">✗ שגויות: <span id="incorrectCount" class="ltr">0</span></span>
        </div>
      </div>
      <div class="text-xl text-gray-700 mb-6">
        <div id="performanceMessage" class="mb-4 font-medium text-lg">סיימת את הסט! 🎯</div>
        <div class="mb-2">תשובות נכונות: <span id="correctAnswers" class="font-bold text-green-600 ltr">0</span>/<span id="resultsTotal" class="ltr">6</span></div>
        <div class="mb-4">זמן ממוצע: <span id="averageTime" class="font-bold text-blue-600 ltr">0</span> שניות</div>
      </div>
      <div class="flex flex-col gap-4">
        <button onclick="startGame(currentDifficulty)" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">שחק שוב</button>
        <button id="mistakesButton" onclick="showMistakes()" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">למד מהטעויות</button>
        <button onclick="showOperationSelect()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">בחר תרגול אחר</button>
      </div>
    </div>
  </div>

  <!-- Mistakes Review Screen -->
  <div id="mistakesScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">📚</div>
        <h2 class="text-3xl font-bold text-orange-600 mb-4">למד מהטעויות</h2>
        <div class="mb-6 max-w-md mx-auto">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mb-3">
            <div id="mistakesPerformanceBar" class="h-4 rounded-full transition-all duration-1000 flex" aria-label="Performance summary">
              <div id="mistakesCorrectBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
              <div id="mistakesIncorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>
          <div id="mistakesMessage" class="text-lg text-gray-700 font-medium mb-4">הנה התרגילים שבהם טעית</div>
        </div>
        <p class="text-lg text-gray-600">לחץ על כל תרגיל כדי ללמוד איך לפתור אותו:</p>
      </div>
      <div id="mistakesList" class="space-y-6 mb-8"></div>
      <div class="text-center space-y-4">
        <button onclick="showResults()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">חזור לתוצאות</button>
        <button onclick="startOver()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
      </div>
    </div>
  </div>

  <!-- Interactive Tutorial Screen -->
  <div id="tutorialScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">🎓</div>
        <h2 id="tutorialTitle" class="text-3xl font-bold text-blue-600 mb-4 ltr">7 ÷ 5 = ?</h2>
        <p class="text-lg text-gray-600">בואו נלמד יחד איך לפתור את השאלה הזו!</p>
      </div>
      <div id="tutorialSteps" class="space-y-8 mb-8"></div>
      <div id="interactiveArea" class="bg-blue-50 rounded-2xl p-6 mb-8 text-center">
        <h3 class="text-xl font-bold text-blue-600 mb-4">נסה בעצמך!</h3>
        <div id="interactiveContent" class="flex flex-wrap justify-center gap-2 mb-4"></div>
        <div id="interactiveInstructions" class="text-gray-600">לחץ על הפריטים כדי לראות איך הפתרון עובד</div>
      </div>
      <div class="flex justify-center gap-4 flex-wrap">
        <button onclick="showMistakes()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">חזור לרשימת הטעויות</button>
        <button onclick="startOver()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
      </div>
    </div>
  </div>

  <script>
    // ===== State =====
    let currentOperation = 'addition';
    let currentDifficulty = 'easy';
    let currentQuestionIndex = 0;
    let correctCount = 0;
    let totalQuestions = 6;
    let questions = [];
    let mistakes = [];
    let startTime = 0;
    let totalTime = 0;
    let playerName = '';
    let currentTutorialMistake = null;
    let selectedAnswer = null;
    let currentCurriculum = 'none';
    let questionCount = 6;

    // rules
    const rulesByDifficulty = {
      easy:   { addSubMax: 20,  mulMax: 5,  divMaxDivisor: 5,  divMaxQuotient: 5 },
      medium: { addSubMax: 100, mulMax: 10, divMaxDivisor: 10, divMaxQuotient: 10 },
      hard:   { addSubMax: 1000,mulMax: 12, divMaxDivisor: 12, divMaxQuotient: 12 }
    };

    const curricula = {
      none: { name: 'ללא תוכנית' },
      il_g1_s1: { name: 'ישראל: כיתה א׳ – סמסטר א׳', operations: ['addition','subtraction'], addSubMax: 10 },
      il_g1_s2: { name: 'ישראל: כיתה א׳ – סמסטר ב׳', operations: ['addition','subtraction'], addSubMax: 20 },
      il_g1_adv:{ name: 'ישראל: כיתה א׳ – אתגר', operations: ['addition','subtraction'], addSubMax: 30 },
      il_g2:    { name: 'ישראל: כיתה ב׳', operations: ['addition','subtraction'], addSubMax: 100 },
      il_g3:    { name: 'ישראל: כיתה ג׳', operations: ['addition','subtraction','multiplication','division'], addSubMax: 100, mulMax: 10, divMaxDivisor: 10, divMaxQuotient: 10 },
      il_g4:    { name: 'ישראל: כיתה ד׳', operations: ['addition','subtraction','multiplication','division'], addSubMax: 1000, mulMax: 12, divMaxDivisor: 12, divMaxQuotient: 12 }
    };

    function getOpsList(selectedOp, cur) {
      if (selectedOp !== 'mixed') return [selectedOp];
      const allowed = cur?.operations;
      return allowed && allowed.length ? allowed : ['addition','subtraction','multiplication','division'];
    }
    function getEffectiveRules(difficulty) {
      const base = { ...rulesByDifficulty[difficulty] };
      const cur = curricula[currentCurriculum];
      if (cur?.addSubMax !== undefined) base.addSubMax = cur.addSubMax;
      if (cur?.mulMax !== undefined) base.mulMax = cur.mulMax;
      if (cur?.divMaxDivisor !== undefined) base.divMaxDivisor = cur.divMaxDivisor;
      if (cur?.divMaxQuotient !== undefined) base.divMaxQuotient = cur.divMaxQuotient;
      return base;
    }

    // ===== Navigation =====
    function showNameInput() {
      document.getElementById('welcomeScreen').classList.add('hidden');
      document.getElementById('nameScreen').classList.remove('hidden');
      setTimeout(() => { document.getElementById('playerName').focus(); }, 100);
    }
    function showOperationSelect() {
      if (!playerName) {
        const name = (document.getElementById('playerName')?.value || '').trim();
        if (!name) { alert('אנא הכנס את שמך'); return; }
        playerName = name;
      }
      document.getElementById('playerNameDisplay').textContent = playerName;
      ['nameScreen','resultsScreen','mistakesScreen','tutorialScreen'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('operationScreen').classList.remove('hidden');
      applyCurriculumToOperationButtons();
    }
    function selectOperation(operation) {
      currentOperation = operation;
      document.getElementById('operationScreen').classList.add('hidden');
      document.getElementById('difficultyScreen').classList.remove('hidden');
    }
    function applyCurriculumToOperationButtons() {
      const cur = curricula[currentCurriculum];
      const allowed = cur?.operations;
      const buttons = document.querySelectorAll('#opsGrid .op-btn');
      buttons.forEach(btn => {
        const op = btn.getAttribute('data-op');
        let enabled = true;
        if (allowed && op !== 'mixed') enabled = allowed.includes(op);
        if (!enabled) {
          btn.classList.add('opacity-50','cursor-not-allowed','pointer-events-none');
          btn.setAttribute('aria-disabled','true');
        } else {
          btn.classList.remove('opacity-50','cursor-not-allowed','pointer-events-none');
          btn.removeAttribute('aria-disabled');
        }
      });
    }

    // ===== Game Flow =====
    function startGame(difficulty) {
      currentDifficulty = difficulty;
      currentQuestionIndex = 0;
      correctCount = 0;
      totalTime = 0;
      mistakes = [];
      selectedAnswer = null;

      const curriculumSel = document.getElementById('curriculumSelect');
      if (curriculumSel) currentCurriculum = curriculumSel.value || 'none';
      const qSel = document.getElementById('questionCountSelect');
      questionCount = parseInt(qSel ? qSel.value : '6', 10) || 6;

      questions = generatePracticeSet(currentOperation, difficulty, questionCount);
      if (questions.length === 0) { alert('שגיאה: לא ניתן ליצור תרגילים עבור ההגדרות שנבחרו'); return; }

      totalQuestions = questions.length;
      document.getElementById('totalQuestions').textContent = totalQuestions;
      document.getElementById('resultsTotal').textContent = totalQuestions;

      ['difficultyScreen','resultsScreen','mistakesScreen','tutorialScreen'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('gameScreen').classList.remove('hidden');
      document.getElementById('gamePlayerName').textContent = playerName;

      const pb = document.getElementById('progressBar');
      pb.style.width = '0%'; pb.setAttribute('aria-valuenow','0');

      showQuestion();
    }

    function generatePracticeSet(operation, difficulty, desiredCount) {
      const rules = getEffectiveRules(difficulty);
      const cur = curricula[currentCurriculum];
      const ops = getOpsList(operation, cur);
      let pool = [];
      ops.forEach(op => pool.push(...buildOpPool(op, rules, desiredCount * 4, difficulty)));
      const map = new Map();
      for (const q of pool) if (!map.has(q.questionText)) map.set(q.questionText, q);
      return shuffleArray(Array.from(map.values())).slice(0, desiredCount);
    }

    function buildOpPool(operation, rules, targetSize, difficulty) {
      const pool = [];
      let attempts = 0, maxAttempts = 6000;
      function mkQ(text, answer, operation, num1, num2, symbol, explanation) {
        return { questionText: text, answer, explanation, operation, num1, num2, symbol };
      }
      if (operation === 'addition') {
        while (pool.length < targetSize && attempts++ < maxAttempts) {
          const fluency = (difficulty === 'easy') && Math.random() < 0.5;
          const cap = fluency ? Math.min(10, rules.addSubMax) : rules.addSubMax;
          const a = randInt(0, cap);
          const b = randInt(0, cap);
          const ans = a + b;
          if (ans <= cap) pool.push(mkQ(`${a} + ${b} = ?`, ans, 'addition', a, b, '+', ''));
        }
      }
      if (operation === 'subtraction') {
        while (pool.length < targetSize && attempts++ < maxAttempts) {
          const fluency = (difficulty === 'easy') && Math.random() < 0.5;
          const cap = fluency ? Math.min(10, rules.addSubMax) : rules.addSubMax;
          const a = randInt(0, cap);
          const b = randInt(0, a);
          const ans = a - b;
          if (ans >= 0 && ans <= cap) pool.push(mkQ(`${a} - ${b} = ?`, ans, 'subtraction', a, b, '-', ''));
        }
      }
      if (operation === 'multiplication') {
        while (pool.length < targetSize && attempts++ < maxAttempts) {
          const a = randInt(1, rules.mulMax);
          const b = randInt(1, rules.mulMax);
          pool.push(mkQ(`${a} × ${b} = ?`, a*b, 'multiplication', a, b, '×', ''));
        }
      }
      if (operation === 'division') {
        while (pool.length < targetSize && attempts++ < maxAttempts) {
          const divisor = randInt(1, rules.divMaxDivisor);
          const quotient = randInt(1, rules.divMaxQuotient);
          const dividend = divisor * quotient;
          pool.push(mkQ(`${dividend} ÷ ${divisor} = ?`, quotient, 'division', quotient, divisor, '÷', ''));
        }
      }
      return pool;
    }

    function showQuestion() {
      if (currentQuestionIndex >= questions.length) { showResults(); return; }
      selectedAnswer = null;
      const q = questions[currentQuestionIndex];

      document.getElementById('questionText').textContent = q.questionText;
      document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;

      const progress = ((currentQuestionIndex) / totalQuestions) * 100;
      const pb = document.getElementById('progressBar');
      pb.style.width = Math.max(2, Math.round(progress)) + '%';
      pb.setAttribute('aria-valuenow', String(Math.round(progress)));

      const options = generateAnswerOptions(q.answer);
      const items = document.querySelectorAll('.answer-item');
      options.forEach((opt, i) => {
        const el = items[i]; if (!el) return;
        el.setAttribute('data-value', opt);
        el.setAttribute('data-idx', String(i));
        el.querySelector('.tabular-nums').textContent = opt;
        el.classList.remove('selected');
        el.setAttribute('aria-selected','false');
      });

      const confirmButton = document.getElementById('confirmButton');
      confirmButton.disabled = true; confirmButton.setAttribute('aria-disabled','true');

      startTime = Date.now();
      setupAnswerSelection();
    }

    function setupAnswerSelection() {
      const items = document.querySelectorAll('.answer-item');
      items.forEach(item => {
        // pointer feedback for mobile (no hover dependency)
        item.onpointerdown = () => item.classList.add('pressed');
        item.onpointerup = item.onpointercancel = item.onpointerleave = () => item.classList.remove('pressed');

        item.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); item.click(); } };
        item.onclick = function () {
          items.forEach(el => { el.classList.remove('selected'); el.setAttribute('aria-selected','false'); });
          this.classList.add('selected');
          this.setAttribute('aria-selected','true');
          selectedAnswer = parseInt(this.getAttribute('data-value'));
          const confirm = document.getElementById('confirmButton');
          confirm.disabled = false; confirm.setAttribute('aria-disabled','false');
        };
      });
    }

    function confirmAnswer() {
      if (selectedAnswer === null) return;
      const correctAnswer = questions[currentQuestionIndex].answer;
      const endTime = Date.now(); totalTime += (endTime - startTime) / 1000;
      if (selectedAnswer === correctAnswer) { correctCount++; showFeedback(true); }
      else { mistakes.push({ question: questions[currentQuestionIndex], userAnswer: selectedAnswer, correctAnswer }); showFeedback(false); }
    }

    function showFeedback(isCorrect) {
      const feedback = document.getElementById('feedback');
      const icon = document.getElementById('feedbackIcon');
      const text = document.getElementById('feedbackText');
      if (isCorrect) { icon.textContent = '🎉'; text.textContent = 'כל הכבוד! תשובה נכונה!'; text.className = 'text-2xl font-bold mb-6 text-green-600'; }
      else { icon.textContent = '💪'; text.textContent = 'כמעט! בפעם הבאה תצליח!'; text.className = 'text-2xl font-bold mb-6 text-orange-600'; }
      feedback.classList.remove('hidden'); document.body.style.overflow = 'hidden';
      document.getElementById('nextButton').focus();
    }

    function nextQuestion() {
      document.getElementById('feedback').classList.add('hidden');
      document.body.style.overflow = '';
      currentQuestionIndex++;
      if (currentQuestionIndex < totalQuestions) {
        showQuestion();
        document.getElementById('confirmButton').focus();
      } else {
        const pb = document.getElementById('progressBar'); pb.style.width = '100%'; pb.setAttribute('aria-valuenow','100');
        showResults();
      }
    }

    function showResults() {
      document.getElementById('gameScreen').classList.add('hidden');
      document.getElementById('mistakesScreen').classList.add('hidden');
      document.getElementById('tutorialScreen').classList.add('hidden');
      document.getElementById('resultsScreen').classList.remove('hidden');

      const incorrectCount = totalQuestions - correctCount;
      const percentage = Math.round((correctCount / totalQuestions) * 100);

      const msg = document.getElementById('performanceMessage');
      const icon = document.querySelector('#resultsScreen .text-8xl');
      const title = document.querySelector('#resultsScreen h2');

      if (correctCount === totalQuestions) { msg.textContent = 'מושלם! ענית נכון על כל השאלות! 🌟'; msg.className = 'mb-4 font-medium text-lg text-green-600'; icon.textContent = '🏆'; title.className = 'text-3xl font-bold text-green-600 mb-4'; }
      else if (correctCount === 0) { msg.textContent = 'סיימת את הסט! 🎯'; msg.className = 'mb-4 font-medium text-lg text-gray-600'; icon.textContent = '💪'; title.textContent = 'אופס, הפעם לא הלך - בואו נשתפר בסיבוב הבא!'; title.className = 'text-3xl font-bold text-orange-600 mb-4'; }
      else { msg.textContent = `ענית נכון על ${correctCount} מתוך ${totalQuestions} שאלות - כל הכבוד! 🎯`; msg.className = 'mb-4 font-medium text-lg text-blue-600'; icon.textContent = '🏆'; title.innerHTML = `כל הכבוד <span id="finalPlayerName">${playerName}</span>!`; title.className = 'text-3xl font-bold text-green-600 mb-4'; }

      updatePerformanceBar(correctCount, incorrectCount, percentage);
      document.getElementById('correctAnswers').textContent = correctCount;
      document.getElementById('averageTime').textContent = Math.max(1, Math.round(totalTime / totalQuestions));
      document.getElementById('mistakesButton').classList.toggle('hidden', mistakes.length === 0);
    }

    function updatePerformanceBar(correct, incorrect, percentage) {
      const correctPercentage = (correct / totalQuestions) * 100;
      const incorrectPercentage = (incorrect / totalQuestions) * 100;
      document.getElementById('correctBar').style.width = `${correctPercentage}%`;
      document.getElementById('incorrectBar').style.width = `${incorrectPercentage}%`;
      document.getElementById('performancePercentage').textContent = `${percentage}%`;
      document.getElementById('correctCount').textContent = correct;
      document.getElementById('incorrectCount').textContent = incorrect;
    }

    function showMistakes() {
      document.getElementById('resultsScreen').classList.add('hidden');
      document.getElementById('tutorialScreen').classList.add('hidden');
      document.getElementById('mistakesScreen').classList.remove('hidden');

      const incorrectCount = totalQuestions - correctCount;
      document.getElementById('mistakesCorrectBar').style.width = `${(correctCount / totalQuestions) * 100}%`;
      document.getElementById('mistakesIncorrectBar').style.width = `${(incorrectCount / totalQuestions) * 100}%`;

      const mm = document.getElementById('mistakesMessage');
      if (mistakes.length === 0) { mm.textContent = `מושלם! ענית נכון על כל ${totalQuestions} השאלות! 🌟`; mm.className = 'text-lg text-green-600 font-medium mb-4'; }
      else if (correctCount > 0) { mm.textContent = `ענית נכון על ${correctCount} מתוך ${totalQuestions} - בואו נלמד מה-${mistakes.length} שנשארו`; mm.className = 'text-lg text-blue-600 font-medium mb-4'; }
      else { mm.textContent = 'בואו נלמד יחד איך לפתור את השאלות האלה'; mm.className = 'text-lg text-orange-600 font-medium mb-4'; }

      const list = document.getElementById('mistakesList');
      list.innerHTML = '';
      if (mistakes.length === 0) {
        list.innerHTML = '<div class="text-center p-8"><div class="text-6xl mb-4">🎉</div><h3 class="text-2xl font-bold text-green-600">מעולה!</h3><p class="text-lg text-gray-600">לא היו לך טעויות במשחק הזה!</p></div>';
        return;
      }
      questions.forEach((q, i) => {
        const m = mistakes.find(x => x.question.questionText === q.questionText);
        if (!m) return;
        const div = document.createElement('div');
        div.className = 'bg-orange-50 border-2 border-orange-200 rounded-2xl p-6 cursor-pointer hover:bg-orange-100 transition-colors';
        div.onclick = () => showTutorial(m);
        div.innerHTML = `
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
              <div class="w-4 h-4 bg-orange-500 rounded-full"></div>
              <h3 class="text-xl font-bold text-orange-600">שאלה ${i + 1}</h3>
            </div>
            <div class="text-2xl">🤔</div>
          </div>
          <div class="text-2xl font-bold text-gray-800 mb-4 ltr">${m.question.questionText}</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="bg-red-100 border-2 border-red-300 rounded-xl p-4">
              <div class="text-sm text-red-600 font-bold mb-1">התשובה שלך:</div>
              <div class="text-xl font-bold text-red-700 ltr">${m.userAnswer}</div>
            </div>
            <div class="bg-green-100 border-2 border-green-300 rounded-xl p-4">
              <div class="text-sm text-green-600 font-bold mb-1">התשובה הנכונה:</div>
              <div class="text-xl font-bold text-green-700 ltr">${m.correctAnswer}</div>
            </div>
          </div>
          <div class="text-center text-blue-600 font-bold">👆 לחץ כאן כדי ללמוד איך לפתור</div>`;
        list.appendChild(div);
      });
    }

    function showTutorial(mistake) {
      currentTutorialMistake = mistake;
      document.getElementById('mistakesScreen').classList.add('hidden');
      document.getElementById('tutorialScreen').classList.remove('hidden');

      const q = mistake.question;
      document.getElementById('tutorialTitle').textContent = q.questionText;
      createTutorialSteps(q);
      createInteractiveDemo(q);
    }

    function createTutorialSteps(question) {
      const c = document.getElementById('tutorialSteps');
      c.innerHTML = '';
      getTutorialSteps(question).forEach((s, idx) => {
        const d = document.createElement('div');
        d.className = 'bg-blue-50 border-2 border-blue-200 rounded-2xl p-6';
        d.innerHTML = `
          <div class="flex items-center mb-4 gap-4">
            <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">${idx + 1}</div>
            <h3 class="text-xl font-bold text-blue-600">${s.title}</h3>
          </div>
          <p class="text-gray-700 text-lg">${s.description}</p>`;
        c.appendChild(d);
      });
    }
    function getTutorialSteps(q) {
      const { operation, num1, num2, answer } = q;
      if (operation === 'addition') return [
        { title: 'הבנת השאלה', description: `אנחנו רוצים לדעת כמה זה ${num1} + ${num2}.` },
        { title: 'הצגת הפריטים הראשונים', description: `נתחיל עם ${num1} פריטים.` },
        { title: 'הוספת פריטים', description: `נוסיף ${num2} ונמנה הכול יחד.` },
        { title: 'התוצאה', description: `יש ${answer} פריטים. זו התשובה!` }
      ];
      if (operation === 'subtraction') return [
        { title: 'הבנת השאלה', description: `אנחנו רוצים לדעת כמה זה ${num1} - ${num2}.` },
        { title: 'הצגת הפריטים הראשונים', description: `נתחיל עם ${num1} פריטים.` },
        { title: 'הסרת פריטים', description: `נסיר ${num2} ונמנה כמה נשאר.` },
        { title: 'התוצאה', description: `נשארו ${answer} פריטים.` }
      ];
      if (operation === 'multiplication') return [
        { title: 'הבנת השאלה', description: `אנחנו רוצים לדעת כמה זה ${num1} × ${num2}.` },
        { title: 'יצירת קבוצות', description: `ניצור ${num1} קבוצות של ${num2}.` },
        { title: 'ספירה', description: `נספור את כל הפריטים.` },
        { title: 'התוצאה', description: `יש ${answer} פריטים בסך הכול.` }
      ];
      if (operation === 'division') {
        const dividend = parseInt(q.questionText.split(' ÷ ')[0]); const divisor = num2;
        return [
          { title: 'הבנת השאלה', description: `אנחנו רוצים לדעת כמה זה ${dividend} ÷ ${divisor}.` },
          { title: 'הצגת כל הפריטים', description: `נתחיל עם ${dividend} פריטים.` },
          { title: 'חלוקה לקבוצות', description: `נחלק לקבוצות של ${divisor}.` },
          { title: 'התוצאה', description: `קיבלנו ${answer} קבוצות.` }
        ];
      }
      return [];
    }

    // simple interactive demo (שומר על אימוג׳ים רק למסך ההדרכה)
    const tutorialEmojis = ['🍎','🎈','⭐','🌟','🍊','🎯','🌈','🎪'];
    function createInteractiveDemo(q) {
      const area = document.getElementById('interactiveContent');
      const info = document.getElementById('interactiveInstructions');
      area.innerHTML = '';
      const { operation, num1, num2, answer } = q;
      const emoji = tutorialEmojis[Math.floor(Math.random() * tutorialEmojis.length)];
      if (operation === 'addition') {
        let clicked = 0, total = answer;
        for (let i = 0; i < total; i++) {
          const s = document.createElement('span'); s.className = 'text-3xl m-1 opacity-50 cursor-pointer'; s.textContent = i < num1 ? '🔵' : '🟡';
          s.onclick = () => { if (clicked < total && s.style.opacity !== '1') { s.style.opacity = '1'; clicked++; info.textContent = clicked === total ? `מעולה! ספרת ${total} פריטים - זו התשובה! 🎉` : `המשך לספור... (${clicked}/${total})`; } };
          area.appendChild(s); if ((i + 1) % 5 === 0 && i < total - 1) area.appendChild(document.createElement('br'));
        }
        info.textContent = `לחץ על הכדורים כדי לספור את ${num1} + ${num2}`; return;
      }
      if (operation === 'subtraction') {
        let removed = 0;
        for (let i = 0; i < num1; i++) {
          const s = document.createElement('span'); s.className = 'text-3xl m-1 cursor-pointer'; s.textContent = emoji;
          s.onclick = () => { if (removed < num2 && s.style.opacity !== '0.3') { s.style.opacity = '0.3'; s.style.textDecoration = 'line-through'; removed++; info.textContent = removed === num2 ? `מעולה! הסרת ${num2} פריטים; נשארו ${answer}. 🎉` : `לחץ על עוד ${num2 - removed}`; } };
          area.appendChild(s); if ((i + 1) % 5 === 0 && i < num1 - 1) area.appendChild(document.createElement('br'));
        }
        info.textContent = `לחץ על ${num2} פריטים כדי להסיר מתוך ${num1}`; return;
      }
      if (operation === 'multiplication') {
        let shown = 0;
        for (let g = 0; g < num1; g++) {
          const group = document.createElement('div'); group.className = 'inline-block border-2 border-dashed border-blue-300 rounded-lg p-3 m-2 bg-blue-50'; group.style.opacity = '0.5';
          const label = document.createElement('div'); label.className = 'text-sm font-bold text-blue-600 mb-2 text-center'; label.textContent = `קבוצה ${g + 1}`; group.appendChild(label);
          for (let i = 0; i < num2; i++) { const s = document.createElement('span'); s.className = 'text-2xl m-1'; s.textContent = emoji; group.appendChild(s); }
          group.onclick = () => { if (group.style.opacity === '0.5') { group.style.opacity = '1'; if (++shown === num1) info.textContent = `מעולה! ${num1}×${num2} = ${answer}. 🎉`; else info.textContent = `נהדר! לחץ על עוד ${num1 - shown} קבוצות`; } };
          area.appendChild(group);
        }
        info.textContent = `לחץ על הקבוצות כדי לראות ${num1} קבוצות של ${num2}`; return;
      }
      if (operation === 'division') {
        let shown = 0; const dividend = parseInt(q.questionText.split(' ÷ ')[0]);
        for (let g = 0; g < answer; g++) {
          const group = document.createElement('div'); group.className = 'inline-block border-2 border-dashed border-purple-300 rounded-lg p-3 m-2 bg-purple-50'; group.style.opacity = '0.5';
          const label = document.createElement('div'); label.className = 'text-sm font-bold text-purple-600 mb-2 text-center'; label.textContent = `קבוצה ${g + 1}`; group.appendChild(label);
          for (let i = 0; i < num2; i++) { const s = document.createElement('span'); s.className = 'text-2xl m-1'; s.textContent = emoji; group.appendChild(s); }
          group.onclick = () => { if (group.style.opacity === '0.5') { group.style.opacity = '1'; if (++shown === answer) info.textContent = `מעולה! חילקת ${dividend} ל-${answer} קבוצות של ${num2}. 🎉`; else info.textContent = `נהדר! לחץ על עוד ${answer - shown} קבוצות`; } };
          area.appendChild(group);
        }
        info.textContent = `לחץ על הקבוצות כדי לראות חלוקה ל-${answer} קבוצות של ${num2}`;
      }
    }

    function startOver() {
      currentOperation = 'addition'; currentDifficulty = 'easy'; currentQuestionIndex = 0;
      correctCount = 0; questions = []; mistakes = []; startTime = 0; totalTime = 0; selectedAnswer = null; currentTutorialMistake = null;
      ['gameScreen','resultsScreen','mistakesScreen','tutorialScreen','difficultyScreen','nameScreen','welcomeScreen'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('operationScreen').classList.remove('hidden');
      applyCurriculumToOperationButtons();
    }

    // ===== Utils =====
    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function shuffleArray(arr) { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
    function generateAnswerOptions(correct) {
      const opts = [correct];
      while (opts.length < 4) {
        const wrong = correct + Math.floor(Math.random() * 7) - 3; // ±3
        if (wrong > 0 && wrong !== correct && !opts.includes(wrong)) opts.push(wrong);
      }
      return shuffleArray(opts);
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('playerName');
      if (input) input.addEventListener('keydown', e => { if (e.key === 'Enter') showOperationSelect(); });
      const curriculumSel = document.getElementById('curriculumSelect');
      if (curriculumSel) curriculumSel.addEventListener('change', e => { currentCurriculum = e.target.value; applyCurriculumToOperationButtons(); });
      const qSel = document.getElementById('questionCountSelect');
      if (qSel) qSel.addEventListener('change', e => { questionCount = parseInt(e.target.value, 10) || 6; });
    });
  </script>
</body>
</html>
