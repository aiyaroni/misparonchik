<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¡×¤×¨×•× ×¦'×™×§ - ××©×—×§ ×—×©×‘×•×Ÿ ×œ×™××•×“×™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');
    body{font-family:'Assistant',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .ltr{direction:ltr;unicode-bidi:embed;display:inline-block}
    .tabular-nums{font-variant-numeric:tabular-nums}
    .owl-blink{animation:blink 2s infinite}
    @keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.1)}}

    /* ×ª×©×•×‘×•×ª */
    .answer-item{position:relative;transition:transform .14s,box-shadow .14s,border-color .14s;cursor:pointer;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;background:rgba(255,255,255,.92);border-radius:1rem;border:2px solid transparent;outline:none}
    .answer-item::before{content:"";position:absolute;inset:0;border-radius:inherit;pointer-events:none;background:var(--tint,transparent);opacity:.08}
    .answer-item .accent{display:none;position:absolute;right:0;top:0;bottom:0;width:8px;border-radius:0 1rem 1rem 0;opacity:.55;background:var(--tint);pointer-events:none}
    .answer-item[data-idx="0"]{--tint:#f87171}
    .answer-item[data-idx="1"]{--tint:#60a5fa}
    .answer-item[data-idx="2"]{--tint:#4ade80}
    .answer-item[data-idx="3"]{--tint:#facc15}
    .answer-item:active{transform:scale(.98)}
    .answer-item.selected{border-color:#2563eb;box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .answer-item.selected .accent{display:block}

    .confirm-button{transition:all .25s}
    .confirm-button[disabled]{opacity:.5;cursor:not-allowed}

    /* ×•×™×“×’×³×˜ ×©×•×¤×™ â€“ ×“×¡×§×˜×•×¤: ×‘×•×¢×” ×¦×¤×” */
    #coach{position:fixed;right:16px;bottom:24px;z-index:40;display:none}
    #coach .coach-inner{display:flex;align-items:flex-start;gap:.75rem;background:rgba(255,255,255,.95);backdrop-filter:blur(6px);border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.18);padding:.75rem 1rem;border:1px solid #e5e7eb;max-width:min(90vw,360px)}
    #coachClose{position:absolute;top:6px;right:8px;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;border-radius:9999px;background:transparent;border:none;cursor:pointer;color:#4b5563}
    #coachClose:hover{background:rgba(0,0,0,.06);color:#111827}

    /* ××•×‘×™×™×œ: ×‘×¨ ×ª×—×ª×•×Ÿ ×“×‘×™×§ */
    @media (max-width:640px){
      #coach{
        position:fixed;left:0;right:0;bottom:0;z-index:40;display:none;
        padding:0 12px calc(12px + env(safe-area-inset-bottom));
      }
      #coach .coach-inner{
        width:100%;max-width:none;border-radius:16px 16px 0 0;
        box-shadow:0 -8px 20px rgba(0,0,0,.12);
      }
      /* ×¨×™×•×•×— ×œ×¢××•×“ ×›×“×™ ×©×”×‘×¨ ×œ× ×™×›×¡×” ×›×¤×ª×•×¨×™ ×ª×—×ª×™×ª */
      body.with-coach-pad{padding-bottom:calc(96px + env(safe-area-inset-bottom))}
    }

    /* ×›×¤×ª×•×¨ ×”×©×ª×§×ª ××•×“×™×• */
    #audioToggle{padding:.5rem .7rem;border-radius:9999px;background:rgba(255,255,255,.95);border:1px solid #e5e7eb;box-shadow:0 6px 20px rgba(0,0,0,.12)}
    #audioToggle[aria-pressed="true"] .muted{display:inline}
    #audioToggle[aria-pressed="true"] .unmuted{display:none}
    #audioToggle[aria-pressed="false"] .muted{display:none}
    #audioToggle[aria-pressed="false"] .unmuted{display:inline}
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-50 to-green-100 min-h-screen">
  <!-- Welcome Screen -->
  <div id="welcomeScreen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-6xl mb-4 owl-blink">ğŸ¦‰</div>
      <h1 class="text-4xl font-bold text-purple-600 mb-4">××¡×¤×¨×•× ×¦'×™×§</h1>
      <p class="text-2xl text-gray-700 mb-8">×‘×•××• ×œ×œ××•×“ ×—×©×‘×•×Ÿ ×¢× ×©×•×¤×™ ×”×™× ×©×•×£</p>
      <button type="button" id="startBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××©×—×§</button>
    </div>
  </div>

  <!-- Name Input Screen -->
  <div id="nameScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <form id="nameForm" class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-5xl mb-4">ğŸ‘‹</div>
      <h2 class="text-3xl font-bold text-blue-600 mb-6">××™×š ×§×•×¨××™× ×œ×š?</h2>
      <input type="text" id="playerName" name="playerName" required placeholder="×”×›× ×¡ ××ª ×©××š ×›××Ÿ" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-6 text-center focus:border-blue-500 focus:outline-none">
      <button type="submit" class="bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-blue-600 hover:to-green-600 transform hover:scale-105 transition-all duration-200 shadow-lg">×”××©×š</button>
    </form>
  </div>

  <!-- Operation Selection Screen -->
  <div id="operationScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full">
      <div class="text-5xl mb-4">ğŸ¯</div>
      <h2 class="text-3xl md:text-4xl font-extrabold text-green-600 mb-3 leading-tight">×‘×•××• × ×‘×—×¨ ××ª ×¡×•×’ ×”×ª×¨×’×™×œ</h2>
      <p class="text-lg md:text-xl text-gray-700 mb-8 leading-relaxed">×‘×›×œ ×¡×˜ ×ª×¨×’×™×œ×™× ×ª×•×¦×’ ×œ×š ×¡×“×¨×ª ×©××œ×•×ª ××’×•×•× ×•×ª</p>

      <div class="text-right mb-8">
        <label for="curriculumSelect" class="block text-lg font-semibold text-gray-800 mb-2">×‘×—×™×¨×ª ×ª×•×›× ×™×ª ×œ×™××•×“</label>
        <select id="curriculumSelect" class="w-full p-4 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none bg-white">
          <option value="none" selected>×œ×œ× ×ª×•×›× ×™×ª</option>
          <option value="il_g1_s1">×›×™×ª×” ××³, ××—×¦×™×ª ×¨××©×•× ×” (×¢×“ 10)</option>
          <option value="il_g1_s2">×›×™×ª×” ××³, ××—×¦×™×ª ×©× ×™×™×” (×¢×“ 20)</option>
          <option value="il_g1_adv">×›×™×ª×” ××³, ××ª×’×¨ (×¢×“ 30)</option>
          <option value="il_g2">×›×™×ª×” ×‘×³ (×¢×“ 100)</option>
          <option value="il_g3">×›×™×ª×” ×’×³ (×¢×“ 100; ×›×¤×œ/×—×™×œ×•×§ ×¢×“ 10Ã—10)</option>
          <option value="il_g4">×›×™×ª×” ×“×³ (×¢×“ 1000; ×›×¤×œ/×—×™×œ×•×§ ×¢×“ 12Ã—12)</option>
        </select>
      </div>

      <div id="opsGrid" class="grid grid-cols-2 gap-4 mb-6">
        <button data-op="addition" class="op-btn bg-gradient-to-r from-green-400 to-blue-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">â•</div>×—×™×‘×•×¨</button>
        <button data-op="subtraction" class="op-btn bg-gradient-to-r from-red-400 to-pink-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">â–</div>×—×™×¡×•×¨</button>
        <button data-op="multiplication" class="op-btn bg-gradient-to-r from-purple-400 to-indigo-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">âœ–ï¸</div>×›×¤×œ</button>
        <button data-op="division" class="op-btn bg-gradient-to-r from-orange-400 to-red-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">â—</div>×—×™×œ×•×§</button>
        <button data-op="mixed" class="op-btn bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg col-span-2"><div class="text-4xl mb-2">ğŸ²</div>×”×›×œ</button>
      </div>
    </div>
  </div>

  <!-- Difficulty Selection Screen -->
  <div id="difficultyScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
      <div class="text-5xl mb-4">âš¡</div>
      <h2 class="text-3xl sm:text-4xl font-bold text-blue-600 mb-6">××™×–×• ×¨××ª ×§×•×©×™ ××ª××™××” ×œ×š ×”×™×•×?</h2>

      <div class="mt-1 mb-6 text-right">
        <label for="questionCountSelect" class="block text-lg font-semibold text-gray-800 mb-2">××¡×¤×¨ ×©××œ×•×ª ×‘×¡×˜</label>
        <select id="questionCountSelect" class="w-full p-4 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none bg-white">
          <option value="6" selected>6</option>
          <option value="8">8</option>
          <option value="10">10</option>
        </select>
      </div>

      <div class="flex flex-col gap-4 mb-2">
        <button data-diff="easy" class="diff-btn bg-gradient-to-r from-green-400 to-green-500 text-white p-6 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">ğŸŒ±</div><div class="font-bold">×§×œ</div></button>
        <button data-diff="medium" class="diff-btn bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">ğŸ”¥</div><div class="font-bold">×‘×™× ×•× ×™</div></button>
        <button data-diff="hard" class="diff-btn bg-gradient-to-r from-red-400 to-purple-500 text-white p-6 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">âš¡</div><div class="font-bold">××ª×§×“×</div></button>
      </div>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="hidden min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6 mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-4">
        <div class="text-2xl font-bold text-purple-600">×©××œ×” <span id="currentQuestion" class="ltr">1</span> ××ª×•×š <span id="totalQuestions" class="ltr">6</span></div>
        <div class="text-xl text-gray-600">×©×œ×•× <span id="gamePlayerName"></span>! ğŸ‘‹</div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4" aria-hidden="true">
        <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 mx-auto max-w-lg text-center">
      <div class="text-5xl mb-4 owl-blink">ğŸ¦‰</div>
      <div id="questionText" class="text-3xl font-bold text-gray-800 mb-6 ltr">5 + 3 = ?</div>
      <div class="text-xl text-gray-700 mb-4">×™×© ×œ×‘×—×•×¨ ××ª ×”×ª×©×•×‘×” ×”× ×›×•× ×”</div>
    </div>

    <div id="answersGrid" class="grid grid-cols-1 gap-3 max-w-2xl mx-auto px-4 mb-6">
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="6" data-idx="0" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">6</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="8" data-idx="1" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">8</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="7" data-idx="2" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">7</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="5" data-idx="3" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">5</div>
      </div>
    </div>

    <div class="text-center space-y-4 pb-6">
      <button id="confirmButton" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold transition-all duration-200 shadow-lg" disabled aria-disabled="true">××©×¨ ×ª×©×•×‘×”</button>
      <button type="button" id="restartBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div role="dialog" aria-modal="true" aria-labelledby="feedbackText" class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
        <div id="feedbackIcon" class="text-8xl mb-4">ğŸ‰</div>
        <div id="feedbackText" aria-live="polite" class="text-2xl font-bold mb-6">×›×œ ×”×›×‘×•×“!</div>
        <button id="nextButton" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×©××œ×” ×”×‘××”</button>
      </div>
    </div>
  </div>

  <!-- Results Screen -->
  <div id="resultsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full relative overflow-hidden">
      <div class="text-8xl mb-4">ğŸ†</div>
      <h2 class="text-3xl font-bold text-green-600 mb-4" id="resultsTitle">×›×œ ×”×›×‘×•×“!</h2>
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">×”×‘×™×¦×•×¢×™× ×©×œ×š:</span>
          <span id="performancePercentage" class="text-sm font-bold text-blue-600 ltr">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div id="performanceBar" class="h-6 rounded-full transition-all duration-1000 flex" aria-label="Progress indicator">
            <div id="correctBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
            <div id="incorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <span class="text-green-600 font-medium">âœ“ × ×›×•× ×•×ª: <span id="correctCount" class="ltr">0</span></span>
          <span class="text-orange-600 font-medium">âœ— ×©×’×•×™×•×ª: <span id="incorrectCount" class="ltr">0</span></span>
        </div>
      </div>
      <div class="text-xl text-gray-700 mb-6">
        <div id="performanceMessage" class="mb-4 font-medium text-lg">×¡×™×™××ª ××ª ×”×¡×˜! ğŸ¯</div>
        <div class="mb-2">×ª×©×•×‘×•×ª × ×›×•× ×•×ª: <span id="correctAnswers" class="font-bold text-green-600 ltr">0</span>/<span id="resultsTotal" class="ltr">6</span></div>
        <div class="mb-4">×–××Ÿ ×××•×¦×¢: <span id="averageTime" class="font-bold text-blue-600 ltr">0</span> ×©× ×™×•×ª</div>
      </div>
      <div class="flex flex-col gap-4">
        <button id="retryBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×× ×™ ×¨×•×¦×” ×œ×ª×¨×’×œ ××—×“×©</button>
        <button id="mistakesButton" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×œ×œ××•×“ ××”×˜×¢×•×™×•×ª</button>
        <button id="altBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×‘× ×œ×™ ×ª×¨×’×•×œ ××—×¨</button>
      </div>
    </div>
  </div>

  <!-- Mistakes Review Screen -->
  <div id="mistakesScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">ğŸ“š</div>
        <h2 class="text-3xl font-bold text-orange-600 mb-4">×œ××“ ××”×˜×¢×•×™×•×ª</h2>
        <div class="mb-6 max-w-md mx-auto">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mb-3">
            <div id="mistakesPerformanceBar" class="h-4 rounded-full transition-all duration-1000 flex" aria-label="Performance summary">
              <div id="mistakesCorrectBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
              <div id="mistakesIncorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>
          <div id="mistakesMessage" class="text-lg text-gray-700 font-medium mb-4">×”× ×” ×”×ª×¨×’×™×œ×™× ×©×‘×”× ×˜×¢×™×ª</div>
        </div>
        <p class="text-lg text-gray-600">×œ×—×¥ ×¢×œ ×›×œ ×ª×¨×’×™×œ ×›×“×™ ×œ×œ××•×“ ××™×š ×œ×¤×ª×•×¨ ××•×ª×•:</p>
      </div>
      <div id="mistakesList" class="space-y-6 mb-8"></div>
      <div class="text-center space-y-4">
        <button id="backToResults" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×—×–×•×¨ ×œ×ª×•×¦××•×ª</button>
        <button type="button" id="restartFromMistakes" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
      </div>
    </div>
  </div>

  <!-- Tutorial Screen -->
  <div id="tutorialScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">ğŸ“</div>
        <h2 id="tutorialTitle" tabindex="-1" class="text-3xl font-bold text-blue-600 mb-4 ltr">7 Ã· 5 = ?</h2>
        <p class="text-lg text-gray-600">×‘×•××• × ×œ××“ ×™×—×“ ××™×š ×œ×¤×ª×•×¨ ××ª ×”×©××œ×” ×”×–×•!</p>
      </div>
      <div id="tutorialSteps" class="space-y-8 mb-8"></div>
      <div id="interactiveArea" class="bg-blue-50 rounded-2xl p-6 mb-8 text-center">
        <h3 class="text-xl font-bold text-blue-600 mb-4">× ×¡×” ×‘×¢×¦××š!</h3>
        <div id="interactiveContent" class="flex flex-wrap justify-center gap-2 mb-4"></div>
        <div id="interactiveInstructions" class="text-gray-600">×œ×—×¥ ×¢×œ ×”×¤×¨×™×˜×™× ×›×“×™ ×œ×¨××•×ª ××™×š ×”×¤×ª×¨×•×Ÿ ×¢×•×‘×“</div>
      </div>
      <div class="flex justify-center gap-4 flex-wrap">
        <button id="backToMistakes" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×—×–×•×¨ ×œ×¨×©×™××ª ×”×˜×¢×•×™×•×ª</button>
        <button type="button" id="restartFromTutorial" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
      </div>
    </div>
  </div>

  <!-- Shufi Coach Widget -->
  <div id="coach" aria-live="polite">
    <div class="coach-inner relative">
      <div class="text-3xl mr-1" aria-hidden="true">ğŸ¦‰</div>
      <p id="coachMsg" class="text-base sm:text-lg text-gray-800 leading-snug">×”×™×™! ×× ×™ ×©×•×¤×™. ×‘×”×¦×œ×—×”!</p>
      <button id="coachClose" aria-label="×¡×’×•×¨">Ã—</button>
    </div>
  </div>

  <!-- Audio toggle -->
  <button id="audioToggle" class="fixed left-4 top-4 z-50" type="button" aria-label="×”×—×œ×¤×ª ××¦×‘ ×¦×œ×™×œ" aria-pressed="false" title="×”×¦×œ×™×œ ×¤×¢×™×œ">
    <span class="unmuted" aria-hidden="true">ğŸ”Š</span>
    <span class="muted" aria-hidden="true">ğŸ”‡</span>
  </button>

  <script>
    /* ========= State ========= */
    let currentOperation='addition', currentDifficulty='easy', currentQuestionIndex=0;
    let correctCount=0, totalQuestions=6, questions=[], mistakes=[];
    let startTime=0, totalTime=0, playerName='', selectedAnswer=null;
    let questionCount=6, currentCurriculum='none';
    let isMuted=false, audioCtx=null, audioUnlocked=false;
    let coachHidden=false;

    const rulesByDifficulty={ easy:{addSubMax:20,mulMax:5,divMaxDivisor:5,divMaxQuotient:5},
      medium:{addSubMax:100,mulMax:10,divMaxDivisor:10,divMaxQuotient:10},
      hard:{addSubMax:1000,mulMax:12,divMaxDivisor:12,divMaxQuotient:12} };

    const curricula={
      none:{name:'×œ×œ× ×ª×•×›× ×™×ª'},
      il_g1_s1:{name:'×›×™×ª×” ××³, ××—×¦×™×ª ×¨××©×•× ×”',operations:['addition','subtraction'],addSubMax:10},
      il_g1_s2:{name:'×›×™×ª×” ××³, ××—×¦×™×ª ×©× ×™×™×”',operations:['addition','subtraction'],addSubMax:20},
      il_g1_adv:{name:'×›×™×ª×” ××³, ××ª×’×¨',operations:['addition','subtraction'],addSubMax:30},
      il_g2:{name:'×›×™×ª×” ×‘×³',operations:['addition','subtraction'],addSubMax:100},
      il_g3:{name:'×›×™×ª×” ×’×³',operations:['addition','subtraction','multiplication','division'],addSubMax:100,mulMax:10,divMaxDivisor:10,divMaxQuotient:10},
      il_g4:{name:'×›×™×ª×” ×“×³',operations:['addition','subtraction','multiplication','division'],addSubMax:1000,mulMax:12,divMaxDivisor:12,divMaxQuotient:12}
    };

    /* ========= Helpers ========= */
    const $=sel=>document.querySelector(sel);
    const $$=sel=>document.querySelectorAll(sel);
    const randInt=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    function shuffle(a){const c=a.slice();for(let i=c.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[c[i],c[j]]=[c[j],c[i]]}return c}

    /* ========= Coach (Shufi) ========= */
    function showCoach(msg, ctx='default'){
      if (coachHidden) return;
      const el = $('#coach'); const txt = $('#coachMsg');
      if (!el || !txt) return;
      txt.textContent = msg || '×‘×”×¦×œ×—×”!';
      el.style.display = 'block';
      placeCoach(ctx);
    }
    function hideCoach(){
      const el=$('#coach'); if(el) el.style.display='none';
      document.body.classList.remove('with-coach-pad');
    }
    function placeCoach(ctx){
      const el=$('#coach'); if(!el) return;
      const isMobile = window.matchMedia('(max-width: 640px)').matches;
      if (isMobile){
        document.body.classList.add('with-coach-pad');
      } else {
        document.body.classList.remove('with-coach-pad');
        el.style.right='16px'; el.style.bottom='24px';
      }
    }

    /* ========= Audio ========= */
    function getAudioCtx(){
      if(isMuted) return null;
      const AC=window.AudioContext||window.webkitAudioContext;
      if(!AC) return null;
      if(!audioCtx) audioCtx=new AC();
      if(audioCtx.state==='suspended'&&audioCtx.resume) audioCtx.resume();
      return audioCtx;
    }
    function unlockAudio(){
      if(audioUnlocked) return;
      const ctx=getAudioCtx(); if(!ctx) return;
      try{
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        o.start(ctx.currentTime); o.stop(ctx.currentTime+0.01);
        audioUnlocked=true;
      }catch{/* ignore */}
    }
    function tone(freq,dur,t,type='sine',gain=0.22){
      if(isMuted) return;
      const ctx=getAudioCtx(); if(!ctx) return;
      const start=(typeof t==='number')?t:ctx.currentTime;
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.type=type; o.frequency.setValueAtTime(freq,start);
      g.gain.setValueAtTime(gain,start);
      g.gain.exponentialRampToValueAtTime(0.001,start+dur);
      o.connect(g); g.connect(ctx.destination);
      o.start(start); o.stop(start+dur);
    }
    function playSelectTick(){const ctx=getAudioCtx(); if(!ctx) return; const t=ctx.currentTime; tone(440,0.06,t,'triangle',0.10);}
    function playSuccessSound(){const ctx=getAudioCtx(); if(!ctx) return; const t=ctx.currentTime; tone(523.25,0.12,t,'sine',0.22); tone(659.25,0.12,t+0.10,'sine',0.20); tone(783.99,0.14,t+0.20,'sine',0.18);}
    function playErrorSound(){const ctx=getAudioCtx(); if(!ctx) return; const t=ctx.currentTime; tone(220,0.10,t,'sawtooth',0.18); tone(180,0.12,t+0.10,'sawtooth',0.16);}
    function initAudioToggle(){
      const btn=$('#audioToggle'); if(!btn) return;
      try{isMuted=localStorage.getItem('soundMuted')==='true';}catch{}
      btn.setAttribute('aria-pressed',isMuted?'true':'false');
      btn.addEventListener('click',()=>{
        isMuted=!isMuted;
        btn.setAttribute('aria-pressed',isMuted?'true':'false');
        try{localStorage.setItem('soundMuted',String(isMuted));}catch{}
        if(!isMuted) unlockAudio();
      });
    }
    // ×§×œ×™×§ ×¢×œ ×¨×•×‘ ×”×›×¤×ª×•×¨×™× ×™× ×’×Ÿ ×˜×™×§ (×× ×œ× ××•×©×ª×§)
    document.addEventListener('click',e=>{
      const el=e.target.closest('button,.op-btn');
      if(!el||el.id==='audioToggle') return;
      if(el.disabled||el.getAttribute('aria-disabled')==='true') return;
      playSelectTick();
    });

    /* ========= Curriculum gating ========= */
    function applyCurriculumToOperationButtons(){
      const cur=curricula[currentCurriculum]; const allowed=cur&&cur.operations?cur.operations:null;
      $$('#opsGrid .op-btn').forEach(btn=>{
        const op=btn.getAttribute('data-op');
        const enabled = !allowed || op==='mixed' || allowed.includes(op);
        btn.classList.toggle('opacity-50',!enabled);
        btn.classList.toggle('pointer-events-none',!enabled);
        btn.classList.toggle('cursor-not-allowed',!enabled);
        btn.setAttribute('aria-disabled', enabled?'false':'true');
      });
    }

    /* ========= Build questions ========= */
    function getEffectiveRules(diff){
      const base=Object.assign({},rulesByDifficulty[diff]); const cur=curricula[currentCurriculum]||{};
      ['addSubMax','mulMax','divMaxDivisor','divMaxQuotient'].forEach(k=>{ if(typeof cur[k]!=='undefined') base[k]=cur[k]; });
      return base;
    }
    function getOpsList(selectedOp,cur){ if(selectedOp!=='mixed') return [selectedOp]; const allowed=cur&&cur.operations?cur.operations:null; return (allowed&&allowed.length)?allowed:['addition','subtraction','multiplication','division']; }
    function buildOpPool(op,rules,targetSize,diff){
      const pool=[]; let tries=0, max=6000;
      const mk=(text,ans,op,a,b,sym)=>({questionText:text,answer:ans,operation:op,num1:a,num2:b,symbol:sym});
      if(op==='addition'){ while(pool.length<targetSize&&tries++<max){ const flu=(diff==='easy')&&Math.random()<.5; const cap= flu? Math.min(10,rules.addSubMax) : rules.addSubMax; const a=randInt(0,cap), b=randInt(0,cap), ans=a+b; if(ans<=cap) pool.push(mk(`${a} + ${b} = ?`,ans,op,a,b,'+')); } }
      if(op==='subtraction'){ while(pool.length<targetSize&&tries++<max){ const flu=(diff==='easy')&&Math.random()<.5; const cap= flu? Math.min(10,rules.addSubMax) : rules.addSubMax; const a=randInt(0,cap), b=randInt(0,a), ans=a-b; if(ans>=0) pool.push(mk(`${a} - ${b} = ?`,ans,op,a,b,'-')); } }
      if(op==='multiplication'){ while(pool.length<targetSize&&tries++<max){ const a=randInt(1,rules.mulMax), b=randInt(1,rules.mulMax); pool.push(mk(`${a} Ã— ${b} = ?`,a*b,op,a,b,'Ã—')); } }
      if(op==='division'){ while(pool.length<targetSize&&tries++<max){ const d=randInt(1,rules.divMaxDivisor), q=randInt(1,rules.divMaxQuotient); const n=d*q; pool.push(mk(`${n} Ã· ${d} = ?`,q,op,q,d,'Ã·')); } }
      return pool;
    }
    function generatePracticeSet(operation,diff,count){
      const rules=getEffectiveRules(diff); const cur=curricula[currentCurriculum]; const ops=getOpsList(operation,cur);
      let pool=[]; ops.forEach(o=>pool=pool.concat(buildOpPool(o,rules,count*4,diff)));
      const map={}; pool.forEach(q=>{ if(!map[q.questionText]) map[q.questionText]=q; });
      return shuffle(Object.values(map)).slice(0,count);
    }
    function generateAnswerOptions(correct){
      const opts=[correct]; while(opts.length<4){ const wrong=correct+Math.floor(Math.random()*7)-3; if(wrong>0 && wrong!==correct && !opts.includes(wrong)) opts.push(wrong); } return shuffle(opts);
    }

    /* ========= Flow ========= */
    function showNameInput(){
      $('#welcomeScreen').classList.add('hidden');
      $('#nameScreen').classList.remove('hidden');
      hideCoach(); setTimeout(()=>$('#playerName')?.focus(),100);
    }
    function showOperationSelect(){
      const inp=$('#playerName'); const name=(inp?.value||'').trim(); if(!name){ alert('×× × ×”×›× ×¡ ××ª ×©××š'); inp?.focus(); return; }
      playerName=name;
      ['nameScreen','resultsScreen','mistakesScreen','tutorialScreen'].forEach(id=>$('#'+id)?.classList.add('hidden'));
      $('#operationScreen').classList.remove('hidden');
      applyCurriculumToOperationButtons();
      showCoach('×‘×—×¨ ×ª×¨×’×™×œ ×›×“×™ ×œ×”×ª×—×™×œ, '+playerName+'.','default');
    }
    function selectOperation(op){
      currentOperation=op;
      $('#operationScreen').classList.add('hidden');
      $('#difficultyScreen').classList.remove('hidden');
      showCoach('×‘×—×¨ ××¡×¤×¨ ×©××œ×•×ª ×•×¨××ª ×§×•×©×™, ×•××– ×”×ª×—×œ.','default');
    }

    function startGame(diff){
      currentDifficulty=diff; currentQuestionIndex=0; correctCount=0; totalTime=0; mistakes=[]; selectedAnswer=null;
      const curSel=$('#curriculumSelect'); currentCurriculum=curSel?curSel.value:'none';
      const qSel=$('#questionCountSelect'); questionCount=parseInt(qSel?qSel.value:'6',10)||6;

      questions=generatePracticeSet(currentOperation,diff,questionCount);
      if(!questions.length){ alert('×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ ×ª×¨×’×™×œ×™× ×¢×‘×•×¨ ×”×”×’×“×¨×•×ª ×©× ×‘×—×¨×•'); return; }

      totalQuestions=questions.length; $('#totalQuestions').textContent=totalQuestions; $('#resultsTotal').textContent=totalQuestions;
      ['difficultyScreen','resultsScreen','mistakesScreen','tutorialScreen'].forEach(id=>$('#'+id)?.classList.add('hidden'));
      $('#gameScreen').classList.remove('hidden');
      $('#gamePlayerName').textContent=playerName;

      const pb=$('#progressBar'); pb.style.width='0%'; pb.setAttribute('aria-valuenow','0');

      showQuestion();
      showCoach('×™×¦×× ×• ×œ×“×¨×š! ×§×¨× ××ª ×”×©××œ×”, ×‘×—×¨ ×ª×©×•×‘×” ×•××– ××©×¨.','game');
    }

    function showQuestion(){
      if(currentQuestionIndex>=questions.length){ showResults(); return; }
      selectedAnswer=null;
      const q=questions[currentQuestionIndex];
      $('#questionText').textContent=q.questionText;
      $('#currentQuestion').textContent=currentQuestionIndex+1;

      const prog=(currentQuestionIndex/totalQuestions)*100; const pb=$('#progressBar'); const p=Math.max(2,Math.round(prog)); pb.style.width=p+'%'; pb.setAttribute('aria-valuenow',String(p));

      const options=generateAnswerOptions(q.answer);
      const items=$$('#answersGrid .answer-item');
      options.forEach((opt,i)=>{ const el=items[i]; if(!el) return; el.setAttribute('data-value',String(opt)); el.setAttribute('data-idx',String(i)); el.querySelector('.tabular-nums').textContent=String(opt); el.classList.remove('selected'); el.setAttribute('aria-selected','false'); });

      disableConfirm();
      startTime=Date.now();
      placeCoach('game');
    }

    function enableConfirm(){
      const btn=$('#confirmButton');
      btn.disabled=false;
      btn.removeAttribute('disabled');
      btn.setAttribute('aria-disabled','false');
    }
    function disableConfirm(){
      const btn=$('#confirmButton');
      btn.disabled=true;
      btn.setAttribute('disabled','');
      btn.setAttribute('aria-disabled','true');
    }

    function confirmAnswer(){
      const btn=$('#confirmButton');
      if(btn.hasAttribute('disabled')) return;
      if(selectedAnswer===null) return;
      const correct=questions[currentQuestionIndex].answer;
      const end=Date.now(); totalTime+=(end-startTime)/1000;
      if(selectedAnswer===correct) { correctCount++; showFeedback(true); }
      else { mistakes.push({question:questions[currentQuestionIndex],userAnswer:selectedAnswer,correctAnswer:correct}); showFeedback(false); }
    }

    function showFeedback(ok){
      const fb=$('#feedback'), icon=$('#feedbackIcon'), text=$('#feedbackText'), nextBtn=$('#nextButton');
      const isLast=currentQuestionIndex===totalQuestions-1;
      if(ok){ icon.textContent='ğŸ‰'; text.className='text-2xl font-bold mb-6 text-green-600'; text.textContent=isLast?'××¢×•×œ×”! ×¡×™×™××ª ××ª ×”×¡×˜!':'×›×œ ×”×›×‘×•×“! ×ª×©×•×‘×” × ×›×•× ×”!'; playSuccessSound(); showCoach(isLast?'×¡×™×™×× ×• ××ª ×”×¡×˜. × ×¢×‘×•×¨ ×œ×¡×™×›×•×.':'×™×¤×”! ×œ×©××œ×” ×”×‘××”.','game'); }
      else{ icon.textContent='ğŸ’ª'; text.className='text-2xl font-bold mb-6 text-orange-600'; text.textContent=isLast?'×¡×™×™×× ×• ××ª ×”×¡×˜.':'×›××¢×˜! ×‘×©××œ×” ×”×‘××” ×ª×¦×œ×™×—!'; playErrorSound(); showCoach(isLast?'×¡×™×™×× ×• ××ª ×”×¡×˜. × ×¢×‘×•×¨ ×œ×¡×™×›×•×.':'×›××¢×˜! ×¢×•×‘×¨×™× ×œ×©××œ×” ×”×‘××”.','game'); }
      nextBtn.textContent=isLast?'×œ×¡×™×›×•× ×”×ª×¨×’×™×œ':'×”×©××œ×” ×”×‘××”';
      nextBtn.onclick=isLast?showResults:nextQuestion;
      fb.classList.remove('hidden');
    }
    function nextQuestion(){
      $('#feedback').classList.add('hidden');
      currentQuestionIndex++;
      if(currentQuestionIndex<totalQuestions){ showQuestion(); $('#confirmButton').focus(); }
      else { const pb=$('#progressBar'); pb.style.width='100%'; pb.setAttribute('aria-valuenow','100'); showResults(); }
    }

    function getResultsTitleCopy(name,pct){
      if (pct===0) return `×œ× × ×•×¨× ${name}, ×©×•×¤×™ ×‘×˜×•×— ×©×‘×¤×¢× ×”×‘××” ×ª×”×™×” ×ª×•×¦××” ×˜×•×‘×” ×™×•×ª×¨`;
      else if (pct<=40) return `${name} ×¨×•××™× ×©×™×¤×•×¨, ×©×•×¤×™ ××—×›×” ×œ×ª×¨×’×•×œ × ×•×¡×£`;
      else if (pct<=59) return `${name} ×¨×•××™× ×©×™×¤×•×¨, ×©×•×¤×™ ××—×›×” ×œ×ª×¨×’×•×œ × ×•×¡×£`;
      else if (pct<=79) return `${name} ×¢×‘×•×“×” ×˜×•×‘×”, ×©×•×¤×™ ××—×›×” ×œ×ª×¨×’×•×œ × ×•×¡×£`;
      else if (pct<=89) return `×•××•×• ${name}, ××™×–×• ×©×œ×™×˜×” × ××©×™×š ×œ×ª×¨×’×œ ×¢× ×©×•×¤×™`;
      return `×›×œ ×”×›×‘×•×“ ${name} ×©×•×¤×™ ×’××” ×‘×š!`;
    }

    function showResults(){
      ['gameScreen','mistakesScreen','tutorialScreen'].forEach(id=>$('#'+id)?.classList.add('hidden'));
      const rs=$('#resultsScreen'); rs.classList.remove('hidden');

      const incorrect=totalQuestions-correctCount;
      const pct=Math.round((correctCount/totalQuestions)*100);
      $('#resultsTitle').textContent=getResultsTitleCopy(playerName,pct);

      const msg=$('#performanceMessage'), icon=rs.querySelector('.text-8xl');
      if(correctCount===totalQuestions){ msg.textContent='××•×©×œ×! ×¢× ×™×ª × ×›×•×Ÿ ×¢×œ ×›×œ ×”×©××œ×•×ª! ğŸŒŸ'; msg.className='mb-4 font-medium text-lg text-green-600'; icon.textContent='ğŸ†'; confettiBurst(rs.querySelector('.bg-white')||rs); }
      else if(pct<50){ msg.textContent='× ×—×–×§ ××ª ×”×—×•×œ×©×•×ª ×•××—×¨ ×›×š × ×ª×¨×’×œ ×©×•×‘.'; msg.className='mb-4 font-medium text-lg text-orange-600'; icon.textContent='ğŸ’ª'; }
      else{ msg.textContent='×¢× ×™×ª × ×›×•×Ÿ ×¢×œ '+correctCount+' ××ª×•×š '+totalQuestions+' ×©××œ×•×ª - ×›×œ ×”×›×‘×•×“! ğŸ¯'; msg.className='mb-4 font-medium text-lg text-blue-600'; icon.textContent='ğŸ†'; }

      updatePerformanceBar(correctCount,incorrect,pct);
      $('#correctAnswers').textContent=String(correctCount);
      $('#averageTime').textContent=String(Math.max(1,Math.round(totalTime/totalQuestions)));
      $('#mistakesButton').classList.toggle('hidden', mistakes.length===0);

      showCoach('×¡×™×›×•× ×”×¡×˜ ×”×•×©×œ×. ××¤×©×¨ ×œ×ª×¨×’×œ ××—×“×© ××• ×œ×œ××•×“ ××”×˜×¢×•×™×•×ª.','default');
      placeCoach('default');
    }

    function updatePerformanceBar(correct,incorrect,pct){
      $('#correctBar').style.width=(correct/totalQuestions*100)+'%';
      $('#incorrectBar').style.width=(incorrect/totalQuestions*100)+'%';
      $('#performancePercentage').textContent=pct+'%';
      $('#correctCount').textContent=String(correct);
      $('#incorrectCount').textContent=String(incorrect);
    }

    function showMistakes(){
      $('#resultsScreen').classList.add('hidden'); $('#tutorialScreen').classList.add('hidden'); $('#mistakesScreen').classList.remove('hidden');
      const incorrect=totalQuestions-correctCount;
      $('#mistakesCorrectBar').style.width=((correctCount/totalQuestions)*100)+'%';
      $('#mistakesIncorrectBar').style.width=((incorrect/totalQuestions)*100)+'%';
      const mm=$('#mistakesMessage');
      if(mistakes.length===0){
        mm.textContent='××•×©×œ×! ×¢× ×™×ª × ×›×•×Ÿ ×¢×œ ×›×œ '+totalQuestions+' ×”×©××œ×•×ª! ğŸŒŸ';
        mm.className='text-lg text-green-600 font-medium mb-4';
        $('#mistakesList').innerHTML='<div class="text-center p-8"><div class="text-6xl mb-4">ğŸ‰</div><h3 class="text-2xl font-bold text-green-600">××¢×•×œ×”!</h3><p class="text-lg text-gray-600">×œ× ×”×™×• ×œ×š ×˜×¢×•×™×•×ª ×‘××©×—×§ ×”×–×”!</p></div>';
        return;
      } else if(correctCount>0){
        mm.textContent='×¢× ×™×ª × ×›×•×Ÿ ×¢×œ '+correctCount+' ××ª×•×š '+totalQuestions+' - ×‘×•××• × ×œ××“ ××”-'+mistakes.length+' ×©× ×©××¨×•';
        mm.className='text-lg text-blue-600 font-medium mb-4';
      } else {
        mm.textContent='×‘×•××• × ×œ××“ ×™×—×“ ××™×š ×œ×¤×ª×•×¨ ××ª ×”×©××œ×•×ª ×”××œ×”';
        mm.className='text-lg text-orange-600 font-medium mb-4';
      }

      const list=$('#mistakesList'); list.innerHTML='';
      questions.forEach((q,i)=>{
        const m=mistakes.find(x=>x.question.questionText===q.questionText); if(!m) return;
        const d=document.createElement('div');
        d.className='bg-orange-50 border-2 border-orange-200 rounded-2xl p-6 cursor-pointer hover:bg-orange-100 transition-colors';
        d.onclick=()=>showTutorial(m);
        d.innerHTML='<div class="flex items-center justify-between mb-4"><div class="flex items-center gap-3"><div class="w-4 h-4 bg-orange-500 rounded-full"></div><h3 class="text-xl font-bold text-orange-600">×©××œ×” '+(i+1)+'</h3></div><div class="text-2xl">ğŸ¤”</div></div><div class="text-2xl font-bold text-gray-800 mb-4 ltr">'+m.question.questionText+'</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div class="bg-red-100 border-2 border-red-300 rounded-xl p-4"><div class="text-sm text-red-600 font-bold mb-1">×”×ª×©×•×‘×” ×©×œ×š:</div><div class="text-xl font-bold text-red-700 ltr">'+m.userAnswer+'</div></div><div class="bg-green-100 border-2 border-green-300 rounded-xl p-4"><div class="text-sm text-green-600 font-bold mb-1">×”×ª×©×•×‘×” ×”× ×›×•× ×”:</div><div class="text-xl font-bold text-green-700 ltr">'+m.correctAnswer+'</div></div></div><div class="text-center text-blue-600 font-bold">ğŸ‘† ×œ×—×¥ ×›××Ÿ ×›×“×™ ×œ×œ××•×“ ××™×š ×œ×¤×ª×•×¨</div>';
        list.appendChild(d);
      });
      showCoach('×œ×—×¥ ×¢×œ ×©××œ×” ×›×“×™ ×œ×¨××•×ª ×”×¡×‘×¨ ××™× ×˜×¨××§×˜×™×‘×™.','default');
    }

    function showTutorial(m){
      $('#mistakesScreen').classList.add('hidden'); $('#tutorialScreen').classList.remove('hidden');
      const q=m.question; const title=$('#tutorialTitle'); title.textContent=q.questionText;
      createTutorialSteps(q); createInteractiveDemo(q);
      requestAnimationFrame(()=>{ title.focus({preventScroll:true}); window.scrollTo({top:0,behavior:'auto'}); });
      showCoach('×”× ×” ×”×¡×‘×¨ ×¦×¢×“Ö¾××—×¨Ö¾×¦×¢×“. × ×¡×” ××ª ×”××–×•×¨ ×”××™× ×˜×¨××§×˜×™×‘×™.','default');
    }

    function createTutorialSteps(q){
      const c=$('#tutorialSteps'); c.innerHTML='';
      getTutorialSteps(q).forEach((s,i)=>{
        const d=document.createElement('div');
        d.className='bg-blue-50 border-2 border-blue-200 rounded-2xl p-6';
        d.innerHTML='<div class="flex items-center mb-4"><div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">'+(i+1)+'</div><h3 class="text-xl font-bold text-blue-600">'+s.title+'</h3></div><p class="text-gray-700 text-lg">'+s.description+'</p>';
        c.appendChild(d);
      });
    }
    function getTutorialSteps(q){
      const {operation,num1,num2,answer}=q;
      if(operation==='addition') return[
        {title:'×”×‘× ×ª ×”×©××œ×”',description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” '+num1+' + '+num2+'.'},
        {title:'×”×¦×’×ª ×”×¤×¨×™×˜×™× ×”×¨××©×•× ×™×',description:'× ×ª×—×™×œ ×¢× '+num1+' ×¤×¨×™×˜×™×.'},
        {title:'×”×•×¡×¤×ª ×¤×¨×™×˜×™×',description:'× ×•×¡×™×£ '+num2+' ×•× ×× ×” ×”×›×•×œ ×™×—×“.'},
        {title:'×”×ª×•×¦××”',description:'×™×© '+answer+' ×¤×¨×™×˜×™×. ×–×• ×”×ª×©×•×‘×”!'}
      ];
      if(operation==='subtraction') return[
        {title:'×”×‘× ×ª ×”×©××œ×”',description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” '+num1+' - '+num2+'.'},
        {title:'×”×¦×’×ª ×”×¤×¨×™×˜×™× ×”×¨××©×•× ×™×',description:'× ×ª×—×™×œ ×¢× '+num1+' ×¤×¨×™×˜×™×.'},
        {title:'×”×¡×¨×ª ×¤×¨×™×˜×™×',description:'× ×¡×™×¨ '+num2+' ×•× ×× ×” ×›××” × ×©××¨.'},
        {title:'×”×ª×•×¦××”',description:'× ×©××¨×• '+answer+' ×¤×¨×™×˜×™×.'}
      ];
      if(operation==='multiplication') return[
        {title:'×”×‘× ×ª ×”×©××œ×”',description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” '+num1+' Ã— '+num2+'.'},
        {title:'×™×¦×™×¨×ª ×§×‘×•×¦×•×ª',description:'× ×™×¦×•×¨ '+num1+' ×§×‘×•×¦×•×ª ×©×œ '+num2+'.'},
        {title:'×¡×¤×™×¨×”',description:'× ×¡×¤×•×¨ ××ª ×›×œ ×”×¤×¨×™×˜×™×.'},
        {title:'×”×ª×•×¦××”',description:'×™×© '+answer+' ×¤×¨×™×˜×™× ×‘×¡×š ×”×›×•×œ.'}
      ];
      if(operation==='division'){ const dividend=parseInt(q.questionText.split(' Ã· ')[0],10); const divisor=q.num2; return[
        {title:'×”×‘× ×ª ×”×©××œ×”',description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” '+dividend+' Ã· '+divisor+'.'},
        {title:'×”×¦×’×ª ×›×œ ×”×¤×¨×™×˜×™×',description:'× ×ª×—×™×œ ×¢× '+dividend+' ×¤×¨×™×˜×™×.'},
        {title:'×—×œ×•×§×” ×œ×§×‘×•×¦×•×ª',description:'× ×—×œ×§ ×œ×§×‘×•×¦×•×ª ×©×œ '+divisor+'.'},
        {title:'×”×ª×•×¦××”',description:'×§×™×‘×œ× ×• '+answer+' ×§×‘×•×¦×•×ª.'}
      ]; }
      return [];
    }
    function createInteractiveDemo(q){
      const area=$('#interactiveContent'), info=$('#interactiveInstructions'); area.innerHTML='';
      const {operation,num1,num2,answer}=q;
      const em=['ğŸ','ğŸˆ','â­','ğŸŒŸ','ğŸŠ','ğŸ¯','ğŸŒˆ','ğŸª'][Math.floor(Math.random()*8)];
      if(operation==='addition'){
        let clicked=0,total=answer;
        for(let i=0;i<total;i++){
          const s=document.createElement('span'); s.className='text-3xl m-1 opacity-50 cursor-pointer'; s.textContent=i<num1?'ğŸ”µ':'ğŸŸ¡';
          s.onclick=function(){ if(this.style.opacity!=='1'){ this.style.opacity='1'; clicked++; info.textContent=clicked===total?('××¢×•×œ×”! ×¡×¤×¨×ª '+total+' ×¤×¨×™×˜×™× - ×–×• ×”×ª×©×•×‘×”! ğŸ‰'):('×”××©×š ×œ×¡×¤×•×¨... ('+clicked+'/'+total+')'); } };
          area.appendChild(s); if(((i+1)%5===0)&&i<total-1) area.appendChild(document.createElement('br'));
        }
        info.textContent='×œ×—×¥ ×¢×œ ×”×›×“×•×¨×™× ×›×“×™ ×œ×¡×¤×•×¨ ××ª '+num1+' + '+num2; return;
      }
      if(operation==='subtraction'){
        let removed=0;
        for(let i=0;i<num1;i++){
          const s2=document.createElement('span'); s2.className='text-3xl m-1 cursor-pointer'; s2.textContent=em;
          s2.onclick=function(){ if(this.style.opacity!=='0.3'&&removed<num2){ this.style.opacity='0.3'; this.style.textDecoration='line-through'; removed++; info.textContent=removed===num2?('××¢×•×œ×”! ×”×¡×¨×ª '+num2+' ×¤×¨×™×˜×™×; × ×©××¨×• '+answer+'. ğŸ‰'):('×œ×—×¥ ×¢×œ ×¢×•×“ '+(num2-removed)); } };
          area.appendChild(s2); if(((i+1)%5===0)&&i<num1-1) area.appendChild(document.createElement('br'));
        }
        info.textContent='×œ×—×¥ ×¢×œ '+num2+' ×¤×¨×™×˜×™× ×›×“×™ ×œ×”×¡×™×¨ ××ª×•×š '+num1; return;
      }
      if(operation==='multiplication'){
        let shown=0;
        for(let g=0; g<num1; g++){
          const group=document.createElement('div'); group.className='inline-block border-2 border-dashed border-blue-300 rounded-lg p-3 m-2 bg-blue-50'; group.style.opacity='0.5';
          const label=document.createElement('div'); label.className='text-sm font-bold text-blue-600 mb-2 text-center'; label.textContent='×§×‘×•×¦×” '+(g+1); group.appendChild(label);
          for(let i=0;i<num2;i++){ const sp=document.createElement('span'); sp.className='text-2xl m-1'; sp.textContent=em; group.appendChild(sp); }
          group.onclick=function(){ if(this.style.opacity==='0.5'){ this.style.opacity='1'; shown++; info.textContent=(shown===num1)?('××¢×•×œ×”! '+num1+'Ã—'+num2+' = '+answer+'. ğŸ‰'):('× ×”×“×¨! ×œ×—×¥ ×¢×œ ×¢×•×“ '+(num1-shown)+' ×§×‘×•×¦×•×ª'); } };
          area.appendChild(group);
        }
        info.textContent='×œ×—×¥ ×¢×œ ×”×§×‘×•×¦×•×ª ×›×“×™ ×œ×¨××•×ª '+num1+' ×§×‘×•×¦×•×ª ×©×œ '+num2; return;
      }
      if(operation==='division'){
        let shown2=0; const dividend=parseInt(q.questionText.split(' Ã· ')[0],10);
        for(let g=0; g<answer; g++){
          const group2=document.createElement('div'); group2.className='inline-block border-2 border-dashed border-purple-300 rounded-lg p-3 m-2 bg-purple-50'; group2.style.opacity='0.5';
          const label2=document.createElement('div'); label2.className='text-sm font-bold text-purple-600 mb-2 text-center'; label2.textContent='×§×‘×•×¦×” '+(g+1); group2.appendChild(label2);
          for(let i=0;i<num2;i++){ const sp2=document.createElement('span'); sp2.className='text-2xl m-1'; sp2.textContent=em; group2.appendChild(sp2); }
          group2.onclick=function(){ if(this.style.opacity==='0.5'){ this.style.opacity='1'; shown2++; info.textContent=(shown2===answer)?('××¢×•×œ×”! ×—×™×œ×§×ª '+dividend+' ×œ-'+answer+' ×§×‘×•×¦×•×ª ×©×œ '+num2+'. ğŸ‰'):('× ×”×“×¨! ×œ×—×¥ ×¢×œ ×¢×•×“ '+(answer-shown2)+' ×§×‘×•×¦×•×ª'); } };
          area.appendChild(group2);
        }
        info.textContent='×œ×—×¥ ×¢×œ ×”×§×‘×•×¦×•×ª ×›×“×™ ×œ×¨××•×ª ×—×œ×•×§×” ×œ-'+answer+' ×§×‘×•×¦×•×ª ×©×œ '+num2;
      }
    }

    /* ========= Answer grid (delegation) ========= */
    function bindAnswerGrid(){
      const grid=$('#answersGrid'); if(!grid) return;
      grid.addEventListener('click',e=>{ const item=e.target.closest('.answer-item'); if(!item||!grid.contains(item)) return; chooseItem(item); });
      grid.addEventListener('keydown',e=>{ const item=e.target.closest('.answer-item'); if(!item||!grid.contains(item)) return; if(e.key==='Enter'||e.key===' '){ e.preventDefault(); chooseItem(item);} });
      function chooseItem(item){
        $$('#answersGrid .answer-item').forEach(it=>{ it.classList.remove('selected'); it.setAttribute('aria-selected','false'); });
        item.classList.add('selected'); item.setAttribute('aria-selected','true');
        selectedAnswer=parseInt(item.getAttribute('data-value'),10);
        enableConfirm();
        playSelectTick();
      }
    }

    /* ========= Confetti ========= */
    function confettiBurst(container){
      try{ if(window.matchMedia&&window.matchMedia('(prefers-reduced-motion: reduce)').matches) return; }catch{}
      const n=28; for(let i=0;i<n;i++){
        const dot=document.createElement('span');
        dot.style.position='absolute'; dot.style.width='8px'; dot.style.height='8px'; dot.style.borderRadius='50%';
        dot.style.left='50%'; dot.style.top='10%';
        const colors=['#22c55e','#3b82f6','#f59e0b','#ef4444','#a855f7']; dot.style.background=colors[i%colors.length];
        const angle=(i/n)*Math.PI*2, dist=80+Math.random()*50, tx=Math.cos(angle)*dist, ty=Math.sin(angle)*dist;
        const anim=dot.animate([{transform:'translate(-50%,-50%) scale(1)',opacity:1},{transform:'translate('+(tx-50)+'%,'+(ty-50)+'%) scale(.9)',opacity:0}],{duration:900,easing:'cubic-bezier(.2,.8,.2,1)'});
        anim.onfinish=()=>dot.remove();
        (container||document.body).appendChild(dot);
      }
    }

    /* ========= Init ========= */
    document.addEventListener('DOMContentLoaded',()=>{
      // ×¤×ª×™×—×ª ××•×“×™×• ×‘××—×•×•×” ×”×¨××©×•× ×” ××›×œ ××§×•×
      document.addEventListener('pointerdown', unlockAudio, { once: true });

      // × ×™×•×•×˜ ×¨××©×•× ×™
      $('#startBtn')?.addEventListener('click',e=>{e.preventDefault(); showNameInput();});
      $('#nameForm')?.addEventListener('submit',e=>{e.preventDefault(); showOperationSelect();});
      // ×ª×•×›× ×™×ª ×œ×™××•×“
      $('#curriculumSelect')?.addEventListener('change',e=>{ currentCurriculum=e.target.value; applyCurriculumToOperationButtons(); });
      // ×‘×—×™×¨×ª ×ª×¨×’×™×œ
      $$('#opsGrid .op-btn').forEach(b=>b.addEventListener('click',()=>{ selectOperation(b.getAttribute('data-op')); }));
      // ×¨××ª ×§×•×©×™
      $$('#difficultyScreen .diff-btn').forEach(b=>b.addEventListener('click',()=>{ startGame(b.getAttribute('data-diff')); }));
      $('#questionCountSelect')?.addEventListener('change',e=>{ questionCount=parseInt(e.target.value,10)||6; });

      // ×ª×©×•×‘×•×ª
      bindAnswerGrid();
      // ××™×©×•×¨ ×ª×©×•×‘×”
      $('#confirmButton')?.addEventListener('click',e=>{ if(e.currentTarget.hasAttribute('disabled')){ e.preventDefault(); return; } confirmAnswer(); });

      // ×ª×•×¦××•×ª: ×××–×™× ×™×
      $('#retryBtn')?.addEventListener('click',()=> startGame(currentDifficulty));
      $('#mistakesButton')?.addEventListener('click',showMistakes);
      $('#altBtn')?.addEventListener('click',showOperationSelect);

      // ×˜×¢×•×™×•×ª/×”×“×¨×›×” ×—×–×¨×” ×•×¨×™×¡×˜××¨×˜
      $('#backToResults')?.addEventListener('click',()=>{ $('#mistakesScreen').classList.add('hidden'); $('#resultsScreen').classList.remove('hidden'); showCoach('×—×–×¨×” ×œ×¡×™×›×•×.','default'); });
      $('#restartBtn')?.addEventListener('click',()=>location.reload());
      $('#restartFromMistakes')?.addEventListener('click',()=>location.reload());
      $('#restartFromTutorial')?.addEventListener('click',()=>location.reload());
      $('#backToMistakes')?.addEventListener('click',()=>{ $('#tutorialScreen').classList.add('hidden'); $('#mistakesScreen').classList.remove('hidden'); showCoach('×—×–×¨×” ×œ×¨×©×™××ª ×”×˜×¢×•×™×•×ª.','default'); });

      // ×©×•×¤×™ â€“ ×¡×’×™×¨×”
      $('#coachClose')?.addEventListener('click',()=>{ coachHidden=true; hideCoach(); });

      // ××•×“×™×•
      initAudioToggle();

      // ×”×¦×’×ª ×©×•×¤×™ ×‘××¡×š ×¤×ª×™×—×” ×¢× ×”×§×•×¤×™ ×”×—×“×©
      showCoach('×× ×™ ×©×•×¤×™ ! ××™×–×” ×›×™×£ ×›×‘×¨ ××ª×—×™×œ×™×','default');

      // ×¨×¡×¤×•× ×¡×™×‘×™×•×ª â€“ ×¢×“×›×•×Ÿ ××™×§×•× ×©×•×¤×™
      window.addEventListener('resize', ()=>{
        const ctx = (!$('#gameScreen').classList.contains('hidden')) ? 'game' : 'default';
        placeCoach(ctx);
      });
    });
  </script>
</body>
</html>
