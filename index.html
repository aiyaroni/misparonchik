<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>מספרונצ'יק - משחק חשבון לימודי</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');
    body{font-family:'Assistant',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .ltr{direction:ltr;unicode-bidi:embed;display:inline-block}
    .tabular-nums{font-variant-numeric:tabular-nums}
    .owl-blink{animation:blink 2s infinite}
    @keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.1)}}

    /* ===== כותרות משנה ===== */
    .subhead{
      font-weight:800;
      font-size:clamp(1.375rem, 1.05rem + 1.2vw, 1.75rem);
      line-height:1.25;
      color:#1f2937;
      letter-spacing:-.01em;
    }

    /* תשובות (גריד המשחק) */
    .answer-item{position:relative;transition:transform .14s,box-shadow .14s,border-color .14s;cursor:pointer;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;background:rgba(255,255,255,.96);border-radius:1rem;border:2px solid transparent;outline:none}
    .answer-item::before{content:"";position:absolute;inset:0;border-radius:inherit;pointer-events:none;background:var(--tint,transparent);opacity:.08}
    .answer-item .accent{display:none;position:absolute;right:0;top:0;bottom:0;width:8px;border-radius:0 1rem 1rem 0;opacity:.55;background:var(--tint);pointer-events:none}
    .answer-item[data-idx="0"]{--tint:#f87171}
    .answer-item[data-idx="1"]{--tint:#60a5fa}
    .answer-item[data-idx="2"]{--tint:#4ade80}
    .answer-item[data-idx="3"]{--tint:#facc15}
    .answer-item:active{transform:scale(.98)}
    .answer-item.selected{border-color:#2563eb;box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .answer-item.selected .accent{display:block}

    .confirm-button{transition:all .25s}
    .confirm-button[disabled]{opacity:.5;cursor:not-allowed}

    /* כרטיסיות בחירה (תכנית לימוד / סוג תרגיל) */
    .choice-card{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.25rem;
      background:rgba(255,255,255,.96); border:2px solid transparent; border-radius:1.25rem; padding:1.25rem;
      box-shadow:0 10px 26px rgba(0,0,0,.12); transition:.18s; cursor:pointer; outline:none; user-select:none}
    .choice-card .accent{display:none;position:absolute;right:0;top:0;bottom:0;width:8px;border-radius:0 1.25rem 1.25rem 0;opacity:.55;pointer-events:none}
    .choice-card[data-tint="green"]{--tint:#22c55e}
    .choice-card[data-tint="blue"]{--tint:#3b82f6}
    .choice-card[data-tint="purple"]{--tint:#a855f7}
    .choice-card[data-tint="orange"]{--tint:#f59e0b}
    .choice-card[data-tint="pink"]{--tint:#ec4899}
    .choice-card:hover{transform:translateY(-2px)}
    .choice-card:active{transform:scale(.98)}
    .choice-card.selected{border-color:#2563eb; box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .choice-card.selected .accent{display:block; background:var(--tint,#3b82f6)}
    .choice-card .emoji{font-size:2rem}

    /* ===== צ’יפים לבחירת מספר השאלות – מיושרים למרכז ===== */
    .chips{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center}
    .chip{min-width:64px; min-height:48px; display:inline-flex; align-items:center; justify-content:center;
      border:2px solid #e5e7eb; background:white; border-radius:1rem; padding:.25rem .75rem;
      font-weight:700; font-size:1.15rem; cursor:pointer; transition:.16s}
    .chip:hover{transform:translateY(-2px)}
    .chip.selected{border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.20)}

    /* וידג׳ט שופי – דסקטופ: בועה צפה */
    #coach{position:fixed;right:16px;bottom:24px;z-index:40;display:none}
    #coach .coach-inner{display:flex;align-items:flex-start;gap:.75rem;background:rgba(255,255,255,.95);backdrop-filter:blur(6px);border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.18);padding:.75rem 1rem;border:1px solid #e5e7eb;max-width:min(90vw,360px)}
    #coachClose{position:absolute;top:6px;right:8px;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;border-radius:9999px;background:transparent;border:none;cursor:pointer;color:#4b5563}
    #coachClose:hover{background:rgba(0,0,0,.06);color:#111827}

    /* מובייל: בר תחתון דביק */
    @media (max-width:640px){
      #coach{
        position:fixed;left:0;right:0;bottom:0;z-index:40;display:none;
        padding:0 12px calc(12px + env(safe-area-inset-bottom));
      }
      #coach .coach-inner{
        width:100%;max-width:none;border-radius:16px 16px 0 0;
        box-shadow:0 -8px 20px rgba(0,0,0,.12);
      }
      body.with-coach-pad{padding-bottom:calc(96px + env(safe-area-inset-bottom))}
    }

    /* כפתור השתקת אודיו */
    #audioToggle{padding:.5rem .7rem;border-radius:9999px;background:rgba(255,255,255,.95);border:1px solid #e5e7eb;box-shadow:0 6px 20px rgba(0,0,0,.12)}
    #audioToggle[aria-pressed="true"] .muted{display:inline}
    #audioToggle[aria-pressed="true"] .unmuted{display:none}
    #audioToggle[aria-pressed="false"] .muted{display:none}
    #audioToggle[aria-pressed="false"] .unmuted{display:inline}

    /* חתימה */
    .site-signature{ text-align:center;color:#6b7280;font-size:.875rem;line-height:1.6; margin-top:1.25rem;margin-bottom:1.25rem }
    @media (min-width:640px){ .site-signature{font-size:1rem;margin-top:2rem;margin-bottom:2rem} }
    .site-signature a{color:#4b5563;text-decoration:underline}
    .site-signature a:hover{color:#111827}
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-50 to-green-100 min-h-screen">
  <!-- Welcome Screen -->
  <div id="welcomeScreen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-6xl mb-4 owl-blink">🦉</div>
      <h1 id="welcomeTitle" tabindex="-1" class="text-4xl font-bold text-purple-600 mb-4">מספרונצ'יק</h1>
      <p class="text-2xl text-gray-700 mb-8">בואו ללמוד חשבון עם שופי הינשוף</p>
      <button type="button" id="startBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">התחל משחק</button>
    </div>
    <footer class="site-signature px-4">
      <div>© 2025 yaroni studio - תוכן חזק, עובד חכם ומבוסס על בינה</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Name Input Screen -->
  <div id="nameScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <form id="nameForm" class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-5xl mb-4">👋</div>
      <h2 id="nameTitle" tabindex="-1" class="text-3xl font-bold text-blue-600 mb-6">איך קוראים לך?</h2>
      <input type="text" id="playerName" name="playerName" required placeholder="הכנס את שמך כאן" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-6 text-center focus:border-blue-500 focus:outline-none">
      <button type="submit" class="bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-blue-600 hover:to-green-600 transform hover:scale-105 transition-all duration-200 shadow-lg">המשך</button>
    </form>
  </div>

  <!-- Curriculum Selection Screen -->
  <div id="curriculumScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-3xl w-full">
      <div class="text-5xl mb-4">📚</div>
      <h2 id="curriculumTitle" tabindex="-1" class="text-3xl md:text-4xl font-extrabold text-green-600 mb-2 leading-tight">יש לבחור תכנית לימוד</h2>
      <p class="subhead mb-6">בחרו את התכנית המתאימה, ואז לחצו על "המשך"</p>

      <div id="curriculumGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <button type="button" class="choice-card" data-tint="blue" data-value="none" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">🎯</div>
          <div class="text-xl font-bold text-gray-800">ללא תוכנית</div>
          <div class="text-sm text-gray-500">בחירה חופשית</div>
        </button>

        <button type="button" class="choice-card" data-tint="green" data-value="il_g1_s1" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">🌱</div>
          <div class="text-xl font-bold text-gray-800">כיתה א׳, מחצית א׳</div>
          <div class="text-sm text-gray-500">עד 10</div>
        </button>

        <button type="button" class="choice-card" data-tint="green" data-value="il_g1_s2" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">🌿</div>
          <div class="text-xl font-bold text-gray-800">כיתה א׳, מחצית ב׳</div>
          <div class="text-sm text-gray-500">עד 20</div>
        </button>

        <button type="button" class="choice-card" data-tint="green" data-value="il_g1_adv" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">✨</div>
          <div class="text-xl font-bold text-gray-800">כיתה א׳, אתגר</div>
          <div class="text-sm text-gray-500">עד 30</div>
        </button>

        <button type="button" class="choice-card" data-tint="blue" data-value="il_g2" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">🧩</div>
          <div class="text-xl font-bold text-gray-800">כיתה ב׳</div>
          <div class="text-sm text-gray-500">עד 100</div>
        </button>

        <button type="button" class="choice-card" data-tint="purple" data-value="il_g3" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">✖️</div>
          <div class="text-xl font-bold text-gray-800">כיתה ג׳</div>
          <div class="text-sm text-gray-500">עד 100; כפל/חילוק 10×10</div>
        </button>

        <button type="button" class="choice-card" data-tint="orange" data-value="il_g4" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">🚀</div>
          <div class="text-xl font-bold text-gray-800">כיתה ד׳</div>
          <div class="text-sm text-gray-500">עד 1000; כפל/חילוק 12×12</div>
        </button>
      </div>

      <button id="curriculumNext" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50" disabled aria-disabled="true">המשך</button>
    </div>
  </div>

  <!-- Operation + Question Count Screen -->
  <div id="operationScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-3xl w-full">
      <div class="text-5xl mb-4">🎯</div>
      <h2 id="operationTitle" tabindex="-1" class="text-3xl md:text-4xl font-extrabold text-green-600 mb-2 leading-tight">עכשיו יש לבחור את סוג התרגילים</h2>
      <h3 class="subhead mb-6">בחרו סוג תרגיל ומספר שאלות</h3>

      <div id="opsGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8">
        <button type="button" data-op="addition" class="choice-card op-btn" data-tint="green" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">➕</div>
          <div class="text-xl font-bold">חיבור</div>
        </button>
        <button type="button" data-op="subtraction" class="choice-card op-btn" data-tint="pink" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">➖</div>
          <div class="text-xl font-bold">חיסור</div>
        </button>
        <button type="button" data-op="multiplication" class="choice-card op-btn" data-tint="purple" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">✖️</div>
          <div class="text-xl font-bold">כפל</div>
        </button>
        <button type="button" data-op="division" class="choice-card op-btn" data-tint="orange" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">➗</div>
          <div class="text-xl font-bold">חילוק</div>
        </button>
        <button type="button" data-op="mixed" class="choice-card op-btn col-span-2 sm:col-span-1" data-tint="blue" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">🎲</div>
          <div class="text-xl font-bold">הכל</div>
        </button>
      </div>

      <!-- יישור למרכז: גם הכותרת וגם הבחירה -->
      <div class="mb-2">
        <div class="subhead mb-3 text-center">מספר שאלות בסט</div>
        <div id="questionChips" class="chips">
          <button type="button" class="chip" data-count="6" aria-pressed="false">6</button>
          <button type="button" class="chip" data-count="8" aria-pressed="false">8</button>
          <button type="button" class="chip" data-count="10" aria-pressed="false">10</button>
        </div>
      </div>

      <div class="mt-6">
        <button id="operationNext" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50" disabled aria-disabled="true">המשך</button>
      </div>
    </div>
  </div>

  <!-- Difficulty Selection Screen -->
  <div id="difficultyScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
      <div class="text-5xl mb-4">⚡</div>
      <h2 id="difficultyTitle" tabindex="-1" class="text-3xl sm:text-4xl font-bold text-blue-600 mb-6">איזו רמת קושי מתאימה לך היום?</h2>

      <div class="flex flex-col gap-4 mb-2">
        <button type="button" data-diff="easy" class="choice-card diff-btn" data-tint="green" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">🌱</div>
          <div class="text-xl font-bold">קל</div>
        </button>
        <button type="button" data-diff="medium" class="choice-card diff-btn" data-tint="orange" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">🔥</div>
          <div class="text-xl font-bold">בינוני</div>
        </button>
        <button type="button" data-diff="hard" class="choice-card diff-btn" data-tint="purple" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">⚡</div>
          <div class="text-xl font-bold">מתקדם</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="hidden min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6 mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-4">
        <div class="text-2xl font-bold text-purple-600">שאלה <span id="currentQuestion" class="ltr">1</span> מתוך <span id="totalQuestions" class="ltr">6</span></div>
        <div class="text-xl text-gray-600">שלום <span id="gamePlayerName"></span>! 👋</div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4" aria-hidden="true">
        <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 mx-auto max-w-lg text-center">
      <div class="text-5xl mb-4 owl-blink">🦉</div>
      <div id="questionText" tabindex="-1" class="text-3xl font-bold text-gray-800 mb-6 ltr">5 + 3 = ?</div>
      <div class="subhead text-gray-700 mb-4">יש לבחור את התשובה הנכונה</div>
    </div>

    <!-- תשובות 2×2 -->
    <div id="answersGrid" class="grid grid-cols-2 gap-4 max-w-lg mx-auto px-4 mb-6">
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="6" data-idx="0" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">6</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="8" data-idx="1" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">8</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="7" data-idx="2" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">7</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="5" data-idx="3" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">5</div>
      </div>
    </div>

    <div class="text-center space-y-4 pb-6">
      <button id="confirmButton" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold transition-all duration-200 shadow-lg" disabled aria-disabled="true">אשר תשובה</button>
      <button type="button" id="restartBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
    </div>

    <!-- Feedback Modal (רק לסוף הסט) -->
    <div id="feedback" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div role="dialog" aria-modal="true" aria-labelledby="feedbackText" class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
        <div id="feedbackIcon" class="text-8xl mb-4">🎉</div>
        <div id="feedbackText" aria-live="polite" class="text-2xl font-bold mb-6">כל הכבוד!</div>
        <button id="nextButton" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">לסיכום התוצאות</button>
      </div>
    </div>
  </div>

  <!-- Results Screen -->
  <div id="resultsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full relative overflow-hidden">
      <div class="text-8xl mb-4">🏆</div>
      <h2 id="resultsTitle" tabindex="-1" class="text-3xl font-bold text-green-600 mb-4">כל הכבוד!</h2>
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">הביצועים שלך:</span>
          <span id="performancePercentage" class="text-sm font-bold text-blue-600 ltr">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div id="performanceBar" class="h-6 rounded-full transition-all duration-1000 flex" aria-label="Progress indicator">
            <div id="correctBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
            <div id="incorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <span class="text-green-600 font-medium">✓ נכונות: <span id="correctCount" class="ltr">0</span></span>
          <span class="text-orange-600 font-medium">✗ שגויות: <span id="incorrectCount" class="ltr">0</span></span>
        </div>
      </div>
      <div class="text-xl text-gray-700 mb-6">
        <div id="performanceMessage" class="mb-4 font-medium text-lg">סיימת את הסט! 🎯</div>
        <div class="mb-2">תשובות נכונות: <span id="correctAnswers" class="font-bold text-green-600 ltr">0</span>/<span id="resultsTotal" class="ltr">6</span></div>
        <div class="mb-4">זמן ממוצע: <span id="averageTime" class="font-bold text-blue-600 ltr">0</span> שניות</div>
      </div>
      <div class="flex flex-col gap-4">
        <button id="retryBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">אני רוצה לתרגל מחדש</button>
        <button id="mistakesButton" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">ללמוד מהטעויות</button>
        <button id="altBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">בא לי תרגול אחר</button>
      </div>
    </div>
    <footer class="site-signature px-4">
      <div>© 2025 yaroni studio - תוכן חזק, עובד חכם ומבוסס על בינה</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Mistakes Review Screen -->
  <div id="mistakesScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">📚</div>
        <h2 id="mistakesTitle" tabindex="-1" class="text-3xl font-bold text-orange-600 mb-4">למד מהטעויות</h2>
        <div class="mb-6 max-w-md mx-auto">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mb-3">
            <div id="mistakesPerformanceBar" class="h-4 rounded-full transition-all duration-1000 flex" aria-label="Performance summary">
              <div id="mistakesCorrectBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
              <div id="mistakesIncorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>
          <div id="mistakesMessage" class="subhead text-gray-700 mb-4">הנה התרגילים שבהם טעית</div>
        </div>
        <p class="text-lg text-gray-600">לחץ על כל תרגיל כדי ללמוד איך לפתור אותו:</p>
      </div>
      <div id="mistakesList" class="space-y-6 mb-8"></div>
      <div class="text-center space-y-4">
        <button id="backToResults" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">חזור לתוצאות</button>
        <button type="button" id="restartFromMistakes" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
      </div>
    </div>
  </div>

  <!-- Tutorial Screen -->
  <div id="tutorialScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">🎓</div>
        <h2 id="tutorialTitle" tabindex="-1" class="text-3xl font-bold text-blue-600 mb-4 ltr">7 ÷ 5 = ?</h2>
        <p class="text-lg text-gray-600">בואו נלמד יחד איך לפתור את השאלה הזו!</p>
      </div>
      <div id="tutorialSteps" class="space-y-8 mb-8"></div>
      <div id="interactiveArea" class="bg-blue-50 rounded-2xl p-6 mb-8 text-center">
        <h3 class="subhead text-blue-600 mb-4">נסה בעצמך!</h3>
        <div id="interactiveContent" class="flex flex-wrap justify-center gap-2 mb-4"></div>
        <div id="interactiveInstructions" role="status" aria-live="polite" class="text-gray-600">לחץ על הפריטים כדי לראות איך הפתרון עובד</div>
      </div>
      <div class="flex justify-center gap-4 flex-wrap">
        <button id="backToMistakes" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">חזור לרשימת הטעויות</button>
        <button type="button" id="restartFromTutorial" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
      </div>
    </div>
  </div>

  <!-- Shufi Coach Widget -->
  <div id="coach" aria-live="polite">
    <div class="coach-inner relative">
      <div class="text-3xl mr-1" aria-hidden="true">🦉</div>
      <p id="coachMsg" class="text-base sm:text-lg text-gray-800 leading-snug">היי! אני שופי. בהצלחה!</p>
      <button id="coachClose" aria-label="סגור">×</button>
    </div>
  </div>

  <!-- Audio toggle -->
  <button id="audioToggle" class="fixed left-4 top-4 z-50" type="button" aria-label="החלפת מצב צליל" aria-pressed="false" title="הצליל פעיל">
    <span class="unmuted" aria-hidden="true">🔊</span>
    <span class="muted" aria-hidden="true">🔇</span>
  </button>

  <script>
    /* ========= State ========= */
    let currentOperation=null, currentDifficulty='easy', currentQuestionIndex=0;
    let correctCount=0, totalQuestions=6, questions=[], mistakes=[];
    let startTime=0, totalTime=0, playerName='', selectedAnswer=null;
    let questionCount=null, currentCurriculum=null;
    let coachHidden=false;
    let activeMistake=null;

    const rulesByDifficulty={
      easy:{addSubMax:20,mulMax:5,divMaxDivisor:5,divMaxQuotient:5},
      medium:{addSubMax:100,mulMax:10,divMaxDivisor:10,divMaxQuotient:10},
      hard:{addSubMax:1000,mulMax:12,divMaxDivisor:12,divMaxQuotient:12}
    };

    const curricula={
      none:{name:'ללא תוכנית'},
      il_g1_s1:{name:'כיתה א׳, מחצית ראשונה',operations:['addition','subtraction'],addSubMax:10},
      il_g1_s2:{name:'כיתה א׳, מחצית שנייה',operations:['addition','subtraction'],addSubMax:20},
      il_g1_adv:{name:'כיתה א׳, אתגר',operations:['addition','subtraction'],addSubMax:30},
      il_g2:{name:'כיתה ב׳',operations:['addition','subtraction'],addSubMax:100},
      il_g3:{name:'כיתה ג׳',operations:['addition','subtraction','multiplication','division'],addSubMax:100,mulMax:10,divMaxDivisor:10,divMaxQuotient:10},
      il_g4:{name:'כיתה ד׳',operations:['addition','subtraction','multiplication','division'],addSubMax:1000,mulMax:12,divMaxDivisor:12,divMaxQuotient:12}
    };

    /* ========= Helpers ========= */
    const $=sel=>document.querySelector(sel);
    const $$=sel=>document.querySelectorAll(sel);
    const randInt=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    function shuffle(a){const c=a.slice();for(let i=c.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[c[i],c[j]]=[c[j],c[i]]}return c}

    /* ========= Focus helper ========= */
    function focusTop(selector){
      const el = typeof selector==='string' ? document.querySelector(selector) : selector;
      const target = el || document.body;
      if (target && !target.hasAttribute('tabindex')) target.setAttribute('tabindex','-1');
      requestAnimationFrame(()=>{
        window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
        try { target && target.focus({ preventScroll: true }); } catch {}
      });
    }

    /* ========= Coach (Shufi) ========= */
    function showCoach(msg, ctx='default'){
      if (coachHidden) return;
      const el = $('#coach'); const txt = $('#coachMsg');
      if (!el || !txt) return;
      txt.textContent = msg || 'בהצלחה!';
      el.style.display = 'block';
      placeCoach(ctx);
    }
    function hideCoach(){
      const el=$('#coach'); if(el) el.style.display='none';
      document.body.classList.remove('with-coach-pad');
    }
    function placeCoach(ctx){
      const el=$('#coach'); if(!el) return;
      const isMobile = window.matchMedia('(max-width: 640px)').matches;
      if (isMobile){
        document.body.classList.add('with-coach-pad');
      } else {
        document.body.classList.remove('with-coach-pad');
        el.style.right='16px'; el.style.bottom='24px';
      }
    }

    /* ========= Audio (Safari-safe) ========= */
    let isMuted = false;
    let audioCtx = null;
    let audioUnlocked = false;

    function getAudioCtx() {
      if (isMuted) return null;
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return null;
      if (!audioCtx) audioCtx = new AC();
      if (audioCtx.state !== 'running' && audioCtx.resume) {
        try { audioCtx.resume(); } catch {}
      }
      return audioCtx;
    }

    function unlockAudioOnce() {
      if (audioUnlocked || isMuted) return;
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return;

      if (!audioCtx) audioCtx = new AC();
      try { const p = audioCtx.resume && audioCtx.resume(); if (p && p.catch) p.catch(()=>{}); } catch {}

      try {
        const buffer = audioCtx.createBuffer(1, 1, audioCtx.sampleRate);
        const src = audioCtx.createBufferSource();
        const gain = audioCtx.createGain();
        gain.gain.value = 0.0001;
        src.buffer = buffer;
        src.connect(gain);
        gain.connect(audioCtx.destination);
        src.start(0);
        setTimeout(() => {
          try { src.disconnect(); gain.disconnect(); } catch {}
          audioUnlocked = true;
        }, 0);
      } catch {
        try {
          const t = audioCtx.currentTime;
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          g.gain.setValueAtTime(0.0001, t);
          o.connect(g); g.connect(audioCtx.destination);
          o.start(t); o.stop(t + 0.02);
          audioUnlocked = true;
        } catch {}
      }
    }

    function ensureUnlocked() {
      const ctx = getAudioCtx();
      if (!ctx) return;
      if (!audioUnlocked) unlockAudioOnce();
    }

    function tone(freq, dur, t, type = 'sine', gain = 0.24) {
      if (isMuted) return;
      ensureUnlocked();
      const ctx = getAudioCtx(); if (!ctx) return;

      const start = typeof t === 'number' ? t : ctx.currentTime;
      const o = ctx.createOscillator();
      const g = ctx.createGain();

      o.type = type;
      o.frequency.setValueAtTime(freq, start);

      g.gain.setValueAtTime(gain, start);
      g.gain.exponentialRampToValueAtTime(0.001, start + dur);

      o.connect(g); g.connect(ctx.destination);
      try { o.start(start); o.stop(start + dur); } catch {}
    }

    function playSelectTick() {
      const ctx = getAudioCtx(); if (!ctx) { ensureUnlocked(); return; }
      const t = ctx.currentTime;
      tone(520, 0.10, t, 'triangle', 0.24);
    }

    function playSuccessSound() {
      const ctx = getAudioCtx(); if (!ctx) { ensureUnlocked(); return; }
      const t = ctx.currentTime;
      tone(523.25, 0.12, t,       'sine', 0.22);
      tone(659.25, 0.12, t + 0.1, 'sine', 0.20);
      tone(783.99, 0.14, t + 0.2, 'sine', 0.18);
    }

    function playErrorSound() {
      const ctx = getAudioCtx(); if (!ctx) { ensureUnlocked(); return; }
      const t = ctx.currentTime;
      tone(220, 0.12, t,       'square', 0.20);
      tone(180, 0.12, t + 0.1, 'square', 0.18);
    }

    function initAudioToggle(){
      const btn = document.querySelector('#audioToggle'); if (!btn) return;
      try { isMuted = localStorage.getItem('soundMuted') === 'true'; } catch {}
      btn.setAttribute('aria-pressed', isMuted ? 'true' : 'false');
      btn.addEventListener('click', () => {
        isMuted = !isMuted;
        btn.setAttribute('aria-pressed', isMuted ? 'true' : 'false');
        try { localStorage.setItem('soundMuted', String(isMuted)); } catch {}
        if (!isMuted) unlockAudioOnce();
      });
    }

    // טיק על רוב הכפתורים (לא כולל השתקה) — דואג שגם הקליק הראשון ישמע
    document.addEventListener('click', e=>{
      const el=e.target.closest('button,.op-btn,.choice-card,.chip'); 
      if(!el||el.id==='audioToggle') return;
      const wasLocked = !audioUnlocked;
      unlockAudioOnce();
      if(el.disabled||el.getAttribute('aria-disabled')==='true') return;
      if (wasLocked) setTimeout(playSelectTick, 0); else playSelectTick();
    });

    /* ========= Curriculum gating ========= */
    function applyCurriculumToOperationButtons(){
      const cur=curricula[currentCurriculum]; const allowed=cur&&cur.operations?cur.operations:null;
      $$('#opsGrid .op-btn').forEach(btn=>{
        const op=btn.getAttribute('data-op');
        const enabled = !allowed || op==='mixed' || allowed.includes(op);
        btn.classList.toggle('opacity-50',!enabled);
        btn.classList.toggle('pointer-events-none',!enabled);
        btn.classList.toggle('cursor-not-allowed',!enabled);
        btn.setAttribute('aria-disabled', enabled?'false':'true');
        if(!enabled && btn.classList.contains('selected')){
          btn.classList.remove('selected'); btn.setAttribute('aria-pressed','false');
          if(currentOperation===op) currentOperation=null;
        }
      });
      updateOperationNextState();
    }

    /* ========= Build questions ========= */
    function getEffectiveRules(diff){
      const base=Object.assign({},rulesByDifficulty[diff]); const cur=curricula[currentCurriculum]||{};
      ['addSubMax','mulMax','divMaxDivisor','divMaxQuotient'].forEach(k=>{ if(typeof cur[k]!=='undefined') base[k]=cur[k]; });
      return base;
    }
    function getOpsList(selectedOp,cur){ if(selectedOp!=='mixed') return [selectedOp]; const allowed=cur&&cur.operations?cur.operations:null; return (allowed&&allowed.length)?allowed:['addition','subtraction','multiplication','division']; }
    function buildOpPool(op,rules,targetSize,diff){
      const pool=[]; let tries=0, max=6000;
      const mk=(text,ans,op,a,b,sym)=>({questionText:text,answer:ans,operation:op,num1:a,num2:b,symbol:sym});
      if(op==='addition'){ while(pool.length<targetSize&&tries++<max){ const flu=(diff==='easy')&&Math.random()<.5; const cap= flu? Math.min(10,rules.addSubMax) : rules.addSubMax; const a=randInt(0,cap), b=randInt(0,cap), ans=a+b; if(ans<=cap) pool.push(mk(`${a} + ${b} = ?`,ans,op,a,b,'+')); } }
      if(op==='subtraction'){ while(pool.length<targetSize&&tries++<max){ const flu=(diff==='easy')&&Math.random()<.5; const cap= flu? Math.min(10,rules.addSubMax) : rules.addSubMax; const a=randInt(0,cap), b=randInt(0,a), ans=a-b; if(ans>=0) pool.push(mk(`${a} - ${b} = ?`,ans,op,a,b,'-')); } }
      if(op==='multiplication'){ while(pool.length<targetSize&&tries++<max){ const a=randInt(1,rules.mulMax), b=randInt(1,rules.mulMax); pool.push(mk(`${a} × ${b} = ?`,a*b,op,a,b,'×')); } }
      if(op==='division'){ while(pool.length<targetSize&&tries++<max){ const d=randInt(1,rules.divMaxDivisor), q=randInt(1,rules.divMaxQuotient); const n=d*q; pool.push(mk(`${n} ÷ ${d} = ?`,q,op,q,d,'÷')); } }
      return pool;
    }
    function generatePracticeSet(operation,diff,count){
      const rules=getEffectiveRules(diff); const cur=curricula[currentCurriculum]; const ops=getOpsList(operation,cur);
      let pool=[]; ops.forEach(o=>pool=pool.concat(buildOpPool(o,rules,count*4,diff)));
      const map={}; pool.forEach(q=>{ if(!map[q.questionText]) map[q.questionText]=q; });
      return shuffle(Object.values(map)).slice(0,count);
    }
    function generateAnswerOptions(correct){
      const opts=[correct]; while(opts.length<4){ const wrong=correct+Math.floor(Math.random()*7)-3; if(wrong>0 && wrong!==correct && !opts.includes(wrong)) opts.push(wrong); } return shuffle(opts);
    }

    /* ========= Flow Screens ========= */
    function showNameInput(){
      $('#welcomeScreen').classList.add('hidden');
      $('#nameScreen').classList.remove('hidden');
      hideCoach();
      focusTop('#nameTitle');
      showCoach('איך קוראים לך? נתחיל מהיכרות קצרה 😊','default');
    }

    function showCurriculumSelect(){
      const inp=$('#playerName'); const name=(inp?.value||'').trim(); if(!name){ alert('אנא הכנס את שמך'); inp?.focus(); return; }
      playerName=name;
      ['nameScreen','resultsScreen','mistakesScreen','tutorialScreen','operationScreen','difficultyScreen','gameScreen'].forEach(id=>$('#'+id)?.classList.add('hidden'));
      $('#curriculumScreen').classList.remove('hidden');
      currentCurriculum=null;
      $$('#curriculumGrid .choice-card').forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
      const btn=$('#curriculumNext'); btn.disabled=true; btn.setAttribute('aria-disabled','true');
      focusTop('#curriculumTitle');
      showCoach(`${playerName}, בחר/י תכנית לימוד ואז לחצו "המשך".`, 'default');
    }

    function showOperationSelect(){
      if(!currentCurriculum){ alert('יש לבחור תכנית לימוד'); return; }
      ['curriculumScreen','resultsScreen','mistakesScreen','tutorialScreen','difficultyScreen','gameScreen'].forEach(id=>$('#'+id)?.classList.add('hidden'));
      $('#operationScreen').classList.remove('hidden');
      currentOperation=null; questionCount=null;
      $$('#opsGrid .op-btn').forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
      $$('#questionChips .chip').forEach(c=>{ c.classList.remove('selected'); c.setAttribute('aria-pressed','false'); });
      applyCurriculumToOperationButtons();
      updateOperationNextState();
      focusTop('#operationTitle');
      showCoach('עכשיו בוחרים סוג תרגיל ומספר שאלות. לאחר הבחירה – המשך.', 'default');
    }

    function showDifficultySelect(){
      if(!currentOperation || !questionCount){ alert('בחר/י סוג תרגיל ומספר שאלות'); return; }
      ['operationScreen','resultsScreen','mistakesScreen','tutorialScreen','gameScreen'].forEach(id=>$('#'+id)?.classList.add('hidden'));
      $('#difficultyScreen').classList.remove('hidden');
      $$('#difficultyScreen .diff-btn').forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
      focusTop('#difficultyTitle');
      showCoach('בחר/י רמת קושי כדי להתחיל לתרגל!', 'default');
    }

    function startGame(diff){
      const fbEl = $('#feedback'); if (fbEl) fbEl.classList.add('hidden');
      const nb = $('#nextButton'); if (nb) nb.onclick = null;
      currentDifficulty=diff; currentQuestionIndex=0; correctCount=0; totalTime=0; mistakes=[]; selectedAnswer=null;

      questions=generatePracticeSet(currentOperation,diff,questionCount||6);
      if(!questions.length){ alert('שגיאה: לא ניתן ליצור תרגילים עבור ההגדרות שנבחרו'); return; }

      totalQuestions=questions.length; $('#totalQuestions').textContent=totalQuestions; $('#resultsTotal').textContent=totalQuestions;
      ['difficultyScreen','resultsScreen','mistakesScreen','tutorialScreen'].forEach(id=>$('#'+id)?.classList.add('hidden'));
      $('#gameScreen').classList.remove('hidden');
      $('#gamePlayerName').textContent=playerName;

      const pb=$('#progressBar'); pb.style.width='0%'; pb.setAttribute('aria-valuenow','0');

      showQuestion();
      focusTop('#questionText');
      showCoach('יצאנו לדרך! קרא/י את השאלה, בחר/י תשובה ואז אשר/י.', 'game');
    }

    /* ========= Game ========= */
    function showQuestion(){
      if(currentQuestionIndex>=questions.length){ showResults(); return; }
      selectedAnswer=null;
      const q=questions[currentQuestionIndex];
      $('#questionText').textContent=q.questionText;
      $('#currentQuestion').textContent=currentQuestionIndex+1;

      const prog=(currentQuestionIndex/totalQuestions)*100; const pb=$('#progressBar'); const p=Math.max(2,Math.round(prog)); pb.style.width=p+'%'; pb.setAttribute('aria-valuenow',String(p));

      const options=generateAnswerOptions(q.answer);
      const items=$$('#answersGrid .answer-item');
      options.forEach((opt,i)=>{ const el=items[i]; if(!el) return; el.setAttribute('data-value',String(opt)); el.setAttribute('data-idx',String(i)); el.querySelector('.tabular-nums').textContent=String(opt); el.classList.remove('selected'); el.setAttribute('aria-selected','false'); });

      disableConfirm();
      startTime=Date.now();
      placeCoach('game');
    }

    function enableConfirm(){
      const btn = $('#confirmButton');
      btn.disabled = false;
      btn.removeAttribute('disabled');
      btn.setAttribute('aria-disabled','false');
    }

    function disableConfirm(){
      const btn = $('#confirmButton');
      btn.disabled = true;
      btn.setAttribute('disabled','');
      btn.setAttribute('aria-disabled','true');
    }

    function confirmAnswer(){
      unlockAudioOnce();
      const btn = $('#confirmButton');
      if (!btn || btn.hasAttribute('disabled')) return;
      if (selectedAnswer === null) return;

      disableConfirm();

      const correct = questions[currentQuestionIndex].answer;
      const end = Date.now();
      totalTime += (end - startTime) / 1000;

      const isLast = currentQuestionIndex === totalQuestions - 1;

      if (selectedAnswer === correct) {
        correctCount++;
        playSuccessSound();
        showCoach(isLast ? 'מעולה! סיימנו את הסט — עוברים לסיכום.' : 'כל הכבוד! לשאלה הבאה…', 'game');
      } else {
        mistakes.push({
          question: questions[currentQuestionIndex],
          userAnswer: selectedAnswer,
          correctAnswer: correct,
          reviewed: false
        });
        playErrorSound();
        showCoach(isLast ? 'סיימנו את הסט — עוברים לסיכום.' : 'כמעט! ממשיכים לשאלה הבאה…', 'game');
      }

      if (isLast) {
        // פופ־אפ רק בסוף הסט
        showFinalFeedback(selectedAnswer === correct);
      } else {
        // אין פופ־אפ באמצע — מעבר אוטומטי אחרי הודעת שופי הקצרה
        setTimeout(nextQuestion, 900);
      }
    }

    function showFinalFeedback(ok){
      const fb = $('#feedback'), icon = $('#feedbackIcon'), text = $('#feedbackText'), nextBtn = $('#nextButton');

      if (ok) {
        icon.textContent = '🎉';
        text.className = 'text-2xl font-bold mb-6 text-green-600';
        text.innerHTML = '<div class="mb-2">תשובה נכונה!</div><div>איזה יופי — סיימת את התרגילים ✨</div>';
      } else {
        icon.textContent = '💪';
        text.className = 'text-2xl font-bold mb-6 text-orange-600';
        text.innerHTML = '<div class="mb-2">תשובה שגויה.</div><div>סיימנו את הסט.</div>';
      }

      nextBtn.textContent = 'לסיכום התוצאות';
      nextBtn.onclick = () => { $('#feedback').classList.add('hidden'); showResults(); };
      fb.classList.remove('hidden');
    }

    function nextQuestion(){
      currentQuestionIndex++;
      if (currentQuestionIndex < totalQuestions) {
        showQuestion();
        $('#confirmButton').focus();
      } else {
        const pb = $('#progressBar');
        pb.style.width = '100%';
        pb.setAttribute('aria-valuenow','100');
        showResults();
      }
    }

    function getResultsTitleCopy(name,pct){
      if (pct===0) return `לא נורא ${name}, שופי בטוח שבפעם הבאה תהיה תוצאה טובה יותר`;
      else if (pct<=40) return `${name} רואים שיפור, שופי מחכה לתרגול נוסף`;
      else if (pct<=59) return `${name} רואים שיפור, שופי מחכה לתרגול נוסף`;
      else if (pct<=79) return `${name} עבודה טובה, שופי מחכה לתרגול נוסף`;
      else if (pct<=89) return `ואוו ${name}, איזו שליטה נמשיך לתרגל עם שופי`;
      return `כל הכבוד ${name} שופי גאה בך!`;
    }

    function showResults(){
      ['gameScreen','mistakesScreen','tutorialScreen'].forEach(id=>$('#'+id)?.classList.add('hidden'));
      const rs=$('#resultsScreen'); rs.classList.remove('hidden');

      const incorrect=totalQuestions-correctCount;
      const pct=Math.round((correctCount/totalQuestions)*100);
      $('#resultsTitle').textContent=getResultsTitleCopy(playerName,pct);

      const msg=$('#performanceMessage'), icon=rs.querySelector('.text-8xl');
      if(correctCount===totalQuestions){
        msg.textContent='מושלם! ענית נכון על כל השאלות! 🌟';
        msg.className='mb-4 font-medium text-lg text-green-600';
        icon.textContent='🏆';
        confettiBurst(rs.querySelector('.bg-white')||rs);
      } else if(pct<50){
        msg.textContent='נחזק את החולשות ואחר כך נתרגל שוב.';
        msg.className='mb-4 font-medium text-lg text-orange-600';
        icon.textContent='💪';
      } else {
        msg.textContent='ענית נכון על '+correctCount+' מתוך '+totalQuestions+' שאלות - כל הכבוד! 🎯';
        msg.className='mb-4 font-medium text-lg text-blue-600';
        icon.textContent='🏆';
      }

      updatePerformanceBar(correctCount,incorrect,pct);
      $('#correctAnswers').textContent=String(correctCount);
      $('#averageTime').textContent=String(Math.max(1,Math.round(totalTime/totalQuestions)));
      $('#mistakesButton').classList.toggle('hidden', mistakes.length===0);

      // ניסוח שופי לפי #טעויות
      let coachText = 'סיכום הסט הושלם. ';
      if (mistakes.length === 0) coachText += 'אפשר לתרגל מחדש.';
      else if (mistakes.length === 1) coachText += 'אפשר לתרגל מחדש או ללמוד מהטעות.';
      else coachText += 'אפשר לתרגל מחדש או ללמוד מהטעויות.';

      focusTop('#resultsTitle');
      showCoach(coachText,'default');
      placeCoach('default');
    }

    function updatePerformanceBar(correct,incorrect,pct){
      $('#correctBar').style.width=(correct/totalQuestions*100)+'%';
      $('#incorrectBar').style.width=(incorrect/totalQuestions*100)+'%';
      $('#performancePercentage').textContent=pct+'%';
      $('#correctCount').textContent=String(correct);
      $('#incorrectCount').textContent=String(incorrect);
    }

    /* ========= Mistakes & Tutorial ========= */
    function showMistakes(){
      $('#resultsScreen').classList.add('hidden'); $('#tutorialScreen').classList.add('hidden'); $('#mistakesScreen').classList.remove('hidden');
      const incorrect=totalQuestions-correctCount;
      $('#mistakesCorrectBar').style.width=((correctCount/totalQuestions)*100)+'%';
      $('#mistakesIncorrectBar').style.width=((incorrect/totalQuestions)*100)+'%';
      const mm=$('#mistakesMessage');
      if(mistakes.length===0){
        mm.textContent='מושלם! ענית נכון על כל '+totalQuestions+' השאלות! 🌟';
        mm.className='subhead text-green-600 mb-4';
        $('#mistakesList').innerHTML='<div class="text-center p-8"><div class="text-6xl mb-4">🎉</div><h3 class="text-2xl font-bold text-green-600">מעולה!</h3><p class="text-lg text-gray-600">לא היו לך טעויות במשחק הזה!</p></div>';
        focusTop('#mistakesTitle');
        return;
      } else if(correctCount>0){
        mm.textContent='ענית נכון על '+correctCount+' מתוך '+totalQuestions+' - בואו נלמד מה-'+mistakes.length+' שנשארו';
        mm.className='subhead text-blue-600 mb-4';
      } else {
        mm.textContent='בואו נלמד יחד איך לפתור את השאלות האלה';
        mm.className='subhead text-orange-600 mb-4';
      }

      const list=$('#mistakesList'); list.innerHTML='';
      questions.forEach((q,i)=>{
        const m=mistakes.find(x=>x.question.questionText===q.questionText); if(!m) return;
        const d=document.createElement('div');
        d.className='bg-orange-50 border-2 border-orange-200 rounded-2xl p-6 cursor-pointer hover:bg-orange-100 transition-colors';
        d.onclick=()=>showTutorial(m);
        d.innerHTML='<div class="flex items-center justify-between mb-4"><div class="flex items-center gap-3"><div class="w-4 h-4 bg-orange-500 rounded-full"></div><h3 class="text-xl font-bold text-orange-600">שאלה '+(i+1)+'</h3></div><div class="text-2xl">🤔</div></div><div class="text-2xl font-bold text-gray-800 mb-4 ltr">'+m.question.questionText+'</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div class="bg-red-100 border-2 border-red-300 rounded-xl p-4"><div class="text-sm text-red-600 font-bold mb-1">התשובה שלך:</div><div class="text-xl font-bold text-red-700 ltr">'+m.userAnswer+'</div></div><div class="bg-green-100 border-2 border-green-300 rounded-xl p-4"><div class="text-sm text-green-600 font-bold mb-1">התשובה הנכונה:</div><div class="text-xl font-bold text-green-700 ltr">'+m.correctAnswer+'</div></div></div><div class="text-center text-blue-600 font-bold">👆 לחץ כאן כדי ללמוד איך לפתור</div>';
        list.appendChild(d);
      });
      focusTop('#mistakesTitle');
      showCoach('לחץ על שאלה כדי לראות הסבר אינטראקטיבי.','default');
    }

    function showTutorial(m){
      activeMistake = m;
      $('#mistakesScreen').classList.add('hidden'); $('#tutorialScreen').classList.remove('hidden');
      const q=m.question; const title=$('#tutorialTitle'); title.textContent=q.questionText;
      createTutorialSteps(q); createInteractiveDemo(q);
      requestAnimationFrame(()=>{ title.focus({preventScroll:true}); window.scrollTo({top:0,behavior:'auto'}); });
      showCoach('הנה הסבר צעד־אחר־צעד. נסה/י את האזור האינטראקטיבי.','default');
    }

    function createTutorialSteps(q){
      const c=$('#tutorialSteps'); c.innerHTML='';
      getTutorialSteps(q).forEach((s,i)=>{
        const d=document.createElement('div');
        d.className='bg-blue-50 border-2 border-blue-200 rounded-2xl p-6';
        d.innerHTML='<div class="flex items-center mb-4"><div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">'+(i+1)+'</div><h3 class="text-xl font-bold text-blue-600">'+s.title+'</h3></div><p class="text-gray-700 text-lg">'+s.description+'</p>';
        c.appendChild(d);
      });
    }
    function getTutorialSteps(q){
      const {operation,num1,num2,answer}=q;
      if(operation==='addition') return[
        {title:'הבנת השאלה',description:'אנחנו רוצים לדעת כמה זה '+num1+' + '+num2+'.'},
        {title:'הצגת הפריטים הראשונים',description:'נתחיל עם '+num1+' פריטים.'},
        {title:'הוספת פריטים',description:'נוסיף '+num2+' ונמנה הכול יחד.'},
        {title:'התוצאה',description:'יש '+answer+' פריטים. זו התשובה!'}
      ];
      if(operation==='subtraction') return[
        {title:'הבנת השאלה',description:'אנחנו רוצים לדעת כמה זה '+num1+' - '+num2+'.'},
        {title:'הצגת הפריטים הראשונים',description:'נתחיל עם '+num1+' פריטים.'},
        {title:'הסרת פריטים',description:'נסיר '+num2+' ונמנה כמה נשאר.'},
        {title:'התוצאה',description:'נשארו '+answer+' פריטים.'}
      ];
      if(operation==='multiplication') return[
        {title:'הבנת השאלה',description:'אנחנו רוצים לדעת כמה זה '+num1+' × '+num2+'.'},
        {title:'יצירת קבוצות',description:'ניצור '+num1+' קבוצות של '+num2+'.'},
        {title:'ספירה',description:'נספור את כל הפריטים.'},
        {title:'התוצאה',description:'יש '+answer+' פריטים בסך הכול.'}
      ];
      if(operation==='division'){ const dividend=parseInt(q.questionText.split(' ÷ ')[0],10); const divisor=q.num2; return[
        {title:'הבנת השאלה',description:'אנחנו רוצים לדעת כמה זה '+dividend+' ÷ '+divisor+'.'},
        {title:'הצגת כל הפריטים',description:'נתחיל עם '+dividend+' פריטים.'},
        {title:'חלוקה לקבוצות',description:'נחלק לקבוצות של '+divisor+'.'},
        {title:'התוצאה',description:'קיבלנו '+answer+' קבוצות.'}
      ]; }
      return [];
    }
    function markActiveMistakeReviewed(){ if (!activeMistake) return; activeMistake.reviewed = true; }

    /* === אינטראקטיביות ללמידה מהטעויות === */
    function createInteractiveDemo(q){
      const area = $('#interactiveContent'), info = $('#interactiveInstructions');
      area.innerHTML = '';
      const {operation,num1,num2,answer} = q;
      const em = ['🍎','🎈','⭐','🌟','🍊','🎯','🌈','🎪'][Math.floor(Math.random()*8)];
      const LARGE = 40;

      if(operation==='addition'){
        const total = answer;
        if(total > LARGE){
          numberLineDemo(num1, 10, total, true);
          info.textContent = `נסו לקפוץ ב־+10 ואז להשלים ב־+1 עד ${total}`;
          return;
        }
        let clicked=0;
        for(let i=0;i<total;i++){
          const s=document.createElement('span');
          s.className='text-3xl m-1 opacity-50 cursor-pointer';
          s.textContent=i<num1?'🔵':'🟡';
          s.onclick=function(){
            unlockAudioOnce();
            if(this.style.opacity!=='1'){
              this.style.opacity='1'; clicked++;
              if(clicked===total){
                setTimeout(()=>{
                  info.textContent=`מעולה! ספרת ${total} פריטים - זו התשובה! 🎉`;
                  info.className='text-green-600 font-bold text-lg';
                  markActiveMistakeReviewed();
                },400);
              }else{
                info.textContent=`המשך/י לספור... (${clicked}/${total})`;
              }
            }
          };
          area.appendChild(s);
          if(((i+1)%5===0)&&i<total-1) area.appendChild(document.createElement('br'));
        }
        info.textContent=`לחץ/י על הכדורים כדי לספור את ${num1} + ${num2}`;
        return;
      }

      if(operation==='subtraction'){
        if(num1 > LARGE){
          numberLineDemo(num1, 10, answer, false);
          info.textContent = `התחילו מ־${num1}, קפצו ב־−10 ואז ב־−1 עד ${answer}`;
          return;
        }
        let removed=0;
        for(let i=0;i<num1;i++){
          const s2=document.createElement('span');
          s2.className='text-3xl m-1 cursor-pointer';
          s2.textContent=em;
          s2.onclick=function(){
            unlockAudioOnce();
            if(this.style.opacity!=='0.3'&&removed<num2){
              this.style.opacity='0.3';
              this.style.textDecoration='line-through';
              removed++;
              if(removed===num2){
                setTimeout(()=>{
                  info.textContent=`מעולה! הסרת ${num2} פריטים, נשארו ${answer} פריטים! 🎉`;
                  info.className='text-green-600 font-bold text-lg';
                  markActiveMistakeReviewed();
                },400);
              }else{
                info.textContent=`לחץ/י על עוד ${num2-removed} פריטים כדי להסיר אותם`;
              }
            }
          };
          area.appendChild(s2);
          if(((i+1)%5===0)&&i<num1-1) area.appendChild(document.createElement('br'));
        }
        info.textContent=`לחץ/י על ${num2} פריטים כדי להסיר אותם מתוך ${num1}`;
        return;
      }

      if(operation==='multiplication'){
        const groups=num1, items=num2;
        if(groups*items > 60){
          groupsCounterDemo(groups, items, groups*items);
          info.textContent=`הוסיפו קבוצות עד שתגיעו ל־${groups} קבוצות של ${items}.`;
          return;
        }
        let shown=0;
        for(let g=0; g<groups; g++){
          const group=document.createElement('div');
          group.className='inline-block border-2 border-dashed border-blue-300 rounded-lg p-3 m-2 bg-blue-50';
          group.style.opacity='0.5';
          const label=document.createElement('div');
          label.className='text-sm font-bold text-blue-600 mb-2 text-center';
          label.textContent='קבוצה '+(g+1);
          group.appendChild(label);

          for(let i=0;i<items;i++){
            const sp=document.createElement('span');
            sp.className='text-2xl m-1';
            sp.textContent=em;
            group.appendChild(sp);
          }

          group.onclick=function(){
            unlockAudioOnce();
            if(this.style.opacity==='0.5'){
              this.style.opacity='1';
              shown++;
              if(shown===groups){
                setTimeout(()=>{
                  info.textContent=`מעולה! ${groups} קבוצות × ${items} פריטים = ${groups*items} פריטים בסך הכל! 🎉`;
                  info.className='text-green-600 font-bold text-lg';
                  markActiveMistakeReviewed();
                },400);
              }else{
                info.textContent=`נהדר! לחץ/י על ${groups-shown} הקבוצות הנותרות`;
              }
            }
          };
          area.appendChild(group);
        }
        info.textContent=`לחץ/י על הקבוצות כדי לראות ${groups} קבוצות של ${items}`;
        return;
      }

      if(operation==='division'){
        const dividend=parseInt(q.questionText.split(' ÷ ')[0],10);
        const groups=answer, size=num2;
        if(dividend > 60){
          divisionCounterDemo(dividend, size, groups);
          info.textContent=`צרו קבוצות של ${size} עד שמחלקים את כל ה־${dividend}.`;
          return;
        }
        let shown2=0;
        for(let g=0; g<groups; g++){
          const group2=document.createElement('div');
          group2.className='inline-block border-2 border-dashed border-purple-300 rounded-lg p-3 m-2 bg-purple-50';
          group2.style.opacity='0.5';
          const label2=document.createElement('div');
          label2.className='text-sm font-bold text-purple-600 mb-2 text-center';
          label2.textContent='קבוצה '+(g+1);
          group2.appendChild(label2);

          for(let i=0;i<size;i++){
            const sp2=document.createElement('span');
            sp2.className='text-2xl m-1';
            sp2.textContent=em;
            group2.appendChild(sp2);
          }

          group2.onclick=function(){
            unlockAudioOnce();
            if(this.style.opacity==='0.5'){
              this.style.opacity='1';
              shown2++;
              if(shown2===groups){
                setTimeout(()=>{
                  info.textContent=`מעולה! חילקת ${dividend} פריטים ל-${groups} קבוצות של ${size} פריטים! 🎉`;
                  info.className='text-green-600 font-bold text-lg';
                  markActiveMistakeReviewed();
                },400);
              }else{
                info.textContent=`נהדר! לחץ/י על ${groups-shמעון2} הקבוצות הנותרות`;
              }
            }
          };
          area.appendChild(group2);
        }
        info.textContent=`לחץ/י על הקבוצות כדי לראות איך ${dividend} פריטים מתחלקים ל-${groups} קבוצות של ${size}`;
      }
    }

    // דמו קו מספרים ל־+/- עם צעדי 10 ו־1
    function numberLineDemo(start, step, target, plus=true){
      const area = $('#interactiveContent'), info = $('#interactiveInstructions');
      area.innerHTML='';
      let current=start;

      const box=document.createElement('div');
      box.className='inline-flex items-center justify-center text-3xl font-extrabold text-gray-900 rounded-2xl border-2 border-blue-300 bg-white px-6 py-4 mb-3 ltr tabular-nums';
      box.textContent=current;
      area.appendChild(box);

      const controls=document.createElement('div');
      controls.className='flex flex-wrap gap-3 justify-center my-3';
      const big=document.createElement('button'); big.className='chip'; big.textContent=(plus?'+':'-')+step;
      const small=document.createElement('button'); small.className='chip'; small.textContent=(plus?'+':'-')+'1';
      controls.appendChild(big); controls.appendChild(small);
      area.appendChild(controls);

      function update(){
        box.textContent=current;
        if(current===target){
          info.textContent='בול! הגעת לתוצאה המבוקשת 🎉';
          info.className='text-green-600 font-bold text-lg';
          markActiveMistakeReviewed();
        }else{
          const dir = current<target ? 'המשיך/י לעלות' : 'המשיך/י לרדת';
          info.textContent=`${dir} עד ${target}`;
          info.className='text-gray-600';
        }
      }

      big.onclick=()=>{ unlockAudioOnce(); current += (plus?step:-step); update(); };
      small.onclick=()=>{ unlockAudioOnce(); current += (plus?1:-1); update(); };
      update();
    }

    // דמו מונה לקבוצות בכפל
    function groupsCounterDemo(groupsNeeded, groupSize, total){
      const area=$('#interactiveContent'), info=$('#interactiveInstructions');
      area.innerHTML='';
      let groups=0;

      const row=document.createElement('div');
      row.className='flex flex-col items-center gap-3';
      const groupsBox=document.createElement('div');
      groupsBox.className='text-xl font-bold text-blue-700';
      const totalBox=document.createElement('div');
      totalBox.className='text-2xl font-extrabold text-gray-900 ltr tabular-nums';

      const btnRow=document.createElement('div');
      btnRow.className='flex gap-3 justify-center';
      const plus1=document.createElement('button'); plus1.className='chip'; plus1.textContent='+1 קבוצה';
      const plus5=document.createElement('button'); plus5.className='chip'; plus5.textContent='+5 קבוצות';

      row.appendChild(groupsBox); row.appendChild(totalBox);
      area.appendChild(row); area.appendChild(btnRow);
      btnRow.appendChild(plus1); btnRow.appendChild(plus5);

      function update(){
        groupsBox.textContent=`קבוצות שנוצרו: ${groups}/${groupsNeeded} (כל קבוצה ${groupSize})`;
        totalBox.textContent=`סה״כ פריטים: ${groups*groupSize}`;
        if(groups>=groupsNeeded){
          groups=groupsNeeded;
          info.textContent=`מעולה! ${groupsNeeded}×${groupSize} = ${total} 🎉`;
          info.className='text-green-600 font-bold text-lg';
          markActiveMistakeReviewed();
        }else{
          info.textContent=`הוסיפו קבוצות עד ${groupsNeeded}`;
          info.className='text-gray-600';
        }
      }

      plus1.onclick=()=>{ unlockAudioOnce(); groups=Math.min(groupsNeeded, groups+1); update(); };
      plus5.onclick=()=>{ unlockAudioOnce(); groups=Math.min(groupsNeeded, groups+5); update(); };
      update();
    }

    // דמו מונה לחלוקה לקבוצות
    function divisionCounterDemo(dividend, groupSize, groupsNeeded){
      const area=$('#interactiveContent'), info=$('#interactiveInstructions');
      area.innerHTML='';
      let groups=0, remaining=dividend;

      const boxes=document.createElement('div');
      boxes.className='grid grid-cols-1 sm:grid-cols-2 gap-3 items-start justify-center mb-3';
      const remBox=document.createElement('div');
      remBox.className='text-xl font-bold text-purple-700';
      const groupsBox=document.createElement('div');
      groupsBox.className='text-xl font-bold text-purple-700';
      const bigRes=document.createElement('div');
      bigRes.className='text-2xl font-extrabold text-gray-900 ltr tabular-nums mt-2 text-center';

      const btnRow=document.createElement('div');
      btnRow.className='flex gap-3 justify-center';
      const add1=document.createElement('button'); add1.className='chip'; add1.textContent='+1 קבוצה';
      const add5=document.createElement('button'); add5.className='chip'; add5.textContent='+5 קבוצות';

      boxes.appendChild(remBox); boxes.appendChild(groupsBox);
      area.appendChild(boxes); area.appendChild(bigRes); area.appendChild(btnRow);
      btnRow.appendChild(add1); btnRow.appendChild(add5);

      function update(){
        remBox.textContent=`נשאר לחלק: ${remaining}`;
        groupsBox.textContent=`קבוצות שנוצרו: ${groups}/${groupsNeeded} (כל קבוצה ${groupSize})`;
        bigRes.textContent=`חולקו: ${groups*groupSize} מתוך ${dividend}`;
        if(groups>=groupsNeeded || remaining<=0){
          groups=groupsNeeded; remaining=0;
          info.textContent=`מעולה! ${dividend} ÷ ${groupSize} = ${groupsNeeded} 🎉`;
          info.className='text-green-600 font-bold text-lg';
          markActiveMistakeReviewed();
        }else{
          info.textContent=`צרו קבוצות עד שתאזלו את כל ה־${dividend}`;
          info.className='text-gray-600';
        }
      }

      add1.onclick=()=>{ unlockAudioOnce(); if(remaining>0){ groups=Math.min(groupsNeeded, groups+1); remaining=Math.max(0, remaining-groupSize);} update(); };
      add5.onclick=()=>{ unlockAudioOnce(); if(remaining>0){ const k=Math.min(5, Math.ceil(remaining/groupSize)); groups=Math.min(groupsNeeded, groups+k); remaining=Math.max(0, remaining-k*groupSize);} update(); };
      update();
    }

    /* ========= תשובות: בחירה ========= */
    function bindAnswerGrid(){
      const grid=$('#answersGrid'); if(!grid) return;
      grid.addEventListener('click',e=>{
        const item=e.target.closest('.answer-item'); if(!item||!grid.contains(item)) return;
        unlockAudioOnce(); chooseItem(item);
      });
      grid.addEventListener('keydown',e=>{
        const item=e.target.closest('.answer-item'); if(!item||!grid.contains(item)) return;
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); unlockAudioOnce(); chooseItem(item); }
      });
      function chooseItem(item){
        $$('#answersGrid .answer-item').forEach(it=>{ it.classList.remove('selected'); it.setAttribute('aria-selected','false'); });
        item.classList.add('selected'); item.setAttribute('aria-selected','true');
        selectedAnswer=parseInt(item.getAttribute('data-value'),10);
        enableConfirm(); playSelectTick();
      }
    }

    /* ========= Confetti ========= */
    function confettiBurst(container){
      try{ if(window.matchMedia&&window.matchMedia('(prefers-reduced-motion: reduce)').matches) return; }catch{}
      const n=28; for(let i=0;i<n;i++){
        const dot=document.createElement('span');
        dot.style.position='absolute'; dot.style.width='8px'; dot.style.height='8px'; dot.style.borderRadius='50%';
        dot.style.left='50%'; dot.style.top='10%';
        const colors=['#22c55e','#3b82f6','#f59e0b','#ef4444','#a855f7']; dot.style.background=colors[i%colors.length];
        const angle=(i/n)*Math.PI*2, dist=80+Math.random()*50, tx=Math.cos(angle)*dist, ty=Math.sin(angle)*dist;
        const anim=dot.animate([{transform:'translate(-50%,-50%) scale(1)',opacity:1},{transform:'translate('+(tx-50)+'%,'+(ty-50)+'%) scale(.9)',opacity:0}],{duration:900,easing:'cubic-bezier(.2,.8,.2,1)'});
        anim.onfinish=()=>dot.remove();
        (container||document.body).appendChild(dot);
      }
    }

    /* ========= Selection helpers ========= */
    function selectChoice(containerSel, itemSel, onChange){
      const cont=$(containerSel); if(!cont) return;
      cont.addEventListener('click', e=>{
        const btn=e.target.closest(itemSel); if(!btn||!cont.contains(btn)) return;
        $$(containerSel+' '+itemSel).forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
        btn.classList.add('selected'); btn.setAttribute('aria-pressed','true');
        onChange && onChange(btn);
      });
      cont.addEventListener('keydown', e=>{
        const btn=e.target.closest(itemSel); if(!btn||!cont.contains(btn)) return;
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); btn.click(); }
      });
    }

    function updateOperationNextState(){
      const nextBtn=$('#operationNext');
      const enabled = !!currentOperation && !!questionCount;
      nextBtn.disabled = !enabled;
      nextBtn.setAttribute('aria-disabled', enabled?'false':'true');
    }

    /* ========= Init ========= */
    document.addEventListener('DOMContentLoaded',()=>{
      // פתיחה על המחווה הראשונה – כולל iOS/macOS Safari
      window.addEventListener('touchstart', unlockAudioOnce, { once: true, passive: true });
      window.addEventListener('touchend',   unlockAudioOnce, { once: true, passive: true });
      window.addEventListener('pointerdown', unlockAudioOnce, { once: true, capture: true });
      window.addEventListener('click',        unlockAudioOnce, { once: true, capture: true });

      // ניווט ראשוני
      $('#startBtn')?.addEventListener('click',e=>{e.preventDefault(); unlockAudioOnce(); showNameInput();});
      $('#nameForm')?.addEventListener('submit',e=>{e.preventDefault(); unlockAudioOnce(); showCurriculumSelect();});

      // תכנית לימוד – בחירה כרטיסיות
      selectChoice('#curriculumGrid','.choice-card',(btn)=>{
        currentCurriculum = btn.getAttribute('data-value');
        const next=$('#curriculumNext'); next.disabled=false; next.setAttribute('aria-disabled','false');
      });
      $('#curriculumNext')?.addEventListener('click',()=> showOperationSelect());

      // סוג תרגיל – כרטיסיות
      selectChoice('#opsGrid','.op-btn',(btn)=>{
        currentOperation = btn.getAttribute('data-op');
        updateOperationNextState();
      });

      // מס׳ שאלות – צ׳יפים
      selectChoice('#questionChips','.chip',(btn)=>{
        questionCount = parseInt(btn.getAttribute('data-count'),10);
        updateOperationNextState();
      });

      // המשך לרמות קושי
      $('#operationNext')?.addEventListener('click',()=> showDifficultySelect());

      // רמת קושי – כרטיסיות (התחלת משחק)
      selectChoice('#difficultyScreen','.diff-btn',(btn)=>{
        startGame(btn.getAttribute('data-diff'));
      });

      // תשובות
      bindAnswerGrid();

      // אישור תשובה
      $('#confirmButton')?.addEventListener('click',e=>{
        if(e.currentTarget.hasAttribute('disabled')){ e.preventDefault(); return; }
        unlockAudioOnce(); confirmAnswer();
      });

      // תוצאות: מאזינים
      $('#retryBtn')?.addEventListener('click',()=> startGame(currentDifficulty));
      $('#mistakesButton')?.addEventListener('click',showMistakes);
      $('#altBtn')?.addEventListener('click',()=>{ $('#resultsScreen').classList.add('hidden'); showOperationSelect(); showCoach('בחר/י תרגיל חדש ומספר שאלות.', 'default'); });

      // טעויות/הדרכה: חזרה וריסטארט
      $('#backToResults')?.addEventListener('click',()=>{ $('#mistakesScreen').classList.add('hidden'); $('#resultsScreen').classList.remove('hidden'); focusTop('#resultsTitle'); showCoach('חזרה לסיכום.', 'default'); });
      $('#restartBtn')?.addEventListener('click',()=>location.reload());
      $('#restartFromMistakes')?.addEventListener('click',()=>location.reload());
      $('#restartFromTutorial')?.addEventListener('click',()=>location.reload());
      $('#backToMistakes')?.addEventListener('click',()=>{ $('#tutorialScreen').classList.add('hidden'); showMistakes(); });

      // שופי – סגירה
      $('#coachClose')?.addEventListener('click',()=>{ coachHidden=true; hideCoach(); });

      // אודיו – כפתור השתקה
      initAudioToggle();

      // אם הטאב חזר לפוקוס בספארי
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') { try { getAudioCtx(); } catch {} }
      });

      // הצגת שופי במסך פתיחה
      showCoach('אני שופי ואני אהיה איתך בזמן התרגול', 'default');

      // רספונסיביות – עדכון מיקום שופי
      window.addEventListener('resize', ()=>{
        const ctx = (!$('#gameScreen').classList.contains('hidden')) ? 'game' : 'default';
        placeCoach(ctx);
      });
    });
  </script>
</body>
</html>
