<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>מספרונצ'יק - משחק חשבון לימודי</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');

    :root { color-scheme: light; }
    body { font-family: 'Assistant', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .ltr { direction: ltr; unicode-bidi: embed; display: inline-block; }

    /* ===== Answer cards ===== */
    .answer-item{
      position: relative;
      transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease;
      cursor: pointer;
      user-select: none; -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
      background: rgba(255,255,255,0.85);
      border-radius: 1rem;
    }
    .answer-item::before{
      content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background: var(--tint, transparent); opacity:.08; /* טינט עדין */
    }
    /* פס סימון מימין */
    .answer-item .accent{
      position:absolute; right:0; top:0; bottom:0;
      width:8px; border-radius:0 1rem 1rem 0; opacity:.55;
      background: var(--tint);
    }
    .answer-item[data-idx="0"] { --tint:#f87171; } /* אדמדם */
    .answer-item[data-idx="1"] { --tint:#60a5fa; } /* כחול */
    .answer-item[data-idx="2"] { --tint:#4ade80; } /* ירוק */
    .answer-item[data-idx="3"] { --tint:#facc15; } /* צהוב */
    .answer-item:active, .answer-item.pressed { transform: scale(0.98); }
    .answer-item.selected{
      border: 3px solid #2563eb; /* blue-600 */
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    }
    .answer-item:focus-visible{
      outline: none;
      box-shadow: 0 0 0 4px rgba(59,130,246,0.45);
    }
    @media (prefers-reduced-motion: reduce){
      .answer-item{ transition: none !important; }
    }

    .owl-blink{ animation: blink 2s infinite; }
    @keyframes blink{ 0%,90%,100%{transform:scaleY(1)} 95%{transform:scaleY(0.1)} }

    .confirm-button{ transition: all .25s ease; }
    .confirm-button:disabled{ opacity:.5; cursor:not-allowed; transform:none !important; }

    /* Shufi coach */
    #coach { padding-bottom: calc(env(safe-area-inset-bottom,0px)); }
    @media (prefers-reduced-motion: reduce){
      #coach { transition: none !important; }
    }

    /* Audio toggle */
    #audioToggle {
      padding: .5rem .7rem;
      border-radius: 9999px;
      background: rgba(255,255,255,.95);
      border: 1px solid #e5e7eb; /* gray-200 */
      box-shadow: 0 6px 20px rgba(0,0,0,.12);
    }
    #audioToggle[aria-pressed="true"] .muted { display: inline; }
    #audioToggle[aria-pressed="true"] .unmuted { display: none; }
    #audioToggle[aria-pressed="false"] .muted { display: none; }
    #audioToggle[aria-pressed="false"] .unmuted { display: inline; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-50 to-green-100 min-h-screen">
  <!-- Welcome Screen -->
  <div id="welcomeScreen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-6xl mb-4 owl-blink">🦉</div>
      <h1 class="text-4xl font-bold text-purple-600 mb-4">מספרונצ'יק</h1>
      <p class="text-2xl text-gray-700 mb-8">בואו ללמוד חשבון עם שופי הינשוף</p>
      <button type="button" onclick="showNameInput()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">
        התחל משחק
      </button>
    </div>
  </div>

  <!-- Name Input Screen -->
  <div id="nameScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <form id="nameForm" class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-5xl mb-4">👋</div>
      <h2 class="text-3xl font-bold text-blue-600 mb-6">איך קוראים לך?</h2>
      <input type="text" id="playerName" name="playerName" required placeholder="הכנס את שמך כאן" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-6 text-center focus:border-blue-500 focus:outline-none">
      <button type="submit" class="bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-blue-600 hover:to-green-600 transform hover:scale-105 transition-all duration-200 shadow-lg">
        המשך
      </button>
    </form>
  </div>

  <!-- Operation Selection Screen -->
  <div id="operationScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full">
      <div class="text-5xl mb-4">🎯</div>
      <h2 class="text-3xl md:text-4xl font-extrabold text-green-600 mb-3 leading-tight">בואו נבחר את סוג התרגיל</h2>
      <p class="text-lg md:text-xl text-gray-700 mb-8 leading-relaxed">בכל סט תרגילים תוצג לך סדרת שאלות מגוונות</p>

      <!-- Curriculum Selector -->
      <div class="text-right mb-8">
        <label for="curriculumSelect" class="block text-lg font-semibold text-gray-800 mb-2">בחירת תוכנית לימוד</label>
        <select id="curriculumSelect" class="w-full p-4 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none bg-white">
          <option value="none" selected>ללא תוכנית</option>
          <option value="il_g1_s1">כיתה א׳, מחצית ראשונה (עד 10)</option>
          <option value="il_g1_s2">כיתה א׳, מחצית שנייה (עד 20)</option>
          <option value="il_g1_adv">כיתה א׳, אתגר (עד 30)</option>
          <option value="il_g2">כיתה ב׳ (עד 100)</option>
          <option value="il_g3">כיתה ג׳ (עד 100; כפל/חילוק עד 10×10)</option>
          <option value="il_g4">כיתה ד׳ (עד 1000; כפל/חילוק עד 12×12)</option>
        </select>
      </div>

      <div id="opsGrid" class="grid grid-cols-2 gap-4 mb-6">
        <button data-op="addition" onclick="selectOperation('addition')" class="op-btn bg-gradient-to-r from-green-400 to-blue-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">➕</div>חיבור</button>
        <button data-op="subtraction" onclick="selectOperation('subtraction')" class="op-btn bg-gradient-to-r from-red-400 to-pink-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">➖</div>חיסור</button>
        <button data-op="multiplication" onclick="selectOperation('multiplication')" class="op-btn bg-gradient-to-r from-purple-400 to-indigo-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">✖️</div>כפל</button>
        <button data-op="division" onclick="selectOperation('division')" class="op-btn bg-gradient-to-r from-orange-400 to-red-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">➗</div>חילוק</button>
        <button data-op="mixed" onclick="selectOperation('mixed')" class="op-btn bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg col-span-2"><div class="text-4xl mb-2">🎲</div>הכל</button>
      </div>
    </div>
  </div>

  <!-- Difficulty Selection Screen -->
  <div id="difficultyScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
      <div class="text-5xl mb-4">⚡</div>
      <h2 class="text-3xl sm:text-4xl font-bold text-blue-600 mb-6">איזו רמת קושי מתאימה לך היום?</h2>

      <!-- מספר שאלות -->
      <div class="mt-1 mb-6 text-right">
        <label for="questionCountSelect" class="block text-lg font-semibold text-gray-800 mb-2">מספר שאלות בסט</label>
        <select id="questionCountSelect" class="w-full p-4 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none bg-white">
          <option value="6" selected>6</option>
          <option value="8">8</option>
          <option value="10">10</option>
        </select>
      </div>

      <div class="flex flex-col gap-4 mb-2">
        <button onclick="startGame('easy')" class="bg-gradient-to-r from-green-400 to-green-500 text-white p-6 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">🌱</div><div class="font-bold">קל</div></button>
        <button onclick="startGame('medium')" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">🔥</div><div class="font-bold">בינוני</div></button>
        <button onclick="startGame('hard')" class="bg-gradient-to-r from-red-400 to-purple-500 text-white p-6 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">⚡</div><div class="font-bold">מתקדם</div></button>
      </div>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="hidden min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6 mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-4">
        <div class="text-2xl font-bold text-purple-600">שאלה <span id="currentQuestion" class="ltr">1</span> מתוך <span id="totalQuestions" class="ltr">6</span></div>
        <div class="text-xl text-gray-600">שלום <span id="gamePlayerName"></span>! 👋</div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 mx-auto max-w-lg text-center">
      <div class="text-5xl mb-4 owl-blink">🦉</div>
      <div id="questionText" class="text-3xl font-bold text-gray-800 mb-6 ltr">5 + 3 = ?</div>
      <div class="text-xl text-gray-700 mb-4">יש לבחור את התשובה הנכונה</div>
    </div>

    <!-- Answer Options -->
    <div class="grid grid-cols-1 gap-3 max-w-2xl mx-auto px-4 mb-6">
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="6" data-idx="0" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">6</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="8" data-idx="1" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">8</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="7" data-idx="2" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">7</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="5" data-idx="3" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">5</div>
      </div>
    </div>

    <div class="text-center space-y-4 pb-6">
      <button id="confirmButton" onclick="confirmAnswer()" disabled class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">אשר תשובה</button>
      <button type="button" onclick="startOver()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div role="dialog" aria-modal="true" aria-labelledby="feedbackText" class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
        <div id="feedbackIcon" class="text-8xl mb-4">🎉</div>
        <div id="feedbackText" aria-live="polite" class="text-2xl font-bold mb-6">כל הכבוד!</div>
        <button id="nextButton" onclick="nextQuestion()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">השאלה הבאה</button>
      </div>
    </div>
  </div>

  <!-- Results Screen -->
  <div id="resultsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full relative overflow-hidden">
      <div class="text-8xl mb-4">🏆</div>
      <h2 class="text-3xl font-bold text-green-600 mb-4" id="resultsTitle">כל הכבוד <span id="finalPlayerName"></span>!</h2>
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">הביצועים שלך:</span>
          <span id="performancePercentage" class="text-sm font-bold text-blue-600 ltr">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div id="performanceBar" class="h-6 rounded-full transition-all duration-1000 flex" aria-label="Progress indicator">
            <div id="correctBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
            <div id="incorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <span class="text-green-600 font-medium">✓ נכונות: <span id="correctCount" class="ltr">0</span></span>
          <span class="text-orange-600 font-medium">✗ שגויות: <span id="incorrectCount" class="ltr">0</span></span>
        </div>
      </div>

      <div class="text-xl text-gray-700 mb-6">
        <div id="performanceMessage" class="mb-4 font-medium text-lg">סיימת את הסט! 🎯</div>
        <div class="mb-2">תשובות נכונות: <span id="correctAnswers" class="font-bold text-green-600 ltr">0</span>/<span id="resultsTotal" class="ltr">6</span></div>
        <div class="mb-4">זמן ממוצע: <span id="averageTime" class="font-bold text-blue-600 ltr">0</span> שניות</div>
      </div>

      <div class="flex flex-col gap-4">
        <button onclick="startGame(currentDifficulty)" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">אני רוצה לתרגל מחדש</button>
        <button id="mistakesButton" onclick="showMistakes()" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">ללמוד מהטעויות</button>
        <button onclick="showOperationSelect()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">בא לי תרגול אחר</button>
      </div>
    </div>
  </div>

  <!-- Mistakes Review Screen -->
  <div id="mistakesScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">📚</div>
        <h2 class="text-3xl font-bold text-orange-600 mb-4">למד מהטעויות</h2>
        <div class="mb-6 max-w-md mx-auto">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mb-3">
            <div id="mistakesPerformanceBar" class="h-4 rounded-full transition-all duration-1000 flex" aria-label="Performance summary">
              <div id="mistakesCorrectBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
              <div id="mistakesIncorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>
          <div id="mistakesMessage" class="text-lg text-gray-700 font-medium mb-4">הנה התרגילים שבהם טעית</div>
        </div>
        <p class="text-lg text-gray-600">לחץ על כל תרגיל כדי ללמוד איך לפתור אותו:</p>
      </div>

      <div id="mistakesList" class="space-y-6 mb-8"></div>

      <div class="text-center space-y-4">
        <button onclick="showResults()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">חזור לתוצאות</button>
        <button type="button" onclick="startOver()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
      </div>
    </div>
  </div>

  <!-- Interactive Tutorial Screen -->
  <div id="tutorialScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">🎓</div>
        <h2 id="tutorialTitle" class="text-3xl font-bold text-blue-600 mb-4 ltr">7 ÷ 5 = ?</h2>
        <p class="text-lg text-gray-600">בואו נלמד יחד איך לפתור את השאלה הזו!</p>
      </div>
      <div id="tutorialSteps" class="space-y-8 mb-8"></div>
      <div id="interactiveArea" class="bg-blue-50 rounded-2xl p-6 mb-8 text-center">
        <h3 class="text-xl font-bold text-blue-600 mb-4">נסה בעצמך!</h3>
        <div id="interactiveContent" class="flex flex-wrap justify-center gap-2 mb-4"></div>
        <div id="interactiveInstructions" class="text-gray-600">לחץ על הפריטים כדי לראות איך הפתרון עובד</div>
      </div>
      <div class="flex justify-center gap-4 flex-wrap">
        <button onclick="showMistakes()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">חזור לרשימת הטעויות</button>
        <button type="button" onclick="startOver()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">התחל מחדש</button>
      </div>
    </div>
  </div>

  <!-- Shufi Coach Widget -->
  <div id="coach" class="fixed right-4 bottom-6 sm:right-6 sm:bottom-6 z-40 max-w-[90vw]" dir="rtl" hidden>
    <div class="flex items-start gap-3 bg-white/95 backdrop-blur rounded-2xl shadow-xl px-4 py-3 border border-gray-200">
      <div class="text-3xl" aria-hidden="true">🦉</div>
      <p id="coachMsg" class="text-base sm:text-lg text-gray-800 leading-snug" aria-live="polite">היי! אני שופי. בהצלחה!</p>
      <button id="coachClose" class="ms-1 text-gray-500 hover:text-gray-700 text-xl leading-none" aria-label="סגור הודעת מאמן">×</button>
    </div>
    <div class="h-2"></div>
  </div>

  <!-- Audio toggle -->
  <button id="audioToggle" class="fixed left-4 top-4 z-50" type="button" aria-label="החלפת מצב צליל" aria-pressed="false" title="הצליל פעיל">
    <span class="unmuted" aria-hidden="true">🔊</span>
    <span class="muted" aria-hidden="true">🔇</span>
  </button>

  <script>
    // ===== State =====
    var currentOperation = 'addition';
    var currentDifficulty = 'easy';
    var currentQuestionIndex = 0;
    var correctCount = 0;
    var totalQuestions = 6;
    var questions = [];
    var mistakes = [];
    var startTime = 0;
    var totalTime = 0;
    var playerName = '';
    var currentTutorialMistake = null;
    var selectedAnswer = null;
    var currentCurriculum = 'none';
    var questionCount = 6;

    // Audio state
    var isMuted = false;

    // Difficulty rules
    var rulesByDifficulty = {
      easy:   { addSubMax: 20,  mulMax: 5,  divMaxDivisor: 5,  divMaxQuotient: 5 },
      medium: { addSubMax: 100, mulMax: 10, divMaxDivisor: 10, divMaxQuotient: 10 },
      hard:   { addSubMax: 1000,mulMax: 12, divMaxDivisor: 12, divMaxQuotient: 12 }
    };

    // Curricula presets
    var curricula = {
      none: { name: 'ללא תוכנית' },
      il_g1_s1: { name: 'כיתה א׳ – מחצית ראשונה', operations: ['addition','subtraction'], addSubMax: 10 },
      il_g1_s2: { name: 'כיתה א׳ – מחצית שנייה', operations: ['addition','subtraction'], addSubMax: 20 },
      il_g1_adv:{ name: 'כיתה א׳ – אתגר', operations: ['addition','subtraction'], addSubMax: 30 },
      il_g2:    { name: 'כיתה ב׳', operations: ['addition','subtraction'], addSubMax: 100 },
      il_g3:    { name: 'כיתה ג׳', operations: ['addition','subtraction','multiplication','division'], addSubMax: 100, mulMax: 10, divMaxDivisor: 10, divMaxQuotient: 10 },
      il_g4:    { name: 'כיתה ד׳', operations: ['addition','subtraction','multiplication','division'], addSubMax: 1000, mulMax: 12, divMaxDivisor: 12, divMaxQuotient: 12 }
    };

    // ===== Shufi Coach =====
    var coachHidden = false;
    function showCoach(msg){
      if (coachHidden) return;
      var c = document.getElementById('coach');
      var m = document.getElementById('coachMsg');
      if (!c || !m) return;
      m.textContent = msg;
      c.hidden = false;
    }
    function hideCoach(){
      var c = document.getElementById('coach');
      if (c) c.hidden = true;
    }
    function bindCoach(){
      var x = document.getElementById('coachClose');
      if (x){
        x.onclick = function(){
          coachHidden = true;
          hideCoach();
        };
      }
    }
    function placeCoachForContext(ctx){
      var c = document.getElementById('coach');
      if (!c) return;
      var bottomPx = 24;
      if (ctx === 'game' && window.innerWidth < 640){
        bottomPx = 110; // לא לכסות את "אשר תשובה"
      }
      c.style.bottom = bottomPx + 'px';
      c.style.right = (window.innerWidth < 640 ? 16 : 24) + 'px';
    }

    // ===== Navigation =====
    function showNameInput(){
      document.getElementById('welcomeScreen').classList.add('hidden');
      document.getElementById('nameScreen').classList.remove('hidden');
      hideCoach(); // אין הודעות בשני המסכים הראשונים
      setTimeout(function(){ var inp=document.getElementById('playerName'); if (inp) inp.focus(); }, 100);
    }
    function showOperationSelect(){
      var inputEl = document.getElementById('playerName');
      var name = inputEl ? String(inputEl.value || '').trim() : String(playerName || '').trim();
      if (!name){
        alert('אנא הכנס את שמך');
        if (inputEl) inputEl.focus();
        return;
      }
      playerName = name;

      ['nameScreen','resultsScreen','mistakesScreen','tutorialScreen'].forEach(function(id){
        var el = document.getElementById(id); if (el) el.classList.add('hidden');
      });
      document.getElementById('operationScreen').classList.remove('hidden');

      applyCurriculumToOperationButtons();

      placeCoachForContext('default');
      showCoach('בחר תרגיל כדי להתחיל, ' + playerName + '.');
    }
    function selectOperation(operation){
      currentOperation = operation;
      document.getElementById('operationScreen').classList.add('hidden');
      document.getElementById('difficultyScreen').classList.remove('hidden');
      placeCoachForContext('default');
      showCoach('בחר מספר שאלות ורמת קושי, ואז התחל.');
    }
    function applyCurriculumToOperationButtons(){
      var cur = curricula[currentCurriculum];
      var allowed = cur && cur.operations ? cur.operations : null;
      var buttons = document.querySelectorAll('#opsGrid .op-btn');
      buttons.forEach(function(btn){
        var op = btn.getAttribute('data-op');
        var enabled = true;
        if (allowed && op !== 'mixed') enabled = allowed.indexOf(op) !== -1;
        if (!enabled){
          btn.classList.add('opacity-50','cursor-not-allowed','pointer-events-none');
          btn.setAttribute('aria-disabled','true');
        } else {
          btn.classList.remove('opacity-50','cursor-not-allowed','pointer-events-none');
          btn.removeAttribute('aria-disabled');
        }
      });
    }

    // ===== Game flow =====
    function startGame(difficulty){
      currentDifficulty = difficulty;
      currentQuestionIndex = 0;
      correctCount = 0;
      totalTime = 0;
      mistakes = [];
      selectedAnswer = null;

      var curriculumSel = document.getElementById('curriculumSelect');
      if (curriculumSel) currentCurriculum = curriculumSel.value || 'none';
      var qSel = document.getElementById('questionCountSelect');
      questionCount = parseInt(qSel ? qSel.value : '6', 10) || 6;

      questions = generatePracticeSet(currentOperation, difficulty, questionCount);
      if (questions.length === 0){ alert('שגיאה: לא ניתן ליצור תרגילים עבור ההגדרות שנבחרו'); return; }

      totalQuestions = questions.length;
      document.getElementById('totalQuestions').textContent = totalQuestions;
      document.getElementById('resultsTotal').textContent = totalQuestions;

      ['difficultyScreen','resultsScreen','mistakesScreen','tutorialScreen'].forEach(function(id){
        var el = document.getElementById(id); if (el) el.classList.add('hidden');
      });
      document.getElementById('gameScreen').classList.remove('hidden');
      document.getElementById('gamePlayerName').textContent = playerName;

      var pb = document.getElementById('progressBar');
      pb.style.width = '0%'; pb.setAttribute('aria-valuenow','0');

      placeCoachForContext('game');
      showQuestion();
      showCoach('יצאנו לדרך! קרא את השאלה, בחר תשובה ואז אשר.');
    }

    function generatePracticeSet(operation, difficulty, desiredCount){
      var rules = getEffectiveRules(difficulty);
      var cur = curricula[currentCurriculum];
      var ops = getOpsList(operation, cur);
      var pool = [];
      ops.forEach(function(op){ pool = pool.concat(buildOpPool(op, rules, desiredCount * 4, difficulty)); });
      var map = {};
      pool.forEach(function(q){ if (!map[q.questionText]) map[q.questionText] = q; });
      var unique = Object.keys(map).map(function(k){ return map[k]; });
      return shuffleArray(unique).slice(0, desiredCount);
    }

    function getEffectiveRules(difficulty){
      var base = Object.assign({}, rulesByDifficulty[difficulty]);
      var cur = curricula[currentCurriculum] || {};
      ['addSubMax','mulMax','divMaxDivisor','divMaxQuotient'].forEach(function(k){
        if (typeof cur[k] !== 'undefined') base[k] = cur[k];
      });
      return base;
    }
    function getOpsList(selectedOp, cur){
      if (selectedOp !== 'mixed') return [selectedOp];
      var allowed = cur && cur.operations ? cur.operations : null;
      return (allowed && allowed.length) ? allowed : ['addition','subtraction','multiplication','division'];
    }

    function buildOpPool(operation, rules, targetSize, difficulty){
      var pool = [], attempts = 0, maxAttempts = 6000;
      function mkQ(text, answer, operation, num1, num2, symbol){ return {questionText:text, answer:answer, operation:operation, num1:num1, num2:num2, symbol:symbol}; }

      if (operation === 'addition'){
        while (pool.length < targetSize && attempts++ < maxAttempts){
          var fluency = (difficulty === 'easy') && Math.random() < 0.5;
          var cap = fluency ? Math.min(10, rules.addSubMax) : rules.addSubMax;
          var a = randInt(0, cap), b = randInt(0, cap), ans = a + b;
          if (ans <= cap) pool.push(mkQ(a+" + "+b+" = ?", ans, 'addition', a, b, '+'));
        }
      }
      if (operation === 'subtraction'){
        while (pool.length < targetSize && attempts++ < maxAttempts){
          var fluency2 = (difficulty === 'easy') && Math.random() < 0.5;
          var cap2 = fluency2 ? Math.min(10, rules.addSubMax) : rules.addSubMax;
          var a2 = randInt(0, cap2), b2 = randInt(0, a2), ans2 = a2 - b2;
          if (ans2 >= 0) pool.push(mkQ(a2+" - "+b2+" = ?", ans2, 'subtraction', a2, b2, '-'));
        }
      }
      if (operation === 'multiplication'){
        while (pool.length < targetSize && attempts++ < maxAttempts){
          var a3 = randInt(1, rules.mulMax), b3 = randInt(1, rules.mulMax);
          pool.push(mkQ(a3+" × "+b3+" = ?", a3*b3, 'multiplication', a3, b3, '×'));
        }
      }
      if (operation === 'division'){
        while (pool.length < targetSize && attempts++ < maxAttempts){
          var divisor = randInt(1, rules.divMaxDivisor), quotient = randInt(1, rules.divMaxQuotient);
          var dividend = divisor * quotient;
          pool.push(mkQ(dividend+" ÷ "+divisor+" = ?", quotient, 'division', quotient, divisor, '÷'));
        }
      }
      return pool;
    }

    function showQuestion(){
      if (currentQuestionIndex >= questions.length){ showResults(); return; }
      selectedAnswer = null;
      var q = questions[currentQuestionIndex];

      document.getElementById('questionText').textContent = q.questionText;
      document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;

      var progress = (currentQuestionIndex / totalQuestions) * 100;
      var pb = document.getElementById('progressBar');
      var p = Math.max(2, Math.round(progress)); pb.style.width = p + '%'; pb.setAttribute('aria-valuenow', String(p));

      var options = generateAnswerOptions(q.answer);
      var items = document.querySelectorAll('.answer-item');
      options.forEach(function(opt, i){
        var el = items[i]; if (!el) return;
        el.setAttribute('data-value', String(opt));
        el.setAttribute('data-idx', String(i));
        el.querySelector('.tabular-nums').textContent = String(opt);
        el.classList.remove('selected');
        el.setAttribute('aria-selected','false');
      });

      var confirmButton = document.getElementById('confirmButton');
      confirmButton.disabled = true; confirmButton.setAttribute('aria-disabled','true');

      startTime = Date.now();
      setupAnswerSelection();

      placeCoachForContext('game');
      showCoach('שאלה ' + (currentQuestionIndex + 1) + ' מתוך ' + totalQuestions + '. בהצלחה!');
    }

    function setupAnswerSelection(){
      var items = document.querySelectorAll('.answer-item');
      items.forEach(function(item){
        item.setAttribute('tabindex','0');
        item.setAttribute('role','button');
        item.setAttribute('aria-selected','false');

        item.onpointerdown = function(){ item.classList.add('pressed'); };
        var clearPress = function(){ item.classList.remove('pressed'); };
        item.onpointerup = clearPress; item.onpointercancel = clearPress; item.onpointerleave = clearPress;

        item.onkeydown = function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); item.click(); } };
        item.onclick = function(){
          // tick כללי יופעל מאזין-גלובלי; כאן רק לוגיקה של בחירה
          items.forEach(function(it){ it.classList.remove('selected'); it.setAttribute('aria-selected','false'); });
          item.classList.add('selected'); item.setAttribute('aria-selected','true');
          selectedAnswer = parseInt(item.getAttribute('data-value'), 10);
          var confirm = document.getElementById('confirmButton');
          confirm.disabled = false; confirm.setAttribute('aria-disabled','false');
        };
      });
    }

    function confirmAnswer(){
      if (selectedAnswer === null) return;
      var correctAnswer = questions[currentQuestionIndex].answer;
      var endTime = Date.now(); totalTime += (endTime - startTime) / 1000;
      if (selectedAnswer === correctAnswer){ correctCount++; showFeedback(true); }
      else { mistakes.push({ question: questions[currentQuestionIndex], userAnswer: selectedAnswer, correctAnswer: correctAnswer }); showFeedback(false); }
    }

    function showFeedback(isCorrect){
      var feedback = document.getElementById('feedback');
      var icon = document.getElementById('feedbackIcon');
      var text = document.getElementById('feedbackText');

      if (isCorrect){
        icon.textContent = '🎉';
        text.textContent = 'כל הכבוד! תשובה נכונה!';
        text.className = 'text-2xl font-bold mb-6 text-green-600';
        playSuccessSound();
        showCoach('יפה! המשך באותו קצב.');
      } else {
        icon.textContent = '💪';
        text.textContent = 'כמעט! בשאלה הבאה תצליח!';
        text.className = 'text-2xl font-bold mb-6 text-orange-600';
        playErrorSound();
        showCoach('כמעט! עוברים לשאלה הבאה.');
      }

      feedback.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      document.getElementById('nextButton').focus();
    }

    function nextQuestion(){
      document.getElementById('feedback').classList.add('hidden');
      document.body.style.overflow = '';
      currentQuestionIndex++;
      if (currentQuestionIndex < totalQuestions){
        if (currentQuestionIndex === Math.floor(totalQuestions/2)){
          showCoach('כבר חצי דרך – כל הכבוד!');
        }
        showQuestion();
        document.getElementById('confirmButton').focus();
      } else {
        var pb = document.getElementById('progressBar'); pb.style.width = '100%'; pb.setAttribute('aria-valuenow','100');
        showResults();
      }
    }

    function showResults(){
      ['gameScreen','mistakesScreen','tutorialScreen'].forEach(function(id){
        var el = document.getElementById(id); if (el) el.classList.add('hidden');
      });
      var rs = document.getElementById('resultsScreen'); rs.classList.remove('hidden');

      var incorrectCount = totalQuestions - correctCount;
      var percentage = Math.round((correctCount / totalQuestions) * 100);

      var msg = document.getElementById('performanceMessage');
      var icon = rs.querySelector('.text-8xl');
      var title = document.getElementById('resultsTitle');

      if (correctCount === totalQuestions){
        msg.textContent = 'מושלם! ענית נכון על כל השאלות! 🌟';
        msg.className = 'mb-4 font-medium text-lg text-green-600';
        icon.textContent = '🏆';
        title.innerHTML = 'כל הכבוד <span id="finalPlayerName">' + playerName + '</span>!';
        title.className = 'text-3xl font-bold text-green-600 mb-4';
        confettiBurst(rs.querySelector('div.text-center.bg-white') || rs);
        showCoach('מושלם! פתרת הכל נכון 🎉');
      } else if (percentage < 50){
        msg.textContent = 'נמשיך לתרגל כדי להשתפר. אתה יכול!';
        msg.className = 'mb-4 font-medium text-lg text-orange-600';
        icon.textContent = '💪';
        title.textContent = 'יופי ' + playerName + ', נמשיך לתרגל';
        title.className = 'text-3xl font-bold text-orange-600 mb-4';
        showCoach('יופי ' + playerName + ', נמשיך לתרגל. נעבור יחד על הטעויות.');
      } else {
        msg.textContent = 'ענית נכון על ' + correctCount + ' מתוך ' + totalQuestions + ' שאלות - כל הכבוד! 🎯';
        msg.className = 'mb-4 font-medium text-lg text-blue-600';
        icon.textContent = '🏆';
        title.innerHTML = 'כל הכבוד <span id="finalPlayerName">' + playerName + '</span>!';
        title.className = 'text-3xl font-bold text-green-600 mb-4';
        showCoach('ביצוע טוב! רוצה לנסות שוב או ללמוד מהטעויות?');
      }

      updatePerformanceBar(correctCount, incorrectCount, percentage);
      document.getElementById('correctAnswers').textContent = String(correctCount);
      document.getElementById('averageTime').textContent = String(Math.max(1, Math.round(totalTime / totalQuestions)));
      document.getElementById('mistakesButton').classList.toggle('hidden', mistakes.length === 0);

      placeCoachForContext('default');
    }

    function updatePerformanceBar(correct, incorrect, percentage){
      var correctPercentage = (correct / totalQuestions) * 100;
      var incorrectPercentage = (incorrect / totalQuestions) * 100;
      document.getElementById('correctBar').style.width = correctPercentage + '%';
      document.getElementById('incorrectBar').style.width = incorrectPercentage + '%';
      document.getElementById('performancePercentage').textContent = percentage + '%';
      document.getElementById('correctCount').textContent = String(correct);
      document.getElementById('incorrectCount').textContent = String(incorrect);
    }

    function showMistakes(){
      document.getElementById('resultsScreen').classList.add('hidden');
      document.getElementById('tutorialScreen').classList.add('hidden');
      document.getElementById('mistakesScreen').classList.remove('hidden');

      var incorrectCount = totalQuestions - correctCount;
      document.getElementById('mistakesCorrectBar').style.width = ((correctCount / totalQuestions) * 100) + '%';
      document.getElementById('mistakesIncorrectBar').style.width = ((incorrectCount / totalQuestions) * 100) + '%';

      var mm = document.getElementById('mistakesMessage');
      if (mistakes.length === 0){
        mm.textContent = 'מושלם! ענית נכון על כל ' + totalQuestions + ' השאלות! 🌟';
        mm.className = 'text-lg text-green-600 font-medium mb-4';
      } else if (correctCount > 0){
        mm.textContent = 'ענית נכון על ' + correctCount + ' מתוך ' + totalQuestions + ' - בואו נלמד מה-' + mistakes.length + ' שנשארו';
        mm.className = 'text-lg text-blue-600 font-medium mb-4';
      } else {
        mm.textContent = 'בואו נלמד יחד איך לפתור את השאלות האלה';
        mm.className = 'text-lg text-orange-600 font-medium mb-4';
      }

      var list = document.getElementById('mistakesList');
      list.innerHTML = '';
      if (mistakes.length === 0){
        list.innerHTML = '<div class="text-center p-8"><div class="text-6xl mb-4">🎉</div><h3 class="text-2xl font-bold text-green-600">מעולה!</h3><p class="text-lg text-gray-600">לא היו לך טעויות במשחק הזה!</p></div>';
        return;
      }

      questions.forEach(function(q, i){
        var m = mistakes.find(function(mk){ return mk.question.questionText === q.questionText; });
        if (!m) return;
        var div = document.createElement('div');
        div.className = 'bg-orange-50 border-2 border-orange-200 rounded-2xl p-6 cursor-pointer hover:bg-orange-100 transition-colors';
        div.onclick = function(){ showTutorial(m); };
        div.innerHTML =
          '<div class="flex items-center justify-between mb-4">' +
            '<div class="flex items-center gap-4">' +
              '<div class="w-4 h-4 bg-orange-500 rounded-full"></div>' +
              '<h3 class="text-xl font-bold text-orange-600">שאלה ' + (i + 1) + '</h3>' +
            '</div>' +
            '<div class="text-2xl">🤔</div>' +
          '</div>' +
          '<div class="text-2xl font-bold text-gray-800 mb-4 ltr">' + m.question.questionText + '</div>' +
          '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">' +
            '<div class="bg-red-100 border-2 border-red-300 rounded-xl p-4">' +
              '<div class="text-sm text-red-600 font-bold mb-1">התשובה שלך:</div>' +
              '<div class="text-xl font-bold text-red-700 ltr">' + m.userAnswer + '</div>' +
            '</div>' +
            '<div class="bg-green-100 border-2 border-green-300 rounded-xl p-4">' +
              '<div class="text-sm text-green-600 font-bold mb-1">התשובה הנכונה:</div>' +
              '<div class="text-xl font-bold text-green-700 ltr">' + m.correctAnswer + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="text-center text-blue-600 font-bold">👆 לחץ כאן כדי ללמוד איך לפתור</div>';
        list.appendChild(div);
      });

      placeCoachForContext('default');
      showCoach('נעבור על השאלות שבהן טעית – לחץ כדי ללמוד.');
    }

    function showTutorial(mistake){
      currentTutorialMistake = mistake;
      document.getElementById('mistakesScreen').classList.add('hidden');
      document.getElementById('tutorialScreen').classList.remove('hidden');

      var q = mistake.question;
      document.getElementById('tutorialTitle').textContent = q.questionText;
      createTutorialSteps(q);
      createInteractiveDemo(q);

      placeCoachForContext('default');
      showCoach('הנה הסבר צעד־אחר־צעד. נסה את האזור האינטראקטיבי.');
    }

    function createTutorialSteps(question){
      var c = document.getElementById('tutorialSteps');
      c.innerHTML = '';
      getTutorialSteps(question).forEach(function(s, i){
        var d = document.createElement('div');
        d.className = 'bg-blue-50 border-2 border-blue-200 rounded-2xl p-6';
        d.innerHTML =
          '<div class="flex items-center mb-4 gap-4">' +
            '<div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">' + (i+1) + '</div>' +
            '<h3 class="text-xl font-bold text-blue-600">' + s.title + '</h3>' +
          '</div>' +
          '<p class="text-gray-700 text-lg">' + s.description + '</p>';
        c.appendChild(d);
      });
    }

    function getTutorialSteps(q){
      var operation = q.operation, num1 = q.num1, num2 = q.num2, answer = q.answer;
      if (operation === 'addition') return [
        { title:'הבנת השאלה', description:'אנחנו רוצים לדעת כמה זה ' + num1 + ' + ' + num2 + '.' },
        { title:'הצגת הפריטים הראשונים', description:'נתחיל עם ' + num1 + ' פריטים.' },
        { title:'הוספת פריטים', description:'נוסיף ' + num2 + ' ונמנה הכול יחד.' },
        { title:'התוצאה', description:'יש ' + answer + ' פריטים. זו התשובה!' }
      ];
      if (operation === 'subtraction') return [
        { title:'הבנת השאלה', description:'אנחנו רוצים לדעת כמה זה ' + num1 + ' - ' + num2 + '.' },
        { title:'הצגת הפריטים הראשונים', description:'נתחיל עם ' + num1 + ' פריטים.' },
        { title:'הסרת פריטים', description:'נסיר ' + num2 + ' ונמנה כמה נשאר.' },
        { title:'התוצאה', description:'נשארו ' + answer + ' פריטים.' }
      ];
      if (operation === 'multiplication') return [
        { title:'הבנת השאלה', description:'אנחנו רוצים לדעת כמה זה ' + num1 + ' × ' + num2 + '.' },
        { title:'יצירת קבוצות', description:'ניצור ' + num1 + ' קבוצות של ' + num2 + '.' },
        { title:'ספירה', description:'נספור את כל הפריטים.' },
        { title:'התוצאה', description:'יש ' + answer + ' פריטים בסך הכול.' }
      ];
      if (operation === 'division'){
        var dividend = parseInt(q.questionText.split(' ÷ ')[0], 10);
        var divisor = q.num2;
        return [
          { title:'הבנת השאלה', description:'אנחנו רוצים לדעת כמה זה ' + dividend + ' ÷ ' + divisor + '.' },
          { title:'הצגת כל הפריטים', description:'נתחיל עם ' + dividend + ' פריטים.' },
          { title:'חלוקה לקבוצות', description:'נחלק לקבוצות של ' + divisor + '.' },
          { title:'התוצאה', description:'קיבלנו ' + answer + ' קבוצות.' }
        ];
      }
      return [];
    }

    // Tutorial interactive demo (אמוג'י רק במסך ההדרכה)
    var tutorialEmojis = ['🍎','🎈','⭐','🌟','🍊','🎯','🌈','🎪'];
    function createInteractiveDemo(q){
      var area = document.getElementById('interactiveContent');
      var info = document.getElementById('interactiveInstructions');
      area.innerHTML = '';
      var operation = q.operation, num1 = q.num1, num2 = q.num2, answer = q.answer;
      var emoji = tutorialEmojis[Math.floor(Math.random() * tutorialEmojis.length)];

      if (operation === 'addition'){
        var clicked = 0, total = answer;
        for (var i=0;i<total;i++){
          var s = document.createElement('span'); s.className='text-3xl m-1 opacity-50 cursor-pointer'; s.textContent = i < num1 ? '🔵' : '🟡';
          s.onclick=function(){ if (this.style.opacity !== '1'){ this.style.opacity='1'; clicked++; info.textContent = clicked===total ? ('מעולה! ספרת ' + total + ' פריטים - זו התשובה! 🎉') : ('המשך לספור... (' + clicked + '/' + total + ')'); } };
          area.appendChild(s); if(((i+1)%5===0) && i<total-1) area.appendChild(document.createElement('br'));
        }
        info.textContent = 'לחץ על הכדורים כדי לספור את ' + num1 + ' + ' + num2;
        return;
      }
      if (operation === 'subtraction'){
        var removed = 0;
        for (var i2=0;i2<num1;i2++){
          var s2 = document.createElement('span'); s2.className='text-3xl m-1 cursor-pointer'; s2.textContent = emoji;
          s2.onclick=function(){ if (this.style.opacity !== '0.3' && removed < num2){ this.style.opacity='0.3'; this.style.textDecoration='line-through'; removed++; info.textContent = removed===num2 ? ('מעולה! הסרת ' + num2 + ' פריטים; נשארו ' + answer + '. 🎉') : ('לחץ על עוד ' + (num2-removed)); } };
          area.appendChild(s2); if(((i2+1)%5===0) && i2<num1-1) area.appendChild(document.createElement('br'));
        }
        info.textContent = 'לחץ על ' + num2 + ' פריטים כדי להסיר מתוך ' + num1;
        return;
      }
      if (operation === 'multiplication'){
        var shown = 0;
        for (var g=0; g<num1; g++){
          var group = document.createElement('div'); group.className='inline-block border-2 border-dashed border-blue-300 rounded-lg p-3 m-2 bg-blue-50'; group.style.opacity='0.5';
          var label = document.createElement('div'); label.className='text-sm font-bold text-blue-600 mb-2 text-center'; label.textContent='קבוצה ' + (g+1); group.appendChild(label);
          for (var i3=0;i3<num2;i3++){ var sp=document.createElement('span'); sp.className='text-2ל m-1'; sp.textContent=emoji; group.appendChild(sp); }
          group.onclick=function(){ if (this.style.opacity==='0.5'){ this.style.opacity='1'; shown++; info.textContent = (shown===num1) ? ('מעולה! ' + num1 + '×' + num2 + ' = ' + answer + '. 🎉') : ('נהדר! לחץ על עוד ' + (num1-shown) + ' קבוצות'); } };
          area.appendChild(group);
        }
        info.textContent = 'לחץ על הקבוצות כדי לראות ' + num1 + ' קבוצות של ' + num2;
        return;
      }
      if (operation === 'division'){
        var shown2 = 0; var dividend = parseInt(q.questionText.split(' ÷ ')[0], 10);
        for (var g2=0; g2<answer; g2++){
          var group2 = document.createElement('div'); group2.className='inline-block border-2 border-dashed border-purple-300 rounded-lg p-3 m-2 bg-purple-50'; group2.style.opacity='0.5';
          var label2 = document.createElement('div'); label2.className='text-sm font-bold text-purple-600 mb-2 text-center'; label2.textContent='קבוצה ' + (g2+1); group2.appendChild(label2);
          for (var i4=0;i4<num2;i4++){ var sp2=document.createElement('span'); sp2.className='text-2xl m-1'; sp2.textContent=emoji; group2.appendChild(sp2); }
          group2.onclick=function(){ if (this.style.opacity==='0.5'){ this.style.opacity='1'; shown2++; info.textContent = (shown2===answer) ? ('מעולה! חילקת ' + dividend + ' ל-' + answer + ' קבוצות של ' + num2 + '. 🎉') : ('נהדר! לחץ על עוד ' + (answer-shown2) + ' קבוצות'); } };
          area.appendChild(group2);
        }
        info.textContent = 'לחץ על הקבוצות כדי לראות חלוקה ל-' + answer + ' קבוצות של ' + num2;
      }
    }

    function startOver(){
      currentOperation='addition'; currentDifficulty='easy'; currentQuestionIndex=0;
      correctCount=0; questions=[]; mistakes=[]; startTime=0; totalTime=0; selectedAnswer=null; currentTutorialMistake=null;
      coachHidden = false; // החזרה להצגה מחדש
      ['gameScreen','resultsScreen','mistakesScreen','tutorialScreen','difficultyScreen','nameScreen','welcomeScreen'].forEach(function(id){
        var el=document.getElementById(id); if (el) el.classList.add('hidden');
      });
      document.getElementById('operationScreen').classList.remove('hidden');
      applyCurriculumToOperationButtons();
      placeCoachForContext('default');
      showCoach('בחר תרגיל חדש או שנה תוכנית לימוד.');
    }

    // ===== Utilities =====
    function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
    function shuffleArray(arr){ var a=arr.slice(); for(var i=a.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t; } return a; }
    function generateAnswerOptions(correct){
      var opts = [correct];
      while (opts.length < 4){
        var wrong = correct + Math.floor(Math.random()*7) - 3; // ±3
        if (wrong > 0 && wrong !== correct && opts.indexOf(wrong) === -1) opts.push(wrong);
      }
      return shuffleArray(opts);
    }

    // ===== Audio helpers (Desktop+Mobile) =====
    var audioCtx = null;
    function getAudioCtx(){
      if (isMuted) return null;
      try{
        if (!audioCtx){
          var AC = window.AudioContext || window.webkitAudioContext;
          if (!AC) return null;
          audioCtx = new AC();
        }
        if (audioCtx.state === 'suspended' && audioCtx.resume) audioCtx.resume();
        return audioCtx;
      } catch (e) { return null; }
    }
    function ensureAudioUnlocked(){
      var ctx = getAudioCtx(); if (!ctx) return;
      try{
        var buff = ctx.createBuffer(1, 1, 22050);
        var src = ctx.createBufferSource(); src.buffer = buff; src.connect(ctx.destination); src.start(0);
      } catch(e){}
    }
    // ייזום אודיו במחווה הראשונה (מובייל וגם דסקטופ)
    function primeAudioOnce(){
      ensureAudioUnlocked();
      document.removeEventListener('pointerdown', primeAudioOnce);
      document.removeEventListener('touchstart', primeAudioOnce);
      document.removeEventListener('mousedown', primeAudioOnce);
    }
    document.addEventListener('pointerdown', primeAudioOnce, { passive: true });
    document.addEventListener('touchstart', primeAudioOnce, { passive: true });
    document.addEventListener('mousedown', primeAudioOnce, { passive: true });

    function tone(freq, dur, t, type, gain){
      if (isMuted) return;
      type = type || 'sine';
      gain = typeof gain === 'number' ? gain : 0.22;
      var ctx = getAudioCtx(); if (!ctx) return;
      var start = (typeof t === 'number') ? t : ctx.currentTime;
      var osc = ctx.createOscillator(); var g = ctx.createGain();
      osc.type = type; osc.frequency.setValueAtTime(freq, start);
      g.gain.setValueAtTime(gain, start); g.gain.exponentialRampToValueAtTime(0.001, start + dur);
      osc.connect(g); g.connect(ctx.destination); osc.start(start); osc.stop(start + dur);
    }
    function playSelectTick(){
      var ctx = getAudioCtx(); if (!ctx) return; var t = ctx.currentTime;
      tone(440, 0.06, t, 'triangle', 0.10);
    }
    function playSuccessSound(){
      var ctx = getAudioCtx(); if (!ctx) return; var t = ctx.currentTime;
      tone(523.25, 0.12, t,      'sine', 0.22); // C5
      tone(659.25, 0.12, t+0.10, 'sine', 0.20); // E5
      tone(783.99, 0.14, t+0.20, 'sine', 0.18); // G5
    }
    function playErrorSound(){
      var ctx = getAudioCtx(); if (!ctx) return; var t = ctx.currentTime;
      tone(220, 0.10, t,      'sawtooth', 0.18);
      tone(180, 0.12, t+0.10, 'sawtooth', 0.16);
    }

    // Global click tick on interactive elements
    document.addEventListener('click', function(e){
      var el = e.target.closest('button, .op-btn, .answer-item');
      if (!el) return;
      if (el.id === 'audioToggle') return; // לא לצלצל על כפתור השתקה
      if (el.disabled || el.getAttribute('aria-disabled') === 'true') return;
      playSelectTick();
    }, true);

    // ===== Confetti (results only, 100% correct) =====
    function confettiBurst(container){
      try{
        if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      } catch(e){}
      var n = 28;
      for (var i=0;i<n;i++){
        var dot = document.createElement('span');
        dot.style.position='absolute'; dot.style.width='8px'; dot.style.height='8px'; dot.style.borderRadius='50%';
        dot.style.left='50%'; dot.style.top='10%';
        var colors = ['#22c55e','#3b82f6','#f59e0b','#ef4444','#a855f7'];
        dot.style.background=colors[i%colors.length];
        var angle=(i/n)*Math.PI*2, dist=80+Math.random()*50, tx=Math.cos(angle)*dist, ty=Math.sin(angle)*dist;
        var anim = dot.animate(
          [{ transform:'translate(-50%,-50%) scale(1)', opacity:1 },
           { transform:'translate('+(tx-50)+'%,'+(ty-50)+'%) scale(0.9)', opacity:0 }],
          { duration: 900, easing:'cubic-bezier(.2,.8,.2,1)' }
        );
        anim.onfinish=function(){ if (dot && dot.parentNode) dot.parentNode.removeChild(dot); };
        container.appendChild(dot);
      }
    }

    // ===== Audio toggle control =====
    function initAudioToggle(){
      var btn = document.getElementById('audioToggle');
      if (!btn) return;

      // טען מצב מאוחסן
      try {
        var saved = localStorage.getItem('soundMuted');
        if (saved === 'true') isMuted = true;
      } catch(e){}

      btn.setAttribute('aria-pressed', isMuted ? 'true' : 'false');
      btn.title = isMuted ? 'הצליל מושתק' : 'הצליל פעיל';

      btn.addEventListener('click', function(){
        isMuted = !isMuted;
        btn.setAttribute('aria-pressed', isMuted ? 'true' : 'false');
        btn.title = isMuted ? 'הצליל מושתק' : 'הצליל פעיל';
        try { localStorage.setItem('soundMuted', String(isMuted)); } catch(e){}
        if (!isMuted) ensureAudioUnlocked();
      });
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', function (){
      // כפתור התחל
      var startBtn = document.querySelector('#welcomeScreen button');
      if (startBtn){ startBtn.addEventListener('click', function(e){ e.preventDefault(); showNameInput(); }); }

      // שליחת טופס שם
      var form = document.getElementById('nameForm');
      if (form){
        form.addEventListener('submit', function(e){ e.preventDefault(); showOperationSelect(); });
      }
      var input = document.getElementById('playerName');
      if (input){
        input.addEventListener('keydown', function(e){ if (e.key === 'Enter'){ e.preventDefault(); showOperationSelect(); } });
      }

      // Select תוכנית לימוד — גלילה למרכז במובייל
      var curriculumSel = document.getElementById('curriculumSelect');
      if (curriculumSel){
        curriculumSel.addEventListener('change', function(e){
          currentCurriculum = e.target.value;
          applyCurriculumToOperationButtons();
        });
        curriculumSel.addEventListener('focus', function(){
          try{ curriculumSel.scrollIntoView({block:'center', behavior:'smooth'}); }catch(_){}
        });
      }

      // מספר שאלות
      var qSel = document.getElementById('questionCountSelect');
      if (qSel){
        qSel.addEventListener('change', function(e){
          questionCount = parseInt(e.target.value, 10) || 6;
        });
      }

      // Coach
      bindCoach();
      hideCoach(); // לא מציגים בשני המסכים הראשונים

      // Audio toggle
      initAudioToggle();
    });
  </script>
</body>
</html>
