<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¡×¤×¨×•× ×¦'×™×§ - ××©×—×§ ×—×©×‘×•×Ÿ ×œ×™××•×“×™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');

    :root { color-scheme: light; }
    body { font-family: 'Assistant', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .ltr { direction: ltr; unicode-bidi: embed; display: inline-block; }

    /* ===== Answer cards ===== */
    .answer-item{
      position: relative;
      transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease;
      cursor: pointer;
      user-select: none; -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
      background: rgba(255,255,255,0.85);
      border-radius: 1rem;
    }
    .answer-item::before{
      content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background: var(--tint, transparent); opacity:.08; /* ×˜×™× ×˜ ×¢×“×™×Ÿ */
    }
    /* ×¤×¡ ×¡×™××•×Ÿ ××™××™×Ÿ */
    .answer-item .accent{
      position:absolute; right:0; left:auto; top:0; bottom:0;
      width:8px; border-radius:0 1rem 1rem 0; opacity:.55;
      background: var(--tint);
    }
    .answer-item[data-idx="0"] { --tint:#f87171; } /* ××“××“× */
    .answer-item[data-idx="1"] { --tint:#60a5fa; } /* ×›×—×•×œ */
    .answer-item[data-idx="2"] { --tint:#4ade80; } /* ×™×¨×•×§ */
    .answer-item[data-idx="3"] { --tint:#facc15; } /* ×¦×”×•×‘ */

    .answer-item:active, .answer-item.pressed { transform: scale(0.98); }
    .answer-item.selected{
      border: 3px solid #2563eb; /* blue-600 */
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    }
    .answer-item:focus-visible{
      outline: none;
      box-shadow: 0 0 0 4px rgba(59,130,246,0.45);
    }

    @media (prefers-reduced-motion: reduce){
      .answer-item{ transition: none !important; }
    }

    .owl-blink{ animation: blink 2s infinite; }
    @keyframes blink{ 0%,90%,100%{transform:scaleY(1)} 95%{transform:scaleY(0.1)} }

    .confirm-button{ transition: all .25s ease; }
    .confirm-button:disabled{ opacity:.5; cursor:not-allowed; transform:none !important; }

    /* Shufi coach */
    #coach { padding-bottom: calc(env(safe-area-inset-bottom,0px)); }
    @media (prefers-reduced-motion: reduce){
      #coach { transition: none !important; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-50 to-green-100 min-h-screen">
  <!-- Welcome Screen -->
  <div id="welcomeScreen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-6xl mb-4 owl-blink">ğŸ¦‰</div>
      <h1 class="text-4xl font-bold text-purple-600 mb-4">××¡×¤×¨×•× ×¦'×™×§</h1>
      <!-- ×”×•×’×“×œ ×œ×¤×—×•×ª ×‘+4px -->
      <p class="text-2xl text-gray-700 mb-8">×‘×•××• ×œ×œ××•×“ ×—×©×‘×•×Ÿ ×¢× ×©×•×¤×™ ×”×™× ×©×•×£</p>
      <button type="button" onclick="showNameInput()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">
        ×”×ª×—×œ ××©×—×§
      </button>
    </div>
  </div>

  <!-- Name Input Screen -->
  <div id="nameScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <form id="nameForm" class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-5xl mb-4">ğŸ‘‹</div>
      <h2 class="text-3xl font-bold text-blue-600 mb-6">××™×š ×§×•×¨××™× ×œ×š?</h2>
      <input type="text" id="playerName" name="playerName" required placeholder="×”×›× ×¡ ××ª ×©××š ×›××Ÿ" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-6 text-center focus:border-blue-500 focus:outline-none">
      <button type="submit" class="bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-blue-600 hover:to-green-600 transform hover:scale-105 transition-all duration-200 shadow-lg">
        ×”××©×š
      </button>
    </form>
  </div>

  <!-- Operation Selection Screen -->
  <div id="operationScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full">
      <div class="text-5xl mb-4">ğŸ¯</div>
      <h2 class="text-5xl font-extrabold text-green-600 mb-3 leading-tight">×‘×•××• × ×‘×—×¨ ××ª ×¡×•×’ ×”×ª×¨×’×™×œ</h2>
      <p class="text-xl text-gray-700 mb-8 leading-relaxed">×‘×›×œ ×¡×˜ ×ª×¨×’×™×œ×™× ×ª×•×¦×’ ×œ×š ×¡×“×¨×ª ×©××œ×•×ª ××’×•×•× ×•×ª</p>

      <!-- Curriculum Selector (ABOVE the grid) -->
      <div class="text-right mb-8">
        <label for="curriculumSelect" class="block text-lg font-semibold text-gray-800 mb-2">×‘×—×™×¨×ª ×ª×•×›× ×™×ª ×œ×™××•×“</label>
        <select id="curriculumSelect" class="w-full p-4 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none bg-white">
          <option value="none" selected>×œ×œ× ×ª×•×›× ×™×ª</option>
          <option value="il_g1_s1">×›×™×ª×” ××³, ××—×¦×™×ª ×¨××©×•× ×” (×¢×“ 10)</option>
          <option value="il_g1_s2">×›×™×ª×” ××³, ××—×¦×™×ª ×©× ×™×™×” (×¢×“ 20)</option>
          <option value="il_g1_adv">×›×™×ª×” ××³, ××ª×’×¨ (×¢×“ 30)</option>
          <option value="il_g2">×›×™×ª×” ×‘×³ (×¢×“ 100)</option>
          <option value="il_g3">×›×™×ª×” ×’×³ (×¢×“ 100; ×›×¤×œ/×—×™×œ×•×§ ×¢×“ 10Ã—10)</option>
          <option value="il_g4">×›×™×ª×” ×“×³ (×¢×“ 1000; ×›×¤×œ/×—×™×œ×•×§ ×¢×“ 12Ã—12)</option>
        </select>
      </div>

      <div id="opsGrid" class="grid grid-cols-2 gap-4 mb-6">
        <button data-op="addition" onclick="selectOperation('addition')" class="op-btn bg-gradient-to-r from-green-400 to-blue-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">â•</div>×—×™×‘×•×¨</button>
        <button data-op="subtraction" onclick="selectOperation('subtraction')" class="op-btn bg-gradient-to-r from-red-400 to-pink-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">â–</div>×—×™×¡×•×¨</button>
        <button data-op="multiplication" onclick="selectOperation('multiplication')" class="op-btn bg-gradient-to-r from-purple-400 to-indigo-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">âœ–ï¸</div>×›×¤×œ</button>
        <button data-op="division" onclick="selectOperation('division')" class="op-btn bg-gradient-to-r from-orange-400 to-red-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-4xl mb-2">â—</div>×—×™×œ×•×§</button>
        <button data-op="mixed" onclick="selectOperation('mixed')" class="op-btn bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-7 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg col-span-2"><div class="text-4xl mb-2">ğŸ²</div>×”×›×œ</button>
      </div>
    </div>
  </div>

  <!-- Difficulty Selection Screen -->
  <div id="difficultyScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
      <div class="text-5xl mb-4">âš¡</div>
      <h2 class="text-4xl sm:text-5xl font-bold text-blue-600 mb-6">××™×–×• ×¨××ª ×§×•×©×™ ××ª××™××” ×œ×š ×”×™×•×?</h2>

      <!-- ××¡×¤×¨ ×©××œ×•×ª ××¢×œ ×¨××ª ×”×§×•×©×™ + ×¢×™×¦×•×‘ ×–×”×” ×œ×‘×—×™×¨×ª ×”×ª×•×›× ×™×ª -->
      <div class="mt-1 mb-6 text-right">
        <label for="questionCountSelect" class="block text-lg font-semibold text-gray-800 mb-2">××¡×¤×¨ ×©××œ×•×ª ×‘×¡×˜</label>
        <select id="questionCountSelect" class="w-full p-4 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none bg-white">
          <option value="6" selected>6</option>
          <option value="8">8</option>
          <option value="10">10</option>
        </select>
      </div>

      <div class="flex flex-col gap-4 mb-2">
        <button onclick="startGame('easy')" class="bg-gradient-to-r from-green-400 to-green-500 text-white p-6 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">ğŸŒ±</div><div class="font-bold">×§×œ</div></button>
        <button onclick="startGame('medium')" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">ğŸ”¥</div><div class="font-bold">×‘×™× ×•× ×™</div></button>
        <button onclick="startGame('hard')" class="bg-gradient-to-r from-red-400 to-purple-500 text-white p-6 rounded-2xl text-2xl font-bold hover:scale-105 transition-all duration-200 shadow-lg"><div class="text-3xl mb-2">âš¡</div><div class="font-bold">××ª×§×“×</div></button>
      </div>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="hidden min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6 mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-4">
        <div class="text-2xl font-bold text-purple-600">×©××œ×” <span id="currentQuestion" class="ltr">1</span> ××ª×•×š <span id="totalQuestions" class="ltr">6</span></div>
        <div class="text-xl text-gray-600">×©×œ×•× <span id="gamePlayerName"></span>! ğŸ‘‹</div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 mx-auto max-w-lg text-center">
      <div class="text-5xl mb-4 owl-blink">ğŸ¦‰</div>
      <div id="questionText" class="text-3xl font-bold text-gray-800 mb-6 ltr">5 + 3 = ?</div>
      <div class="text-xl text-gray-700 mb-4">×™×© ×œ×‘×—×•×¨ ××ª ×”×ª×©×•×‘×” ×”× ×›×•× ×”</div>
    </div>

    <!-- Answer Options -->
    <div class="grid grid-cols-1 gap-3 max-w-2xl mx-auto px-4 mb-6">
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="6" data-idx="0" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">6</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="8" data-idx="1" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">8</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="7" data-idx="2" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">7</div>
      </div>
      <div class="answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4" data-value="5" data-idx="3" tabindex="0" role="button" aria-selected="false">
        <span class="accent" aria-hidden="true"></span>
        <div class="text-4xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">5</div>
      </div>
    </div>

    <div class="text-center space-y-4">
      <button id="confirmButton" onclick="confirmAnswer()" disabled class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">××©×¨ ×ª×©×•×‘×”</button>
      <button type="button" onclick="startOver()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div role="dialog" aria-modal="true" aria-labelledby="feedbackText" class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
        <div id="feedbackIcon" class="text-8xl mb-4">ğŸ‰</div>
        <div id="feedbackText" aria-live="polite" class="text-2xl font-bold mb-6">×›×œ ×”×›×‘×•×“!</div>
        <button id="nextButton" onclick="nextQuestion()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×©××œ×” ×”×‘××”</button>
      </div>
    </div>
  </div>

  <!-- Results Screen -->
  <div id="resultsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full relative overflow-hidden">
      <div class="text-8xl mb-4">ğŸ†</div>
      <h2 class="text-3xl font-bold text-green-600 mb-4" id="resultsTitle">×›×œ ×”×›×‘×•×“ <span id="finalPlayerName"></span>!</h2>
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">×”×‘×™×¦×•×¢×™× ×©×œ×š:</span>
          <span id="performancePercentage" class="text-sm font-bold text-blue-600 ltr">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div id="performanceBar" class="h-6 rounded-full transition-all duration-1000 flex" aria-label="Progress indicator">
            <div id="correctBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
            <div id="incorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <span class="text-green-600 font-medium">âœ“ × ×›×•× ×•×ª: <span id="correctCount" class="ltr">0</span></span>
          <span class="text-orange-600 font-medium">âœ— ×©×’×•×™×•×ª: <span id="incorrectCount" class="ltr">0</span></span>
        </div>
      </div>

      <div class="text-xl text-gray-700 mb-6">
        <div id="performanceMessage" class="mb-4 font-medium text-lg">×¡×™×™××ª ××ª ×”×¡×˜! ğŸ¯</div>
        <div class="mb-2">×ª×©×•×‘×•×ª × ×›×•× ×•×ª: <span id="correctAnswers" class="font-bold text-green-600 ltr">0</span>/<span id="resultsTotal" class="ltr">6</span></div>
        <div class="mb-4">×–××Ÿ ×××•×¦×¢: <span id="averageTime" class="font-bold text-blue-600 ltr">0</span> ×©× ×™×•×ª</div>
      </div>

      <div class="flex flex-col gap-4">
        <button onclick="startGame(currentDifficulty)" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×× ×™ ×¨×•×¦×” ×œ×ª×¨×’×œ ××—×“×©</button>
        <button id="mistakesButton" onclick="showMistakes()" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×œ×œ××•×“ ××”×˜×¢×•×™×•×ª</button>
        <button onclick="showOperationSelect()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×‘× ×œ×™ ×ª×¨×’×•×œ ××—×¨</button>
      </div>
    </div>
  </div>

  <!-- Mistakes Review Screen -->
  <div id="mistakesScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">ğŸ“š</div>
        <h2 class="text-3xl font-bold text-orange-600 mb-4">×œ××“ ××”×˜×¢×•×™×•×ª</h2>
        <div class="mb-6 max-w-md mx-auto">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mb-3">
            <div id="mistakesPerformanceBar" class="h-4 rounded-full transition-all duration-1000 flex" aria-label="Performance summary">
              <div id="mistakesCorrectBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
              <div id="mistakesIncorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>
          <div id="mistakesMessage" class="text-lg text-gray-700 font-medium mb-4">×”× ×” ×”×ª×¨×’×™×œ×™× ×©×‘×”× ×˜×¢×™×ª</div>
        </div>
        <p class="text-lg text-gray-600">×œ×—×¥ ×¢×œ ×›×œ ×ª×¨×’×™×œ ×›×“×™ ×œ×œ××•×“ ××™×š ×œ×¤×ª×•×¨ ××•×ª×•:</p>
      </div>

      <div id="mistakesList" class="space-y-6 mb-8"></div>

      <div class="text-center space-y-4">
        <button onclick="showResults()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×—×–×•×¨ ×œ×ª×•×¦××•×ª</button>
        <button type="button" onclick="startOver()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
      </div>
    </div>
  </div>

  <!-- Interactive Tutorial Screen -->
  <div id="tutorialScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">ğŸ“</div>
        <h2 id="tutorialTitle" class="text-3xl font-bold text-blue-600 mb-4 ltr">7 Ã· 5 = ?</h2>
        <p class="text-lg text-gray-600">×‘×•××• × ×œ××“ ×™×—×“ ××™×š ×œ×¤×ª×•×¨ ××ª ×”×©××œ×” ×”×–×•!</p>
      </div>
      <div id="tutorialSteps" class="space-y-8 mb-8"></div>
      <div id="interactiveArea" class="bg-blue-50 rounded-2xl p-6 mb-8 text-center">
        <h3 class="text-xl font-bold text-blue-600 mb-4">× ×¡×” ×‘×¢×¦××š!</h3>
        <div id="interactiveContent" class="flex flex-wrap justify-center gap-2 mb-4"></div>
        <div id="interactiveInstructions" class="text-gray-600">×œ×—×¥ ×¢×œ ×”×¤×¨×™×˜×™× ×›×“×™ ×œ×¨××•×ª ××™×š ×”×¤×ª×¨×•×Ÿ ×¢×•×‘×“</div>
      </div>
      <div class="flex justify-center gap-4 flex-wrap">
        <button onclick="showMistakes()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×—×–×•×¨ ×œ×¨×©×™××ª ×”×˜×¢×•×™×•×ª</button>
        <button type="button" onclick="startOver()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
      </div>
    </div>
  </div>

  <!-- Shufi Coach Widget -->
  <div id="coach" class="fixed left-4 bottom-4 sm:left-6 sm:bottom-6 z-40 max-w-[80vw]" dir="rtl" hidden>
    <div class="flex items-start gap-3 bg-white/95 backdrop-blur rounded-2xl shadow-xl px-4 py-3 border border-gray-200">
      <div class="text-3xl" aria-hidden="true">ğŸ¦‰</div>
      <p id="coachMsg" class="text-base sm:text-lg text-gray-800 leading-snug" aria-live="polite">
        ×”×™×™! ×× ×™ ×©×•×¤×™. ×‘×”×¦×œ×—×”!
      </p>
      <button id="coachClose" class="ms-1 text-gray-500 hover:text-gray-700 text-xl leading-none" aria-label="×¡×’×•×¨ ×”×•×“×¢×ª ××××Ÿ">Ã—</button>
    </div>
    <div class="h-2"></div>
  </div>

  <script>
    // ===== State =====
    var currentOperation = 'addition';
    var currentDifficulty = 'easy';
    var currentQuestionIndex = 0;
    var correctCount = 0;
    var totalQuestions = 6;
    var questions = [];
    var mistakes = [];
    var startTime = 0;
    var totalTime = 0;
    var playerName = '';
    var currentTutorialMistake = null;
    var selectedAnswer = null;
    var currentCurriculum = 'none';
    var questionCount = 6;

    // Difficulty rules
    var rulesByDifficulty = {
      easy:   { addSubMax: 20,  mulMax: 5,  divMaxDivisor: 5,  divMaxQuotient: 5 },
      medium: { addSubMax: 100, mulMax: 10, divMaxDivisor: 10, divMaxQuotient: 10 },
      hard:   { addSubMax: 1000,mulMax: 12, divMaxDivisor: 12, divMaxQuotient: 12 }
    };

    // Curricula presets
    var curricula = {
      none: { name: '×œ×œ× ×ª×•×›× ×™×ª' },
      il_g1_s1: { name: '×›×™×ª×” ××³ â€“ ××—×¦×™×ª ×¨××©×•× ×”', operations: ['addition','subtraction'], addSubMax: 10 },
      il_g1_s2: { name: '×›×™×ª×” ××³ â€“ ××—×¦×™×ª ×©× ×™×™×”', operations: ['addition','subtraction'], addSubMax: 20 },
      il_g1_adv:{ name: '×›×™×ª×” ××³ â€“ ××ª×’×¨', operations: ['addition','subtraction'], addSubMax: 30 },
      il_g2:    { name: '×›×™×ª×” ×‘×³', operations: ['addition','subtraction'], addSubMax: 100 },
      il_g3:    { name: '×›×™×ª×” ×’×³', operations: ['addition','subtraction','multiplication','division'], addSubMax: 100, mulMax: 10, divMaxDivisor: 10, divMaxQuotient: 10 },
      il_g4:    { name: '×›×™×ª×” ×“×³', operations: ['addition','subtraction','multiplication','division'], addSubMax: 1000, mulMax: 12, divMaxDivisor: 12, divMaxQuotient: 12 }
    };

    function getOpsList(selectedOp, cur){
      if (selectedOp !== 'mixed') return [selectedOp];
      var allowed = cur && cur.operations ? cur.operations : null;
      return (allowed && allowed.length) ? allowed : ['addition','subtraction','multiplication','division'];
    }
    function getEffectiveRules(difficulty){
      var base = {
        addSubMax: rulesByDifficulty[difficulty].addSubMax,
        mulMax: rulesByDifficulty[difficulty].mulMax,
        divMaxDivisor: rulesByDifficulty[difficulty].divMaxDivisor,
        divMaxQuotient: rulesByDifficulty[difficulty].divMaxQuotient
      };
      var cur = curricula[currentCurriculum];
      if (cur && typeof cur.addSubMax !== 'undefined') base.addSubMax = cur.addSubMax;
      if (cur && typeof cur.mulMax !== 'undefined') base.mulMax = cur.mulMax;
      if (cur && typeof cur.divMaxDivisor !== 'undefined') base.divMaxDivisor = cur.divMaxDivisor;
      if (cur && typeof cur.divMaxQuotient !== 'undefined') base.divMaxQuotient = cur.divMaxQuotient;
      return base;
    }

    // ===== Shufi Coach =====
    var coachHidden = false;
    function showCoach(msg){
      if (coachHidden) return;
      var c = document.getElementById('coach');
      var m = document.getElementById('coachMsg');
      if (!c || !m) return;
      m.textContent = msg;
      c.hidden = false;
    }
    function hideCoach(){
      var c = document.getElementById('coach');
      if (c) c.hidden = true;
    }
    function bindCoach(){
      var x = document.getElementById('coachClose');
      if (x){
        x.onclick = function(){
          coachHidden = true;
          hideCoach();
        };
      }
    }

    // ===== Navigation =====
    function showNameInput(){
      var welcome = document.getElementById('welcomeScreen');
      var nameScr = document.getElementById('nameScreen');
      if (welcome) welcome.classList.add('hidden');
      if (nameScr) nameScr.classList.remove('hidden');
      setTimeout(function(){ var inp=document.getElementById('playerName'); if (inp) inp.focus(); }, 100);
    }
    function showOperationSelect(){
      var inputEl = document.getElementById('playerName');
      var name = inputEl ? String(inputEl.value || '').trim() : String(playerName || '').trim();
      if (!name){
        alert('×× × ×”×›× ×¡ ××ª ×©××š');
        if (inputEl) inputEl.focus();
        return;
      }
      playerName = name;

      var disp = document.getElementById('playerNameDisplay');
      if (disp) disp.textContent = playerName;

      var hideIds = ['nameScreen','resultsScreen','mistakesScreen','tutorialScreen'];
      for (var i=0;i<hideIds.length;i++){
        var el = document.getElementById(hideIds[i]);
        if (el) el.classList.add('hidden');
      }
      var op = document.getElementById('operationScreen');
      if (op) op.classList.remove('hidden');

      applyCurriculumToOperationButtons();
      showCoach('×‘×¨×•×š ×”×‘×, ' + playerName + '! ×‘×—×¨ ×ª×¨×’×™×œ ×›×“×™ ×œ×”×ª×—×™×œ.');
    }
    function selectOperation(operation){
      currentOperation = operation;
      var op = document.getElementById('operationScreen');
      var diff = document.getElementById('difficultyScreen');
      if (op) op.classList.add('hidden');
      if (diff) diff.classList.remove('hidden');
      showCoach('×‘×—×¨ ××ª ××¡×¤×¨ ×”×©××œ×•×ª ×•×¨××ª ×”×§×•×©×™, ×•××– ×”×ª×—×œ.');
    }
    function applyCurriculumToOperationButtons(){
      var cur = curricula[currentCurriculum];
      var allowed = cur && cur.operations ? cur.operations : null;
      var buttons = document.querySelectorAll('#opsGrid .op-btn');
      for (var i=0;i<buttons.length;i++){
        var btn = buttons[i];
        var op = btn.getAttribute('data-op');
        var enabled = true;
        if (allowed && op !== 'mixed') enabled = allowed.indexOf(op) !== -1;
        if (!enabled){
          btn.classList.add('opacity-50','cursor-not-allowed','pointer-events-none');
          btn.setAttribute('aria-disabled','true');
        } else {
          btn.classList.remove('opacity-50','cursor-not-allowed','pointer-events-none');
          btn.removeAttribute('aria-disabled');
        }
      }
    }

    // ===== Game flow =====
    function startGame(difficulty){
      currentDifficulty = difficulty;
      currentQuestionIndex = 0;
      correctCount = 0;
      totalTime = 0;
      mistakes = [];
      selectedAnswer = null;

      var curriculumSel = document.getElementById('curriculumSelect');
      if (curriculumSel) currentCurriculum = curriculumSel.value || 'none';
      var qSel = document.getElementById('questionCountSelect');
      questionCount = parseInt(qSel ? qSel.value : '6', 10) || 6;

      questions = generatePracticeSet(currentOperation, difficulty, questionCount);
      if (questions.length === 0){ alert('×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ ×ª×¨×’×™×œ×™× ×¢×‘×•×¨ ×”×”×’×“×¨×•×ª ×©× ×‘×—×¨×•'); return; }

      totalQuestions = questions.length;
      var tq = document.getElementById('totalQuestions'); if (tq) tq.textContent = totalQuestions;
      var rt = document.getElementById('resultsTotal'); if (rt) rt.textContent = totalQuestions;

      var ids = ['difficultyScreen','resultsScreen','mistakesScreen','tutorialScreen'];
      for (var i=0;i<ids.length;i++){ var n=document.getElementById(ids[i]); if(n) n.classList.add('hidden'); }
      var gs = document.getElementById('gameScreen'); if (gs) gs.classList.remove('hidden');
      var nameSpan = document.getElementById('gamePlayerName'); if (nameSpan) nameSpan.textContent = playerName;

      var pb = document.getElementById('progressBar');
      if (pb){ pb.style.width = '0%'; pb.setAttribute('aria-valuenow','0'); }

      showQuestion();
      showCoach('×™×¦×× ×• ×œ×“×¨×š! ×§×¨× ××ª ×”×©××œ×”, ×‘×—×¨ ×ª×©×•×‘×” ×•××– ××©×¨.');
    }

    function generatePracticeSet(operation, difficulty, desiredCount){
      var rules = getEffectiveRules(difficulty);
      var cur = curricula[currentCurriculum];
      var ops = getOpsList(operation, cur);
      var pool = [];
      for (var i=0;i<ops.length;i++){
        var op = ops[i];
        pool = pool.concat(buildOpPool(op, rules, desiredCount * 4, difficulty));
      }
      var map = {};
      for (var j=0;j<pool.length;j++){
        var q = pool[j];
        if (!map[q.questionText]) map[q.questionText] = q;
      }
      var unique = [];
      for (var k in map){ if (map.hasOwnProperty(k)) unique.push(map[k]); }
      return shuffleArray(unique).slice(0, desiredCount);
    }

    function buildOpPool(operation, rules, targetSize, difficulty){
      var pool = [];
      var attempts = 0, maxAttempts = 6000;
      function mkQ(text, answer, operation, num1, num2, symbol, explanation){
        return {questionText:text, answer:answer, explanation:explanation, operation:operation, num1:num1, num2:num2, symbol:symbol};
      }

      if (operation === 'addition'){
        while (pool.length < targetSize && attempts++ < maxAttempts){
          var fluency = (difficulty === 'easy') && Math.random() < 0.5;
          var cap = fluency ? Math.min(10, rules.addSubMax) : rules.addSubMax;
          var a = randInt(0, cap);
          var b = randInt(0, cap);
          var ans = a + b;
          if (ans <= cap) pool.push(mkQ(a + " + " + b + " = ?", ans, 'addition', a, b, '+',''));
        }
      }
      if (operation === 'subtraction'){
        while (pool.length < targetSize && attempts++ < maxAttempts){
          var fluency2 = (difficulty === 'easy') && Math.random() < 0.5;
          var cap2 = fluency2 ? Math.min(10, rules.addSubMax) : rules.addSubMax;
          var a2 = randInt(0, cap2);
          var b2 = randInt(0, a2);
          var ans2 = a2 - b2;
          if (ans2 >= 0 && ans2 <= cap2) pool.push(mkQ(a2 + " - " + b2 + " = ?", ans2, 'subtraction', a2, b2, '-',''));
        }
      }
      if (operation === 'multiplication'){
        while (pool.length < targetSize && attempts++ < maxAttempts){
          var a3 = randInt(1, rules.mulMax);
          var b3 = randInt(1, rules.mulMax);
          pool.push(mkQ(a3 + " Ã— " + b3 + " = ?", a3*b3, 'multiplication', a3, b3, 'Ã—',''));
        }
      }
      if (operation === 'division'){
        while (pool.length < targetSize && attempts++ < maxAttempts){
          var divisor = randInt(1, rules.divMaxDivisor);
          var quotient = randInt(1, rules.divMaxQuotient);
          var dividend = divisor * quotient;
          pool.push(mkQ(dividend + " Ã· " + divisor + " = ?", quotient, 'division', quotient, divisor, 'Ã·',''));
        }
      }
      return pool;
    }

    function showQuestion(){
      if (currentQuestionIndex >= questions.length){ showResults(); return; }
      selectedAnswer = null;
      var q = questions[currentQuestionIndex];

      var qt = document.getElementById('questionText'); if (qt) qt.textContent = q.questionText;
      var cq = document.getElementById('currentQuestion'); if (cq) cq.textContent = currentQuestionIndex + 1;

      var progress = (currentQuestionIndex / totalQuestions) * 100;
      var pb = document.getElementById('progressBar');
      if (pb){ var p = Math.max(2, Math.round(progress)); pb.style.width = p + '%'; pb.setAttribute('aria-valuenow', String(p)); }

      var options = generateAnswerOptions(q.answer);
      var items = document.querySelectorAll('.answer-item');
      for (var i=0;i<options.length;i++){
        var opt = options[i];
        var el = items[i];
        if (!el) continue;
        el.setAttribute('data-value', String(opt));
        el.setAttribute('data-idx', String(i));
        var num = el.querySelector('.tabular-nums');
        if (num) num.textContent = String(opt);
        el.classList.remove('selected');
        el.setAttribute('aria-selected','false');
      }

      var confirmButton = document.getElementById('confirmButton');
      if (confirmButton){ confirmButton.disabled = true; confirmButton.setAttribute('aria-disabled','true'); }

      startTime = Date.now();
      setupAnswerSelection();
      showCoach('×©××œ×” ' + (currentQuestionIndex + 1) + ' ××ª×•×š ' + totalQuestions + '. ×‘×”×¦×œ×—×”!');
    }

    function setupAnswerSelection(){
      var items = document.querySelectorAll('.answer-item');
      for (var i=0;i<items.length;i++){
        var item = items[i];
        item.setAttribute('tabindex','0');
        item.setAttribute('role','button');
        item.setAttribute('aria-selected','false');

        item.onpointerdown = (function(el){ return function(){ el.classList.add('pressed'); }; })(item);
        var clearPress = (function(el){ return function(){ el.classList.remove('pressed'); }; })(item);
        item.onpointerup = clearPress; item.onpointercancel = clearPress; item.onpointerleave = clearPress;

        item.onkeydown = (function(el){ return function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); el.click(); } }; })(item);
        item.onclick = (function(el){
          return function(){
            // ×¦×œ×™×œ ×‘×—×™×¨×” ×¢×“×™×Ÿ
            playSelectTick();

            for (var j=0;j<items.length;j++){ items[j].classList.remove('selected'); items[j].setAttribute('aria-selected','false'); }
            el.classList.add('selected');
            el.setAttribute('aria-selected','true');
            selectedAnswer = parseInt(el.getAttribute('data-value'), 10);
            var confirm = document.getElementById('confirmButton');
            if (confirm){ confirm.disabled = false; confirm.setAttribute('aria-disabled','false'); }
          };
        })(item);
      }
    }

    function confirmAnswer(){
      if (selectedAnswer === null) return;
      var correctAnswer = questions[currentQuestionIndex].answer;
      var endTime = Date.now(); totalTime += (endTime - startTime) / 1000;
      if (selectedAnswer === correctAnswer){ correctCount++; showFeedback(true); }
      else { mistakes.push({ question: questions[currentQuestionIndex], userAnswer: selectedAnswer, correctAnswer: correctAnswer }); showFeedback(false); }
    }

    function showFeedback(isCorrect){
      var feedback = document.getElementById('feedback');
      var icon = document.getElementById('feedbackIcon');
      var text = document.getElementById('feedbackText');

      if (isCorrect){
        if (icon) icon.textContent = 'ğŸ‰';
        if (text){ text.textContent = '×›×œ ×”×›×‘×•×“! ×ª×©×•×‘×” × ×›×•× ×”!'; text.className = 'text-2xl font-bold mb-6 text-green-600'; }
        playSuccessSound();
        showCoach('×™×¤×”! ×”××©×š ×‘××•×ª×• ×§×¦×‘.');
      } else {
        if (icon) icon.textContent = 'ğŸ’ª';
        if (text){ text.textContent = '×›××¢×˜! ×‘×¤×¢× ×”×‘××” ×ª×¦×œ×™×—!'; text.className = 'text-2xl font-bold mb-6 text-orange-600'; }
        playErrorSound();
        showCoach('×›××¢×˜! × × ×¡×” ×©×•×‘.');
      }

      if (feedback) feedback.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      var nb = document.getElementById('nextButton'); if (nb) nb.focus();
    }

    function nextQuestion(){
      var fb = document.getElementById('feedback'); if (fb) fb.classList.add('hidden');
      document.body.style.overflow = '';
      currentQuestionIndex++;
      if (currentQuestionIndex < totalQuestions){
        if (currentQuestionIndex === Math.floor(totalQuestions/2)){
          showCoach('×›×‘×¨ ×—×¦×™ ×“×¨×š â€“ ×›×œ ×”×›×‘×•×“!');
        }
        showQuestion();
        var c = document.getElementById('confirmButton'); if (c) c.focus();
      } else {
        var pb = document.getElementById('progressBar'); if (pb){ pb.style.width = '100%'; pb.setAttribute('aria-valuenow','100'); }
        showResults();
      }
    }

    function showResults(){
      var idsHide = ['gameScreen','mistakesScreen','tutorialScreen'];
      for (var i=0;i<idsHide.length;i++){ var n = document.getElementById(idsHide[i]); if(n) n.classList.add('hidden'); }
      var rs = document.getElementById('resultsScreen'); if (rs) rs.classList.remove('hidden');

      var incorrectCount = totalQuestions - correctCount;
      var percentage = Math.round((correctCount / totalQuestions) * 100);

      var msg = document.getElementById('performanceMessage');
      var icon = rs ? rs.querySelector('.text-8xl') : null;
      var title = document.getElementById('resultsTitle');

      if (correctCount === totalQuestions){
        if (msg){ msg.textContent = '××•×©×œ×! ×¢× ×™×ª × ×›×•×Ÿ ×¢×œ ×›×œ ×”×©××œ×•×ª! ğŸŒŸ'; msg.className = 'mb-4 font-medium text-lg text-green-600'; }
        if (icon) icon.textContent = 'ğŸ†';
        if (title){ title.innerHTML = '×›×œ ×”×›×‘×•×“ <span id="finalPlayerName">' + playerName + '</span>!'; title.className = 'text-3xl font-bold text-green-600 mb-4'; }
        var card = rs ? rs.querySelector('div.text-center.bg-white') || rs.querySelector(':scope > div') : null;
        if (card) confettiBurst(card);
        showCoach('××•×©×œ×! ×¤×ª×¨×ª ×”×›×œ × ×›×•×Ÿ ğŸ‰');
      } else if (percentage < 50){
        if (msg){ msg.textContent = '× ××©×™×š ×œ×ª×¨×’×œ ×›×“×™ ×œ×”×©×ª×¤×¨. ××ª×” ×™×›×•×œ!'; msg.className = 'mb-4 font-medium text-lg text-orange-600'; }
        if (icon) icon.textContent = 'ğŸ’ª';
        if (title){ title.textContent = '×™×•×¤×™ ' + playerName + ', × ××©×™×š ×œ×ª×¨×’×œ'; title.className = 'text-3xl font-bold text-orange-600 mb-4'; }
        showCoach('×™×•×¤×™ ' + playerName + ', × ××©×™×š ×œ×ª×¨×’×œ. × ×¢×‘×•×¨ ×™×—×“ ×¢×œ ×”×˜×¢×•×™×•×ª.');
      } else {
        if (msg){ msg.textContent = '×¢× ×™×ª × ×›×•×Ÿ ×¢×œ ' + correctCount + ' ××ª×•×š ' + totalQuestions + ' ×©××œ×•×ª - ×›×œ ×”×›×‘×•×“! ğŸ¯'; msg.className = 'mb-4 font-medium text-lg text-blue-600'; }
        if (icon) icon.textContent = 'ğŸ†';
        if (title){ title.innerHTML = '×›×œ ×”×›×‘×•×“ <span id="finalPlayerName">' + playerName + '</span>!'; title.className = 'text-3xl font-bold text-green-600 mb-4'; }
        showCoach('×‘×™×¦×•×¢ ×˜×•×‘! ×¨×•×¦×” ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×œ××•×“ ××”×˜×¢×•×™×•×ª?');
      }

      updatePerformanceBar(correctCount, incorrectCount, percentage);
      var ca = document.getElementById('correctAnswers'); if (ca) ca.textContent = String(correctCount);
      var at = document.getElementById('averageTime'); if (at) at.textContent = String(Math.max(1, Math.round(totalTime / totalQuestions)));
      var mb = document.getElementById('mistakesButton'); if (mb) mb.classList.toggle('hidden', mistakes.length === 0);
    }

    function updatePerformanceBar(correct, incorrect, percentage){
      var correctPercentage = (correct / totalQuestions) * 100;
      var incorrectPercentage = (incorrect / totalQuestions) * 100;
      var cb = document.getElementById('correctBar'); if (cb) cb.style.width = correctPercentage + '%';
      var ib = document.getElementById('incorrectBar'); if (ib) ib.style.width = incorrectPercentage + '%';
      var pp = document.getElementById('performancePercentage'); if (pp) pp.textContent = percentage + '%';
      var cc = document.getElementById('correctCount'); if (cc) cc.textContent = String(correct);
      var ic = document.getElementById('incorrectCount'); if (ic) ic.textContent = String(incorrect);
    }

    function showMistakes(){
      var rs = document.getElementById('resultsScreen'); if (rs) rs.classList.add('hidden');
      var ts = document.getElementById('tutorialScreen'); if (ts) ts.classList.add('hidden');
      var ms = document.getElementById('mistakesScreen'); if (ms) ms.classList.remove('hidden');

      var incorrectCount = totalQuestions - correctCount;
      var mcb = document.getElementById('mistakesCorrectBar'); if (mcb) mcb.style.width = ((correctCount / totalQuestions) * 100) + '%';
      var mib = document.getElementById('mistakesIncorrectBar'); if (mib) mib.style.width = ((incorrectCount / totalQuestions) * 100) + '%';

      var mm = document.getElementById('mistakesMessage');
      if (mistakes.length === 0){
        if (mm){ mm.textContent = '××•×©×œ×! ×¢× ×™×ª × ×›×•×Ÿ ×¢×œ ×›×œ ' + totalQuestions + ' ×”×©××œ×•×ª! ğŸŒŸ'; mm.className = 'text-lg text-green-600 font-medium mb-4'; }
      } else if (correctCount > 0){
        if (mm){ mm.textContent = '×¢× ×™×ª × ×›×•×Ÿ ×¢×œ ' + correctCount + ' ××ª×•×š ' + totalQuestions + ' - ×‘×•××• × ×œ××“ ××”-' + mistakes.length + ' ×©× ×©××¨×•'; mm.className = 'text-lg text-blue-600 font-medium mb-4'; }
      } else {
        if (mm){ mm.textContent = '×‘×•××• × ×œ××“ ×™×—×“ ××™×š ×œ×¤×ª×•×¨ ××ª ×”×©××œ×•×ª ×”××œ×”'; mm.className = 'text-lg text-orange-600 font-medium mb-4'; }
      }

      var list = document.getElementById('mistakesList');
      if (list) list.innerHTML = '';
      if (mistakes.length === 0){
        if (list) list.innerHTML = '<div class="text-center p-8"><div class="text-6xl mb-4">ğŸ‰</div><h3 class="text-2xl font-bold text-green-600">××¢×•×œ×”!</h3><p class="text-lg text-gray-600">×œ× ×”×™×• ×œ×š ×˜×¢×•×™×•×ª ×‘××©×—×§ ×”×–×”!</p></div>';
        return;
      }

      for (var i=0;i<questions.length;i++){
        var q = questions[i];
        var m = null;
        for (var j=0;j<mistakes.length;j++){ if (mistakes[j].question.questionText === q.questionText) { m = mistakes[j]; break; } }
        if (!m) continue;

        var div = document.createElement('div');
        div.className = 'bg-orange-50 border-2 border-orange-200 rounded-2xl p-6 cursor-pointer hover:bg-orange-100 transition-colors';
        div.onclick = (function(mk){ return function(){ showTutorial(mk); }; })(m);
        div.innerHTML =
          '<div class="flex items-center justify-between mb-4">' +
            '<div class="flex items-center gap-4">' +
              '<div class="w-4 h-4 bg-orange-500 rounded-full"></div>' +
              '<h3 class="text-xl font-bold text-orange-600">×©××œ×” ' + (i + 1) + '</h3>' +
            '</div>' +
            '<div class="text-2xl">ğŸ¤”</div>' +
          '</div>' +
          '<div class="text-2xl font-bold text-gray-800 mb-4 ltr">' + m.question.questionText + '</div>' +
          '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">' +
            '<div class="bg-red-100 border-2 border-red-300 rounded-xl p-4">' +
              '<div class="text-sm text-red-600 font-bold mb-1">×”×ª×©×•×‘×” ×©×œ×š:</div>' +
              '<div class="text-xl font-bold text-red-700 ltr">' + m.userAnswer + '</div>' +
            '</div>' +
            '<div class="bg-green-100 border-2 border-green-300 rounded-xl p-4">' +
              '<div class="text-sm text-green-600 font-bold mb-1">×”×ª×©×•×‘×” ×”× ×›×•× ×”:</div>' +
              '<div class="text-xl font-bold text-green-700 ltr">' + m.correctAnswer + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="text-center text-blue-600 font-bold">ğŸ‘† ×œ×—×¥ ×›××Ÿ ×›×“×™ ×œ×œ××•×“ ××™×š ×œ×¤×ª×•×¨</div>';
        if (list) list.appendChild(div);
      }
    }

    function showTutorial(mistake){
      currentTutorialMistake = mistake;
      var ms = document.getElementById('mistakesScreen'); if (ms) ms.classList.add('hidden');
      var ts = document.getElementById('tutorialScreen'); if (ts) ts.classList.remove('hidden');

      var q = mistake.question;
      var title = document.getElementById('tutorialTitle'); if (title) title.textContent = q.questionText;
      createTutorialSteps(q);
      createInteractiveDemo(q);
    }

    function createTutorialSteps(question){
      var c = document.getElementById('tutorialSteps');
      if (c) c.innerHTML = '';
      var steps = getTutorialSteps(question);
      for (var i=0;i<steps.length;i++){
        var s = steps[i];
        var d = document.createElement('div');
        d.className = 'bg-blue-50 border-2 border-blue-200 rounded-2xl p-6';
        d.innerHTML =
          '<div class="flex items-center mb-4 gap-4">' +
            '<div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">' + (i+1) + '</div>' +
            '<h3 class="text-xl font-bold text-blue-600">' + s.title + '</h3>' +
          '</div>' +
          '<p class="text-gray-700 text-lg">' + s.description + '</p>';
        if (c) c.appendChild(d);
      }
    }

    function getTutorialSteps(q){
      var operation = q.operation, num1 = q.num1, num2 = q.num2, answer = q.answer;
      if (operation === 'addition') return [
        { title:'×”×‘× ×ª ×”×©××œ×”', description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” ' + num1 + ' + ' + num2 + '.' },
        { title:'×”×¦×’×ª ×”×¤×¨×™×˜×™× ×”×¨××©×•× ×™×', description:'× ×ª×—×™×œ ×¢× ' + num1 + ' ×¤×¨×™×˜×™×.' },
        { title:'×”×•×¡×¤×ª ×¤×¨×™×˜×™×', description:'× ×•×¡×™×£ ' + num2 + ' ×•× ×× ×” ×”×›×•×œ ×™×—×“.' },
        { title:'×”×ª×•×¦××”', description:'×™×© ' + answer + ' ×¤×¨×™×˜×™×. ×–×• ×”×ª×©×•×‘×”!' }
      ];
      if (operation === 'subtraction') return [
        { title:'×”×‘× ×ª ×”×©××œ×”', description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” ' + num1 + ' - ' + num2 + '.' },
        { title:'×”×¦×’×ª ×”×¤×¨×™×˜×™× ×”×¨××©×•× ×™×', description:'× ×ª×—×™×œ ×¢× ' + num1 + ' ×¤×¨×™×˜×™×.' },
        { title:'×”×¡×¨×ª ×¤×¨×™×˜×™×', description:'× ×¡×™×¨ ' + num2 + ' ×•× ×× ×” ×›××” × ×©××¨.' },
        { title:'×”×ª×•×¦××”', description:'× ×©××¨×• ' + answer + ' ×¤×¨×™×˜×™×.' }
      ];
      if (operation === 'multiplication') return [
        { title:'×”×‘× ×ª ×”×©××œ×”', description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” ' + num1 + ' Ã— ' + num2 + '.' },
        { title:'×™×¦×™×¨×ª ×§×‘×•×¦×•×ª', description:'× ×™×¦×•×¨ ' + num1 + ' ×§×‘×•×¦×•×ª ×©×œ ' + num2 + '.' },
        { title:'×¡×¤×™×¨×”', description:'× ×¡×¤×•×¨ ××ª ×›×œ ×”×¤×¨×™×˜×™×.' },
        { title:'×”×ª×•×¦××”', description:'×™×© ' + answer + ' ×¤×¨×™×˜×™× ×‘×¡×š ×”×›×•×œ.' }
      ];
      if (operation === 'division'){
        var dividend = parseInt(q.questionText.split(' Ã· ')[0], 10);
        var divisor = q.num2;
        return [
          { title:'×”×‘× ×ª ×”×©××œ×”', description:'×× ×—× ×• ×¨×•×¦×™× ×œ×“×¢×ª ×›××” ×–×” ' + dividend + ' Ã· ' + divisor + '.' },
          { title:'×”×¦×’×ª ×›×œ ×”×¤×¨×™×˜×™×', description:'× ×ª×—×™×œ ×¢× ' + dividend + ' ×¤×¨×™×˜×™×.' },
          { title:'×—×œ×•×§×” ×œ×§×‘×•×¦×•×ª', description:'× ×—×œ×§ ×œ×§×‘×•×¦×•×ª ×©×œ ' + divisor + '.' },
          { title:'×”×ª×•×¦××”', description:'×§×™×‘×œ× ×• ' + answer + ' ×§×‘×•×¦×•×ª.' }
        ];
      }
      return [];
    }

    // Tutorial interactive demo (×××•×’'×™ ×¨×§ ×‘××¡×š ×”×”×“×¨×›×”)
    var tutorialEmojis = ['ğŸ','ğŸˆ','â­','ğŸŒŸ','ğŸŠ','ğŸ¯','ğŸŒˆ','ğŸª'];
    function createInteractiveDemo(q){
      var area = document.getElementById('interactiveContent');
      var info = document.getElementById('interactiveInstructions');
      if (area) area.innerHTML = '';
      var operation = q.operation, num1 = q.num1, num2 = q.num2, answer = q.answer;
      var emoji = tutorialEmojis[Math.floor(Math.random() * tutorialEmojis.length)];

      if (operation === 'addition'){
        var clicked = 0, total = answer;
        for (var i=0;i<total;i++){
          var s = document.createElement('span'); s.className='text-3xl m-1 opacity-50 cursor-pointer'; s.textContent = i < num1 ? 'ğŸ”µ' : 'ğŸŸ¡';
          s.onclick=(function(el){ return function(){ if (clicked < total && el.style.opacity !== '1'){ el.style.opacity='1'; clicked++; if (info) info.textContent = clicked===total ? ('××¢×•×œ×”! ×¡×¤×¨×ª ' + total + ' ×¤×¨×™×˜×™× - ×–×• ×”×ª×©×•×‘×”! ğŸ‰') : ('×”××©×š ×œ×¡×¤×•×¨... (' + clicked + '/' + total + ')'); } }; })(s);
          if (area) area.appendChild(s); if(((i+1)%5===0) && i<total-1) if (area) area.appendChild(document.createElement('br'));
        }
        if (info) info.textContent = '×œ×—×¥ ×¢×œ ×”×›×“×•×¨×™× ×›×“×™ ×œ×¡×¤×•×¨ ××ª ' + num1 + ' + ' + num2;
        return;
      }
      if (operation === 'subtraction'){
        var removed = 0;
        for (var i2=0;i2<num1;i2++){
          var s2 = document.createElement('span'); s2.className='text-3xl m-1 cursor-pointer'; s2.textContent = emoji;
          s2.onclick=(function(el){ return function(){ if (removed < num2 && el.style.opacity !== '0.3'){ el.style.opacity='0.3'; el.style.textDecoration='line-through'; removed++; if (info) info.textContent = removed===num2 ? ('××¢×•×œ×”! ×”×¡×¨×ª ' + num2 + ' ×¤×¨×™×˜×™×; × ×©××¨×• ' + answer + '. ğŸ‰') : ('×œ×—×¥ ×¢×œ ×¢×•×“ ' + (num2-removed)); } }; })(s2);
          if (area) area.appendChild(s2); if(((i2+1)%5===0) && i2<num1-1) if (area) area.appendChild(document.createElement('br'));
        }
        if (info) info.textContent = '×œ×—×¥ ×¢×œ ' + num2 + ' ×¤×¨×™×˜×™× ×›×“×™ ×œ×”×¡×™×¨ ××ª×•×š ' + num1;
        return;
      }
      if (operation === 'multiplication'){
        var shown = 0;
        for (var g=0; g<num1; g++){
          var group = document.createElement('div'); group.className='inline-block border-2 border-dashed border-blue-300 rounded-lg p-3 m-2 bg-blue-50'; group.style.opacity='0.5';
          var label = document.createElement('div'); label.className='text-sm font-bold text-blue-600 mb-2 text-center'; label.textContent='×§×‘×•×¦×” ' + (g+1); group.appendChild(label);
          for (var i3=0;i3<num2;i3++){ var sp=document.createElement('span'); sp.className='text-2xl m-1'; sp.textContent=emoji; group.appendChild(sp); }
          group.onclick=(function(el){ return function(){ if (el.style.opacity==='0.5'){ el.style.opacity='1'; shown++; if (info) info.textContent = (shown===num1) ? ('××¢×•×œ×”! ' + num1 + 'Ã—' + num2 + ' = ' + answer + '. ğŸ‰') : ('× ×”×“×¨! ×œ×—×¥ ×¢×œ ×¢×•×“ ' + (num1-shown) + ' ×§×‘×•×¦×•×ª'); } }; })(group);
          if (area) area.appendChild(group);
        }
        if (info) info.textContent = '×œ×—×¥ ×¢×œ ×”×§×‘×•×¦×•×ª ×›×“×™ ×œ×¨××•×ª ' + num1 + ' ×§×‘×•×¦×•×ª ×©×œ ' + num2;
        return;
      }
      if (operation === 'division'){
        var shown2 = 0; var dividend = parseInt(q.questionText.split(' Ã· ')[0], 10);
        for (var g2=0; g2<answer; g2++){
          var group2 = document.createElement('div'); group2.className='inline-block border-2 border-dashed border-purple-300 rounded-lg p-3 m-2 bg-purple-50'; group2.style.opacity='0.5';
          var label2 = document.createElement('div'); label2.className='text-sm font-bold text-purple-600 mb-2 text-center'; label2.textContent='×§×‘×•×¦×” ' + (g2+1); group2.appendChild(label2);
          for (var i4=0;i4<num2;i4++){ var sp2=document.createElement('span'); sp2.className='text-2xl m-1'; sp2.textContent=emoji; group2.appendChild(sp2); }
          group2.onclick=(function(el){ return function(){ if (el.style.opacity==='0.5'){ el.style.opacity='1'; shown2++; if (info) info.textContent = (shown2===answer) ? ('××¢×•×œ×”! ×—×™×œ×§×ª ' + dividend + ' ×œ-' + answer + ' ×§×‘×•×¦×•×ª ×©×œ ' + num2 + '. ğŸ‰') : ('× ×”×“×¨! ×œ×—×¥ ×¢×œ ×¢×•×“ ' + (answer-shown2) + ' ×§×‘×•×¦×•×ª'); } }; })(group2);
          if (area) area.appendChild(group2);
        }
        if (info) info.textContent = '×œ×—×¥ ×¢×œ ×”×§×‘×•×¦×•×ª ×›×“×™ ×œ×¨××•×ª ×—×œ×•×§×” ×œ-' + answer + ' ×§×‘×•×¦×•×ª ×©×œ ' + num2;
      }
    }

    function startOver(){
      currentOperation='addition'; currentDifficulty='easy'; currentQuestionIndex=0;
      correctCount=0; questions=[]; mistakes=[]; startTime=0; totalTime=0; selectedAnswer=null; currentTutorialMistake=null;
      var ids = ['gameScreen','resultsScreen','mistakesScreen','tutorialScreen','difficultyScreen','nameScreen','welcomeScreen'];
      for (var i=0;i<ids.length;i++){ var el=document.getElementById(ids[i]); if (el) el.classList.add('hidden'); }
      var op = document.getElementById('operationScreen'); if (op) op.classList.remove('hidden');
      applyCurriculumToOperationButtons();
      showCoach('×‘×—×¨ ×ª×¨×’×™×œ ×—×“×© ××• ×©× ×” ×ª×•×›× ×™×ª ×œ×™××•×“.');
    }

    // ===== Utilities =====
    function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
    function shuffleArray(arr){ var a=arr.slice(); for(var i=a.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t; } return a; }
    function generateAnswerOptions(correct){
      var opts = [correct];
      while (opts.length < 4){
        var wrong = correct + Math.floor(Math.random()*7) - 3; // Â±3
        if (wrong > 0 && wrong !== correct && opts.indexOf(wrong) === -1) opts.push(wrong);
      }
      return shuffleArray(opts);
    }

    // ===== Audio helpers =====
    var audioCtx = null;
    function getAudioCtx(){
      try{
        if (!audioCtx){
          var AC = window.AudioContext || window.webkitAudioContext;
          if (!AC) return null;
          audioCtx = new AC();
        }
        if (audioCtx.state === 'suspended' && audioCtx.resume) audioCtx.resume();
        return audioCtx;
      } catch (e) { return null; }
    }
    // ×™×™×–×•× ××•×“×™×• ×‘××—×•×•×” ×”×¨××©×•× ×” (××•×‘×™×™×œ)
    function primeAudioOnce(){
      var ctx = getAudioCtx(); if (!ctx) return;
      document.removeEventListener('pointerdown', primeAudioOnce);
      document.removeEventListener('touchstart', primeAudioOnce);
    }
    document.addEventListener('pointerdown', primeAudioOnce, { passive: true });
    document.addEventListener('touchstart', primeAudioOnce, { passive: true });

    function tone(freq, dur, t, type, gain){
      if (typeof type === 'undefined') type = 'sine';
      if (typeof gain === 'undefined') gain = 0.15;
      var ctx = getAudioCtx(); if (!ctx) return;
      var start = (typeof t === 'number') ? t : ctx.currentTime;
      var osc = ctx.createOscillator(); var g = ctx.createGain();
      osc.type = type; osc.frequency.setValueAtTime(freq, start);
      g.gain.setValueAtTime(gain, start); g.gain.exponentialRampToValueAtTime(0.001, start + dur);
      osc.connect(g); g.connect(ctx.destination); osc.start(start); osc.stop(start + dur);
    }
    function playSelectTick(){
      var ctx = getAudioCtx(); if (!ctx) return; var t = ctx.currentTime;
      tone(440, 0.06, t, 'triangle', 0.08);
    }
    function playSuccessSound(){
      var ctx = getAudioCtx(); if (!ctx) return; var t = ctx.currentTime;
      tone(523.25, 0.12, t,      'sine', 0.18); // C5
      tone(659.25, 0.12, t+0.10, 'sine', 0.16); // E5
      tone(783.99, 0.14, t+0.20, 'sine', 0.14); // G5
    }
    function playErrorSound(){
      var ctx = getAudioCtx(); if (!ctx) return; var t = ctx.currentTime;
      tone(220, 0.10, t,      'sawtooth', 0.10);
      tone(180, 0.12, t+0.10, 'sawtooth', 0.09);
    }

    // ===== Confetti (results only, 100% correct) =====
    function confettiBurst(container){
      try{
        if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      } catch(e){}
      var n = 28;
      for (var i=0;i<n;i++){
        var dot = document.createElement('span');
        dot.style.position='absolute'; dot.style.width='8px'; dot.style.height='8px'; dot.style.borderRadius='50%';
        dot.style.left='50%'; dot.style.top='10%';
        var colors = ['#22c55e','#3b82f6','#f59e0b','#ef4444','#a855f7'];
        dot.style.background=colors[i%colors.length];
        var angle=(i/n)*Math.PI*2, dist=80+Math.random()*50, tx=Math.cos(angle)*dist, ty=Math.sin(angle)*dist;
        var anim = dot.animate(
          [{ transform:'translate(-50%,-50%) scale(1)', opacity:1 },
           { transform:'translate('+(tx-50)+'%,'+(ty-50)+'%) scale(0.9)', opacity:0 }],
          { duration: 900, easing:'cubic-bezier(.2,.8,.2,1)' }
        );
        anim.onfinish=function(){ if (dot && dot.parentNode) dot.parentNode.removeChild(dot); };
        container.appendChild(dot);
      }
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', function (){
      var startBtn = document.querySelector('#welcomeScreen button');
      if (startBtn){ startBtn.addEventListener('click', function(e){ e.preventDefault(); showNameInput(); }); }

      var form = document.getElementById('nameForm');
      if (form){
        form.addEventListener('submit', function(e){
          e.preventDefault();
          showOperationSelect();
        });
      }
      var input = document.getElementById('playerName');
      if (input){
        input.addEventListener('keydown', function(e){
          if (e.key === 'Enter'){ e.preventDefault(); showOperationSelect(); }
        });
      }
      var curriculumSel = document.getElementById('curriculumSelect');
      if (curriculumSel){
        curriculumSel.addEventListener('change', function(e){
          currentCurriculum = e.target.value;
          applyCurriculumToOperationButtons();
        });
      }
      var qSel = document.getElementById('questionCountSelect');
      if (qSel){
        qSel.addEventListener('change', function(e){
          questionCount = parseInt(e.target.value, 10) || 6;
        });
      }

      // Coach
      bindCoach();
      showCoach('×‘×¨×•×š ×”×‘×! ×‘×—×¨ ×ª×©×•×‘×” ×•××– ××©×¨.');
    });
  </script>
</body>
</html>
